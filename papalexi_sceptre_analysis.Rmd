---
title: "Papalexi Analysis SCEPTRE"
output: pdf_document
date: "2023-02-16"
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(httr) 
library(rlist)
library(jsonlite)
library(varhandle)
library(stringi)
library(kableExtra)
```

# Getting Results From SCEPTRE Analysis

```{r}
#using absolute paths to download results since files exist on github
code_dir = .get_config_path("LOCAL_CODE_DIR")
data.dir = paste0(code_dir,"/sceptre2-manuscript/writeups/papalexi_analysis/")
gene_path = paste0(data.dir,
                   'sceptre_CUL3_and_PDL1_mrna_results_with_effect_size.rds')
protein_path = paste0(data.dir,'sceptre_protein_results_with_effect_size.rds')
seurat_path = paste0(data.dir,'papalexi_results_seurat.rds')
#Note that sceptre results have columns pvalue, grna, target
#get sceptre perturbation on PDL1 mrna results
gene_result = readRDS(gene_path)
gene_result$log_fold_change = signif(gene_result$log_fold_change, digits=2)
#get sceptre perturbation on protein results
protein_result = readRDS(protein_path)
protein_result$log_fold_change = signif(protein_result$log_fold_change,digits=2)
#get seurat DE results. Columns 1,2,and 6 correspond to pvalue, effect size
#and perturbation 
seurat_result = readRDS(seurat_path)
#change seurat to numeric 
seurat_result$p_val = as.numeric(seurat_result$p_val)
seurat_result$avg_log2FC = as.numeric(seurat_result$avg_log2FC)
#round 
seurat_result$p_val = signif(seurat_result$p_val, digits=2)
seurat_result$avg_log2FC = signif(seurat_result$avg_log2FC, digits=2)
```
# Adjusting Pvalues

```{r}
#See which gene perturbations are associated with PDL1 protein expression

#get pvalues from sceptre
P_adj = protein_result$p_value
#unlist pvalues
P_adj = unlist(P_adj)
#some pvalues are negative so take absolute value
P_adj = abs(P_adj)
#make numeric 
P_adj = as.numeric(P_adj)
#perform BH procedure
P_adj = p.adjust(P_adj,method = 'BH')

#replace results matrix pvalues with adjusted pvalues
protein_adjusted = data.frame(adj.Pval = P_adj,
                              log_fold_change = protein_result$log_fold_change,
                              response_id = protein_result$response_id,
                              grna_group = protein_result$grna_group)
```
# Papalexi et al Comparison

Papalexi notes that there have been numerous studies showing that exposure to IFN-gamma induces PDL1 expression. Core components of the the IFN-gamma response include IRF1,JAK,STAT, and the IFN-gamma receptors themselves.We can think of these as positive controls that when knocked out, result in underexpression of PDL1.

## PDL1 Protein Results

The authors state that they found 8 perturbations to be significantly associated with PDL1 protein expression. These 8 perturbations are BRD4,MYC,CUL3,IRF1,STAT1,IFNGR1,IFNGR2,and JAK2. The last 5 are positive controls identified in the paper.

```{r}
#filter to just look at PDL1 pvalues
protein_PDL1 = protein_adjusted[which(protein_adjusted$response_id == 'PDL1'),]
#get significant perturbations
sig_genes = subset(protein_PDL1,adj.Pval < 0.05)$grna_group
#unfactor
sig_genes = unfactor(sig_genes)
A = 'Significant perturbations for the expression of PDL1 protein are:\n '
cat(paste0(A,paste(sig_genes,collapse = ',')))
```

In addition to the 8 perturbations that papalexi et al found significant, SCEPTRE finds 4 more (CMTM6,CD86,PDCD1LG2,STAT3).

```{r}
#get sceptre results on PDL1 protein
protein_PDL1_raw = subset(protein_result,response_id == "PDL1")
protein_PDL1_raw = subset(protein_PDL1_raw,select = c(grna_group,p_value,
                                                      log_fold_change))
#get seurat results on PDL1 protein. Columns 1,2, and 6 are pvalue,effect size
#and perturbation
seurat_PDL1_raw = subset(seurat_result,Target == "PDL1")
seurat_PDL1_raw = subset(seurat_PDL1_raw,select = c(p_val,avg_log2FC,PRTB))
#remove perturbations that aren't in both analyses
for(target in protein_PDL1_raw$grna_group){
  if (target %in% seurat_PDL1_raw$PRTB == F){
    seurat_PDL1_raw = rbind(seurat_PDL1_raw,c(NA,NA,target))
  }
}
protein_PDL1_raw = subset(protein_PDL1_raw,grna_group %in% seurat_PDL1_raw$PRTB)
#reorder rows of sceptre analysis
protein_PDL1_raw = protein_PDL1_raw[match(seurat_PDL1_raw$PRTB,
                                          protein_PDL1_raw$grna_group),]
protein_PDL1_raw$grna_group = unfactor(protein_PDL1_raw$grna_group)
#bind them 
combined_results_PDL1 = data.frame(protein_PDL1_raw$p_value,
                                   protein_PDL1_raw$log_fold_change,
                                   seurat_PDL1_raw$p_val,
                                   seurat_PDL1_raw$avg_log2FC,
                                   protein_PDL1_raw$grna_group)
colnames(combined_results_PDL1) = c("SCEPTRE Pvalues","SCEPTRE Log Change",
                                    "Seurat Pvalues",
                                    'Seurat Log Change',
                                    "Perturbation")
#reorder columns
combined_results_PDL1 = combined_results_PDL1 [,c(1,3,2,4,5)]
#order by pvalue
combined_results_PDL1 = combined_results_PDL1[
  order(combined_results_PDL1$`SCEPTRE Pvalues`),]


results_table = kable(combined_results_PDL1,booktabs = TRUE, linesep = "",
                      caption = "SCEPTRE vs SEURAT PDL1 Protein Results")
kable_styling(results_table,position = "center", latex_options = "scale_down")
#View(combined_results_PDL1)
```

## Other Protein Results
The authors state that "Importantly, perturbation of these eight genes did not result in appreciable shifts in CD86 or PD-L2 protein expression,suggesting that these regulatory effects are specific to PD-L1'. I will now check to see if this is true when using SCEPTRE.

\newpage

## CD86
It seems as though these regulatory effects are not specific to PDL1. This is also true when using seurat. The positive controls for PDL1 (IRF1,IFNGR1,etc...) also seem to regulate expression of CD86.

```{r}
#get sceptre results on CD86 protein
protein_CD86_raw = subset(protein_result,response_id == "CD86")
protein_CD86_raw = subset(protein_CD86_raw,select = c(grna_group,p_value,
                                                      log_fold_change))
#get seurat results on CD86 protein. Columns 1,2, and 6 are pvalue,effect size
#and perturbation
seurat_CD86_raw = subset(seurat_result,Target == "CD86")
seurat_CD86_raw = subset(seurat_CD86_raw,select = c(p_val,avg_log2FC,PRTB))
#remove perturbations that aren't in both analyses
for(target in protein_CD86_raw$grna_group){
  if (target %in% seurat_CD86_raw$PRTB == F){
    seurat_CD86_raw = rbind(seurat_CD86_raw,c(NA,NA,target))
  }
}
protein_CD86_raw = subset(protein_CD86_raw,grna_group %in% seurat_CD86_raw$PRTB)
#reorder rows of sceptre analysis
protein_CD86_raw = protein_CD86_raw[match(seurat_CD86_raw$PRTB,
                                          protein_CD86_raw$grna_group),]
protein_CD86_raw$grna_group = unfactor(protein_CD86_raw$grna_group)
#bind them 
combined_results_CD86 = data.frame(protein_CD86_raw$p_value,
                                   protein_CD86_raw$log_fold_change,
                                   seurat_CD86_raw$p_val,
                                   seurat_CD86_raw$avg_log2FC,
                              protein_CD86_raw$grna_group)
colnames(combined_results_CD86) = c("SCEPTRE Pvalues","SCEPTRE Log Change",
                                    "Seurat Pvalues",
                                    'Seurat Log Change',
                                    "Perturbation")
#reorder columns
combined_results_CD86 = combined_results_CD86 [,c(1,3,2,4,5)]
#order by pvalue
combined_results_CD86 = combined_results_CD86[
  order(combined_results_CD86$`SCEPTRE Pvalues`),]


results_table = kable(combined_results_CD86,booktabs = TRUE, linesep = "",
                      caption = "SCEPTRE vs SEURAT CD86 Protein Results")
kable_styling(results_table,position = "center", latex_options = "scale_down")
#View(combined_results_CD86)
```
\newpage

## PDL2
For PDL2, the results are more or less in line with what paplexi reports. IRF1 seems to be the only gene that regulates PDL1 that also regulates PDL2.
```{r}
#get sceptre results on PDL2 protein
protein_PDL2_raw = subset(protein_result,response_id == "PDL2")
protein_PDL2_raw = subset(protein_PDL2_raw,select = c(grna_group,p_value,
                                                      log_fold_change))
#get seurat results on PDL2 protein. Columns 1,2, and 6 are pvalue,effect size
#and perturbation
seurat_PDL2_raw = subset(seurat_result,Target == "PDL2")
seurat_PDL2_raw = subset(seurat_PDL2_raw,select = c(p_val,avg_log2FC,PRTB))
#remove perturbations that aren't in both analyses
for(target in protein_PDL2_raw$grna_group){
  if (target %in% seurat_PDL2_raw$PRTB == F){
    seurat_PDL2_raw = rbind(seurat_PDL2_raw,c(NA,NA,target))
  }
}
protein_PDL2_raw = subset(protein_PDL2_raw,grna_group %in% seurat_PDL2_raw$PRTB)
#reorder rows of sceptre analysis
protein_PDL2_raw = protein_PDL2_raw[match(seurat_PDL2_raw$PRTB,
                                          protein_PDL2_raw$grna_group),]
protein_PDL2_raw$grna_group = unfactor(protein_PDL2_raw$grna_group)
#bind them 
combined_results_PDL2 = data.frame(protein_PDL2_raw$p_value,
                                   protein_PDL2_raw$log_fold_change,
                                   seurat_PDL2_raw$p_val,
                                   seurat_PDL2_raw$avg_log2FC,
                              protein_PDL2_raw$grna_group)
colnames(combined_results_PDL2) = c("SCEPTRE Pvalues","SCEPTRE Log Change",
                                    "Seurat Pvalues",
                                    'Seurat Log Change',
                                    "Perturbation")
#reorder columns
combined_results_PDL2 = combined_results_PDL2 [,c(1,3,2,4,5)]
#order by pvalue
combined_results_PDL2 = combined_results_PDL2[
  order(combined_results_PDL2$`SCEPTRE Pvalues`),]


results_table = kable(combined_results_PDL2,booktabs = TRUE, linesep = "",
                      caption = "SCEPTRE vs SEURAT PDL2 Protein Results")
kable_styling(results_table,position = "center", latex_options = "scale_down")
#View(combined_results_PDL2)
```
\newpage

# mRNA Results

I will now analyze whether or not the perturbations affect PDL1 mRNA expression. I will compare results on the normalized and un-normalized assays when using seurat.

## Raw Data (Not Normalized)
We see that the positive controls indeed correspond to the strongest signals in the data. Interestingly, BRD4 perturbation does not affect gene expression of PDL1 while CUL3 does, consistent with the paper. 
```{r}
#get sceptre results on PDL1 protein
gene_PDL1_raw = subset(gene_result,response_id == "CD274")
gene_PDL1_raw = subset(gene_PDL1_raw,select = c(grna_group,p_value,
                                                      log_fold_change))
#get seurat results on PDL1 gene. Columns 1,2, and 6 are pvalue,effect size
#and perturbation
seurat_PDL1_raw = subset(seurat_result,Target == "PDL1_raw")
seurat_PDL1_raw = subset(seurat_PDL1_raw,select = c(p_val,avg_log2FC,PRTB))
#remove perturbations that aren't in both analyses
for(target in gene_PDL1_raw$grna_group){
  if (target %in% seurat_PDL1_raw$PRTB == F){
    seurat_PDL1_raw = rbind(seurat_PDL1_raw,c(NA,NA,target))
  }
}
gene_PDL1_raw = subset(gene_PDL1_raw,grna_group %in% seurat_PDL1_raw$PRTB)
#reorder rows of sceptre analysis
gene_PDL1_raw = gene_PDL1_raw[match(seurat_PDL1_raw$PRTB,
                                          gene_PDL1_raw$grna_group),]
gene_PDL1_raw$grna_group = unfactor(gene_PDL1_raw$grna_group)
#bind them 
combined_results_PDL1 = data.frame(gene_PDL1_raw$p_value,
                                   gene_PDL1_raw$log_fold_change,
                                   seurat_PDL1_raw$p_val,
                                   seurat_PDL1_raw$avg_log2FC,
                              gene_PDL1_raw$grna_group)
colnames(combined_results_PDL1) = c("SCEPTRE Pvalues","SCEPTRE Log Change",
                                    "Seurat Pvalues",
                                    'Seurat Log Change',
                                    "Perturbation")
#reorder columns
combined_results_PDL1 = combined_results_PDL1 [,c(1,3,2,4,5)]
#order by pvalue
combined_results_PDL1 = combined_results_PDL1[
  order(combined_results_PDL1$`SCEPTRE Pvalues`),]


results_table = kable(combined_results_PDL1,booktabs = TRUE, linesep = "",
                    caption = "SCEPTRE vs SEURAT PDL1 mRNA Results (Raw Data)")
kable_styling(results_table,position = "center", latex_options = "scale_down")
#View(combined_results_PDL1)
```

\newpage

## Normalized Data
```{r}
#get sceptre results on PDL1 protein
gene_PDL1_norm = subset(gene_result,response_id == "CD274")
gene_PDL1_norm = subset(gene_PDL1_norm,select = c(grna_group,p_value,
                                                      log_fold_change))
#get seurat results on PDL1 gene. Columns 1,2, and 6 are pvalue,effect size
#and perturbation
seurat_PDL1_norm = subset(seurat_result,Target == "PDL1_norm")
seurat_PDL1_norm = subset(seurat_PDL1_norm,select = c(p_val,avg_log2FC,PRTB))
#remove perturbations that aren't in both analyses
for(target in gene_PDL1_norm$grna_group){
  if (target %in% seurat_PDL1_norm$PRTB == F){
    seurat_PDL1_norm = rbind(seurat_PDL1_norm,c(NA,NA,target))
  }
}
gene_PDL1_norm = subset(gene_PDL1_norm,grna_group %in% seurat_PDL1_norm$PRTB)
#reorder rows of sceptre analysis
gene_PDL1_norm = gene_PDL1_norm[match(seurat_PDL1_norm$PRTB,
                                          gene_PDL1_norm$grna_group),]
gene_PDL1_norm$grna_group = unfactor(gene_PDL1_norm$grna_group)
#bind them 
combined_results_PDL1 = data.frame(gene_PDL1_norm$p_value,
                                   gene_PDL1_norm$log_fold_change,
                                   seurat_PDL1_norm$p_val,
                                   seurat_PDL1_norm$avg_log2FC,
                              gene_PDL1_norm$grna_group)
colnames(combined_results_PDL1) = c("SCEPTRE Pvalues","SCEPTRE Log Change",
                                    "Seurat Pvalues",
                                    'Seurat Log Change',
                                    "Perturbation")
#reorder columns
combined_results_PDL1 = combined_results_PDL1 [,c(1,3,2,4,5)]
#order by pvalue
combined_results_PDL1 = combined_results_PDL1[
  order(combined_results_PDL1$`SCEPTRE Pvalues`),]


results_table = kable(combined_results_PDL1,booktabs = TRUE, linesep = "",
            caption = "SCEPTRE vs SEURAT PDL1 mRNA Results (Normalized Data)")
kable_styling(results_table,position = "center", latex_options = "scale_down")
#View(combined_results_PDL1)
```

If we use the normalized data, we see that while the positive controls are still the strongest signal in the data, the direction of over/under expression is now flipped. From this I have two possible conclusions. Therefore I reasonably certain that they used the un-normalized data to perform all DE analyses. This is because if they used the normalized data, all their results would contradict the known controls. it is possible that their implementation of neighborhood adjustment is wrong in the sense that they are subtracting in the wrong direction (a-b instead of b-a). However, even if this is the case, the pvalues are much larger which casts doubt to if they would still be significant after pvalue adjustment.\
If they did not use the normalized data, this begs the question as to if their results are driven by technical factors rather than true biological signal.



