library(ondisc)
library(lowmoi)
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
pairs_to_analyze <- sceptre_schraivogel_res |>
dplyr::filter(p_value < 0.001) |>
dplyr::sample_n(5000) |>
dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "nb_discovery_5000.rds")
if (!file.exists(fp)) {
nb_res <- nb_regression_w_covariates(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(nb_res, fp)
} else {
nb_res <- readRDS(fp)
}
head(nb_res)
hsit(nb_res$p_value)
hist(nb_res$p_value)
fp <- paste0(schraivogel_chr8_result_dir, "seurat_discovery_5000.rds")
if (!file.exists(fp)) {
seurat_res <- seurat_de(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(seurat_res, fp)
} else {
seurat_res <- readRDS(fp)
}
hist(seurat_res$p_value)
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
if (!file.exists(fp)) {
schraivogel_res <- schraivogel_method(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(schraivogel_res, fp)
} else {
schraivogel_res <- readRDS(fp)
}
schraivogel_res
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
file.exists(fp)
paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
knitr::opts_chunk$set(echo = TRUE)
# Schraivogel method
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
schraivogel_res
# Schraivogel method
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
file.exists(fp)
schraivogel_res <- readRDS(fp)
head(schraivogel_res)
schraivogel_res$p_value |> hist()
hist(seurat_res$p_value)
hsit(nb_res$p_value)
hist(nb_res$p_value)
fp <-  paste0(schraivogel_chr8_result_dir, "sceptre_exact_discovery_5000.rds")
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_discovery_5000.rds")
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_discovery_5000.rds")
fp
sceptre_exact_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
nb_res
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_discovery_5000.rds")
pairs_to_analyze
sceptre_exact_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_res, fp)
head(sceptre_exact_res)
tail(sceptre_exact_res)
hist(sceptre_exact_res)
hist(sceptre_exact_res$p_value)
saveRDS(sceptre_exact_res, fp)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_discovery_5000.rds")
sceptre_approximate_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "full",
print_progress = FALSE)
saveRDS(sceptre_approximate_res, fp)
head(sceptre_approximate_res)
tail(sceptre_approximate_res)
hist(sceptre_approximate_res$p_value)
head(sceptre_approximate_res)
head(sceptre_approximate_res)
hist(sceptre_approximate_res)
hist(sceptre_approximate_res$p_value)
hist(sceptre_exact_res$p_value)
plot(sceptre_exact_res$p_value, sceptre_approximate_res$p_value)
cor(sceptre_exact_res$p_value, sceptre_approximate_res$p_value)
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
head(gk_sceptre_schraivogel_res)
tail(gk_sceptre_schraivogel_res)
head(gk_sceptre_schraivogel_res)
head(gk_sceptre_schraivogel_res)
head(?sceptre_approximate_res)
head(sceptre_approximate_res)
response_odm@misc
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
response_odm@misc
sceptre_approximate_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "full",
print_progress = FALSE)
head(sceptre_approximate_res)
tail(sceptre_approximate_res)
hist(sceptre_approximate_res$p_value)
response_odm@misc$sceptre_formula
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
sceptre_exact_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_res, fp)
} else {
sceptre_exact_res <- readRDS(fp)
}
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
sceptre_exact_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
head(sceptre_exact_res)
tail(sceptre_exact_res)
hist(sceptre_exact_res$p_value)
head(seurat_res$p_value)
hist(seurat_res$p_value)
