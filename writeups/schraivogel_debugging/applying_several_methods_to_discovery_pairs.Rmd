---
title: "Evaluating several methods on the Schraivogel discovery pairs"
author: "Tim"
date: "2023-04-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

I compare several methods on the Schraivogel discovery pairs: SCEPTRE, Schraivogel method, Seurat DE, and NB regression. I analyze 5,000 pairs randomly sampled from the set of pairs for which SCEPTRE produces a small p-value (p < 0.001).


First, I load the data and the low MOI package, which contains implementations of the methods.

```{r}
# load packages
library(ondisc)
library(lowmoi)

# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
                               "data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)

# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
```

Next, I load the SCEPTRE results on the Schraivogel chromosome 8 discovery pairs.

```{r}
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
```

Many of the p-values are small. In fact, about 50\% of the p-values are less than 0.001, which seems a bit strange. Let us randomly sample 5,000 of the pairs for which SCEPTRE produces a p-value below 0.001.

```{r}
pairs_to_analyze <- sceptre_schraivogel_res |>
   dplyr::filter(p_value < 0.001) |>
   dplyr::sample_n(5000) |>
   dplyr::select(response_id, grna_group)
```

I subject these pairs to NB regression, Seurat DE, and the Schraivogel method. I also reanalyze the pairs using SCEPTRE-exact and SCEPTRE-approximate.

```{r}
# NB regression
fp <- paste0(schraivogel_chr8_result_dir, "nb_discovery_5000.rds")
if (!file.exists(fp)) {
nb_res <- nb_regression_w_covariates(response_odm = response_odm,
                                     grna_odm = grna_odm,
                                     response_grna_group_pairs = pairs_to_analyze)
saveRDS(nb_res, fp)
} else {
  nb_res <- readRDS(fp)
}
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
```


```{r}
# Seurat DE
fp <- paste0(schraivogel_chr8_result_dir, "seurat_discovery_5000.rds")
if (!file.exists(fp)) {
  seurat_res <- seurat_de(response_odm = response_odm,
                          grna_odm = grna_odm,
                          response_grna_group_pairs = pairs_to_analyze)
  saveRDS(seurat_res, fp)
} else {
  seurat_res <- readRDS(fp)
}
```


```{r}
# Schraivogel method
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
if (!file.exists(fp)) {
  schraivogel_res <- schraivogel_method(response_odm = response_odm,
                                      grna_odm = grna_odm,
                                      response_grna_group_pairs = pairs_to_analyze)
  saveRDS(schraivogel_res, fp)
} else {
  schraivogel_res <- readRDS(fp)
}
```


```{r}
# sceptre exact
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_discovery_5000.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
  sceptre_exact_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = pairs_to_analyze,
                       with_covariates = TRUE,
                       test_stat = "exact_full",
                       print_progress = FALSE)
  saveRDS(sceptre_exact_res, fp)
} else {
  sceptre_exact_res <- readRDS(fp)
}
```


```{r}
# sceptre approximate
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_discovery_5000.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
  sceptre_approximate_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = pairs_to_analyze,
                       with_covariates = TRUE,
                       test_stat = "full",
                       print_progress = FALSE)
  saveRDS(sceptre_approximate_res, fp)
} else {
  sceptre_approximate_res <- readRDS(fp)
}
```


trying to reproduce Gene's result

```{r}
gk_sceptre_schraivogel_res
sceptre_approximate_res

```
