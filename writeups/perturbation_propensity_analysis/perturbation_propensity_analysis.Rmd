---
title: "Perturbation propensity as a function of covariates"
author: "Gene"
date: '2022-06-28'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(katlabutils)
```

In this script we assess whether perturbation indicators are associated with any of the technical covariates. We do this via both joint and marginal analyses. In the joint analysis, we run a logistic regression of the perturbation indicators on all technical covariates. We extract $p$-values for each individual covariate, as well as the $p$-value for the chi-squared test for the group of all covariates. In the marginal analysis, we run logistic regressions of the perturbation indicators on the technical covariates one by one. All analyses are done on the set of cells receiving a non-targeting gRNA, to match the set of cells used in our undercover analysis. 

# Results

```{r, echo = FALSE}
results_file <- paste0(
  .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"),
  "results/perturbation_propensity_analysis/results.rds"
)
results <- readRDS(results_file)
```

```{r, echo = FALSE}
datasets <- results |>
  arrange(paper) |>
  pull(dataset) |>
  unique()
for (dataset in datasets) {
  results_dataset <- results |> filter(dataset == !!dataset)
  paper <- results_dataset |>
    pull(paper) |>
    unique()
  p_hist_joint <- results_dataset |>
    filter(test_type == "joint") |>
    ggplot(aes(x = pvalue)) +
    geom_histogram(colour = "black", binwidth = 0.1, boundary = 0) +
    facet_wrap(~covariate, scales = "free") +
    scale_x_continuous(limits = c(0, 1)) +
    labs(title = sprintf("%s %s (joint analysis)", paper, dataset)) +
    theme_bw()
  plot(p_hist_joint)

  p_qq_joint <- results_dataset |>
    filter(test_type == "joint") |>
    ggplot(aes(y = pvalue)) +
    stat_qq_points() +
    stat_qq_band() +
    geom_abline() +
    facet_wrap(~covariate, scales = "free") +
    scale_x_continuous(trans = revlog_trans(base = 10)) +
    scale_y_continuous(trans = revlog_trans(base = 10)) +
    labs(title = sprintf("%s %s (joint analysis)", paper, dataset)) +
    theme_bw()
  plot(p_qq_joint)

  p_hist_marginal <- results_dataset |>
    filter(test_type == "marginal") |>
    ggplot(aes(x = pvalue)) +
    geom_histogram(colour = "black", binwidth = 0.1, boundary = 0) +
    facet_wrap(~covariate, scales = "free") +
    scale_x_continuous(limits = c(0, 1)) +
    labs(title = sprintf("%s %s (marginal analysis)", paper, dataset)) +
    theme_bw()
  plot(p_hist_marginal)

  p_qq_marginal <- results_dataset |>
    filter(test_type == "marginal") |>
    ggplot(aes(y = pvalue)) +
    stat_qq_points() +
    stat_qq_band() +
    geom_abline() +
    facet_wrap(~covariate, scales = "free") +
    scale_x_continuous(trans = revlog_trans(base = 10)) +
    scale_y_continuous(trans = revlog_trans(base = 10)) +
    labs(title = sprintf("%s %s (marginal analysis)", paper, dataset)) +
    theme_bw()
  plot(p_qq_marginal)
}
```

# Discussion

Most of the technical covariates appear to have no effect on the propensity of perturbation, with the exception of `bio_rep` and `lane` for the Papalexi data and `batch` for the Schraivogel enhancer screen datasets. Let's take a closer look at these.

## Biological replicate in the Papalexi dataset

Let's cross-tabulate biological replicate with NTC in the Papalexi data:
```{r}
df <- lowmoi::get_data_for_pert_prop("papalexi", "eccite_screen") |>
  dplyr::mutate(assigned_grna = factor(assigned_grna, levels = paste0("NTg", c(1:5,7:10))))
  
df |> 
  dplyr::select(assigned_grna, bio_rep) |> table()
```
It does look like different NTCs are overrepresented in different biological replicates (e.g. `NTg3` is overrepresented in `rep_3` while `NTg4` is overrepresented in `rep_1`). Let's verify this using a chi-squared test of independence:
```{r}
chisq.test(df$assigned_grna, df$bio_rep)
```
So there is indeed a very significant association between biological replicate and assigned gRNA.

## Lane in the Papalexi dataset

Let's cross-tabulate lane with NTC in the Papalexi data:
```{r}
df |> 
  dplyr::select(assigned_grna, lane) |> table()
```
One thing that sticks out is that `NTg8` is found in way fewer cells than the other NTCs. Let's look more into this:
```{r}
df |> dplyr::count(assigned_grna)
```
Indeed, `NTg8` is found in only 56 cells, while the other NTCs are usually found in hundreds of cells. Looking at these counts, `NTg2` looks a little low as well. Let's return to the question of association between lane and assigned gRNA. We conduct a chi-squared test:
```{r}
chisq.test(df$assigned_grna, df$lane)
```
We see that the $p$-value is quite significant. Let's exclude the two NTCs with small number of cells to see whether the effect persists:
```{r}
df_smaller <- df |> dplyr::filter(!(assigned_grna %in% c("NTg2","NTg8")))
chisq.test(df_smaller$assigned_grna, df_smaller$lane)
```
Indeed, the effect persists.

## Batch in the Schraivogel enhancer screen (chromosome 8)

Let's cross-tabulate batch with NTC in the Schraivogel enhancer screen data for chromosome 8:
```{r}
df <- lowmoi::get_data_for_pert_prop("schraivogel", "enhancer_screen_chr8") |>
    dplyr::mutate(batch = factor(batch, levels = paste0("sample", 1:14)))
  
df |> 
  dplyr::select(assigned_grna, batch) |> 
  table()
```
One thing that jumps out at us is that the vast majority of NTC-containing cells were sequenced in batch 14. Let's confirm this:
```{r}
df |> count(batch)
```

Let's also apply a chi-squared test, calibrated based on permutation:
```{r}
chisq.test(df$assigned_grna, df$batch, simulate.p.value = TRUE, B = 20000)
```
We see that the $p$-value is significant, but much less so that in the Papalexi data. However, note that batch may still have a very strong confounding effect when we test targeting gRNAs against NTCs, since in the population of all cells (rather than the population of just NTCs), there is a very strong association between batch and gRNA. 

## Batch in the Schraivogel enhancer screen (chromosome 11)

In the chromosome 11, again batch 14 dominates:
```{r}
df <- lowmoi::get_data_for_pert_prop("schraivogel", "enhancer_screen_chr11") |>
      dplyr::mutate(batch = factor(batch, levels = paste0("sample", 1:14)))
df |> count(batch)
```

However, the chi-square test does not come out significant:
```{r}
chisq.test(df$assigned_grna, df$batch, simulate.p.value = TRUE, B = 20000)
```
It seems that the dominant effect here is not so much that different NTCs are overrepresented in different batches, but that all NTCs are overrepresented in batch 14. 
