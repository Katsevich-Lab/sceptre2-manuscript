---
title: "SCEPTRE Resampling Distributions"
output: html_document
date: '2022-07-21'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(ondisc)

# path to SCEPTRE2 files
sceptre2_dir <- .get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
# create the multimodal odm
gasp_data_dir= paste0(sceptre2_dir, "data/gasperini/at_scale/")
# i) multimodal metadata file
multimodal_metadata_fp= paste0(gasp_data_dir, "multimodal_metadata.rds")
# ii) gene ODM
gene_odm_fp = paste0(gasp_data_dir, "gene/matrix.odm")
# iii) grna ODM
grna_odm_fp = paste0(gasp_data_dir, "grna_expression/matrix.odm")
# read the Gasperini data
mm_odm <- read_multimodal_odm(c(gene_odm_fp, grna_odm_fp), multimodal_metadata_fp)
gene_odm <- mm_odm |> get_modality("gene")
grna_odm <- mm_odm |> get_modality("grna_assignment")
```

The goal of this document is to explore the resampling distribution of SCEPTRE on the Gasperini data, and assess the extent to which the skew-t or normal distributions fit to this data. Since the discreteness in the resampling distribution is a reflection of the discreteness in the gene and gRNA data, i.e. the number of cells they are expressed in. We choose a set of genes and gRNAs across this spectrum (25 each), and run SCEPTRE on the Cartesian product set of 625 pairs. Here is a subset of the resampling distributions, with skew-t and normal distributions overlaid.

```{r, echo = FALSE}
get_features <- function(n_features, feature_covariates) {
  min_n_nonzero <- feature_covariates |>
    summarise(min(n_nonzero)) |>
    pull()
  max_n_nonzero <- feature_covariates |>
    summarise(max(n_nonzero)) |>
    pull()
  n_nonzero_vals <- exp(seq(log(min_n_nonzero),
    log(max_n_nonzero),
    length.out = n_features
  ))
  feature_covariates <- feature_covariates |>
    rownames_to_column(var = "feature_id")
  feature_ids <- character(n_features)
  for(idx in 1:n_features){
    n_nonzero_val <- n_nonzero_vals[idx]
    feature_ids[idx] <- feature_covariates |>
      filter(!(feature_id %in% feature_ids)) |>
      mutate(dist_to_val = abs(n_nonzero - n_nonzero_val)) |>
      arrange(dist_to_val) |>
      head(1) |>
      pull(feature_id)
  }
  feature_covariates |>
    filter(feature_id %in% feature_ids) |>
    select(feature_id, n_nonzero) |>
    arrange(n_nonzero)
}
```

```{r, echo = FALSE}
N_GENES <- 25
N_GRNAS <- 25

genes_df <- get_features(N_GENES, get_feature_covariates(gene_odm))
grnas_df <- get_features(N_GRNAS, grna_odm |> 
                           get_feature_covariates() |>
                           group_by(grna_group) |>
                           summarise(n_nonzero = sum(n_nonzero)) |>
                           column_to_rownames(var = "grna_group"))
```

```{r, echo = FALSE}
pairs <- crossing(gene_id = genes_df$feature_id, grna_group = grnas_df$feature_id)
pairs_fp <- paste0(sceptre2_dir, "results/resampling_distributions/pairs.rds")
saveRDS(pairs, pairs_fp)
```

```{bash, eval = FALSE, echo = FALSE}
source ~/.research_config
$LOCAL_CODE_DIR/sceptre2-manuscript/pipeline_launch_scripts/high_moi/launch_gasperini_analysis.sh
```

```{r, echo = FALSE}
# read results and join with gene/gRNA information
output_fp <- paste0(sceptre2_dir, "results/resampling_distributions/sceptre_result.rds")
results <- readRDS(output_fp)
results_joined <- results |> 
  left_join(genes_df |> 
              rename(gene_id = feature_id, n_nonzero_gene = n_nonzero), by = "gene_id") |>
  left_join(grnas_df |> 
              rename(grna_group = feature_id, n_nonzero_grna = n_nonzero), by = "grna_group")
```

```{r, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 6}
results_long <- results_joined |>
  pivot_longer(z_null_1:z_null_1000,
               names_to = "resample",
               names_prefix = "z_null_",
               values_to = "z_null")

results_long |> 
  filter(n_nonzero_gene %in% c(2065, 3032, 6532, 11630, 17075), 
         n_nonzero_grna %in% c(147, 218, 293, 386, 539)) |>
  ggplot(aes(x = z_null)) +
  geom_histogram(aes(y = ..density..), bins = 100, colour = "black") +
  stat_function(aes(colour = "N(0,1)"), fun = dnorm) +
  geom_line(aes(y = sn::dst(z_null, 
                            xi = xi, 
                            omega = omega, 
                            alpha = alpha, 
                            nu = nu),
                colour = "Skew-t")) +
  facet_grid(n_nonzero_grna ~ n_nonzero_gene, scales = "free", 
             labeller = labeller(n_nonzero_grna = function(string)(paste0("cells/grna: ", string)),
                                 n_nonzero_gene = function(string)(paste0("cells/gene: ", string)))) +
  theme_bw() +
  labs(x = "Resampled statistic") +
  theme(legend.title = element_blank(), 
        legend.position = "bottom",
        axis.title.y = element_blank())
```

We see that the spiky behavior improves as the number of cells per gene or per gRNA increases. To formalize whether a distribution fits the resampled statistics well, we can use one-sample KS tests. We try three options (ordered from most flexible to least flexible): skew-t, normal with fitted mean and variance, and standard normal. 

```{r, echo = FALSE}
ks_test_skew_t <- function(z_null, skew_t_fit_success, xi, omega, alpha, nu) {
  if (any(skew_t_fit_success)) {
    ks.test(z_null, function(t) {
      (sn::pst(t,
        xi = unique(xi),
        omega = unique(omega),
        alpha = unique(alpha),
        nu = unique(nu)
      ))
    })$p.value
  } else {
    0
  }
}

ks_test_std_norm <- function(z_null){
  ks.test(z_null, "pnorm")$p.value
}

ks_test_fit_norm <- function(z_null){
  ks.test(z_null, function(t)(pnorm(t, mean = mean(z_null), sd = sd(z_null))))$p.value
}
```

```{r, message = FALSE, echo = FALSE}
gof_pvals_skewt <- results_long |>
  group_by(gene_id, grna_group, n_nonzero_gene, n_nonzero_grna) |>
  summarise(ks_pval = ks_test_skew_t(z_null, skew_t_fit_success, xi, omega, alpha, nu)) |>
  ungroup() |>
  arrange(n_nonzero_grna, n_nonzero_gene)

gof_pvals_std_norm <- results_long |>
  group_by(gene_id, grna_group, n_nonzero_gene, n_nonzero_grna) |>
  summarise(ks_pval = ks_test_std_norm(z_null)) |>
  ungroup() |>
  arrange(n_nonzero_grna, n_nonzero_gene)

gof_pvals_fit_norm <- results_long |>
  group_by(gene_id, grna_group, n_nonzero_gene, n_nonzero_grna) |>
  summarise(ks_pval = ks_test_fit_norm(z_null)) |>
  ungroup() |>
  arrange(n_nonzero_grna, n_nonzero_gene)
```

Let's define a bad fit as a pair for which the KS p-value is below 0.05. We plot the fit quality for each of the three distributions as a function of cells/gene and cells/gRNA.

```{r, echo = FALSE}
gof_pvals_skewt |>
  arrange(desc(ks_pval)) |>
  mutate(fit_quality = factor(ks_pval < 0.05, 
                          levels = c(FALSE, TRUE), 
                          labels = c("Good fit", "Bad fit"))) |>
  ggplot(aes(x = n_nonzero_gene, y = n_nonzero_grna, colour = fit_quality)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Cells per gene",
       y = "Cells per gRNA group",
       title = "Skew-t") +
  scale_colour_manual(values = c("darkgreen", "red")) +
  theme_bw() + 
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

gof_pvals_fit_norm |>
  arrange(desc(ks_pval)) |>
  mutate(fit_quality = factor(ks_pval < 0.05, 
                          levels = c(FALSE, TRUE), 
                          labels = c("Good fit", "Bad fit"))) |>
  ggplot(aes(x = n_nonzero_gene, y = n_nonzero_grna, colour = fit_quality)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Cells per gene",
       y = "Cells per gRNA group",
       title = "Fitted normal") +
  scale_colour_manual(values = c("darkgreen", "red")) +
  theme_bw() + 
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

gof_pvals_std_norm |>
  arrange(desc(ks_pval)) |>
  mutate(fit_quality = factor(ks_pval < 0.05, 
                          levels = c(FALSE, TRUE), 
                          labels = c("Good fit", "Bad fit"))) |>
  ggplot(aes(x = n_nonzero_gene, y = n_nonzero_grna, colour = fit_quality)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Cells per gene",
       y = "Cells per gRNA group",
       title = "Standard normal") +
  scale_colour_manual(values = c("darkgreen", "red")) +
  theme_bw() + 
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")
```

We see that the skew-t fit is usually good for pairs with at least 300 cells per gRNA group or at least 3000 cells per gene. The latter cutoff is about 1.5\% of all cells. Let's put these cutoffs in the context of the Gasperini data. 

```{r, echo = FALSE}
gene_odm |> 
  get_feature_covariates() |>
  ggplot(aes(x = n_nonzero)) +
  geom_histogram(bins = 100, colour = "black") + 
  geom_vline(xintercept = 3000, linetype = "dashed", colour = "red") +
  labs(x = "Cells per gene",
       y = "Number of genes") +
  theme_bw()

grna_odm |> 
  get_feature_covariates() |>
  ggplot(aes(x = n_nonzero)) +
  geom_histogram(bins = 100, colour = "black") + 
  geom_vline(xintercept = 300, linetype = "dashed", colour = "red") +
  labs(x = "Cells per gRNA group",
       y = "Number of gRNA groups") +
  theme_bw()
```
```{r, echo = FALSE, message = FALSE, eval = FALSE}
gene_odm |> 
  get_feature_covariates() |> 
  summarise(mean(n_nonzero > 3000)) |> 
  pull()

grna_odm |> 
  get_feature_covariates() |> 
  summarise(mean(n_nonzero > 300)) |> 
  pull()

cis_pairs <- read_tsv(paste0(.get_config_path("LOCAL_GASPERINI_2019_V2_DATA_DIR"), "at-scale/raw/GSE120861_gene_gRNAgroup_pair_table.at_scale.txt")) |> 
  filter(!(general_group %in% c("NTC", "TSS", "positive_ctrl"))) |> 
  select(gRNAgroup, ENSG.targetgene)

cis_pairs |>
  rename(grna_group = gRNAgroup, gene_id = ENSG.targetgene) |>
  inner_join(get_feature_covariates(gene_odm) |>
    rename(n_nonzero_gene = n_nonzero) |>
    rownames_to_column(var = "gene_id") |>
    select(gene_id, n_nonzero_gene),
  by = "gene_id"
  ) |>
  inner_join(get_feature_covariates(grna_odm) |>
    group_by(grna_group) |>
    summarise(n_nonzero_grna = sum(n_nonzero)) |>
    select(grna_group, n_nonzero_grna),
  by = "grna_group"
  ) |>
  summarise(sum(n_nonzero_gene <= 3000 & n_nonzero_grna <= 300)) |>
  pull()
```

About 95\% of the Gasperini genes are expressed in at least 3000 cells, and about 87\% of gRNA groups are expressed in at least 300 cells. Among the roughly 80,000, Gasperini cis pairs, only one involves a gene expressed in at most 3000 cells and a gRNA group expressed in at most 300 cells.

```{r, eval = FALSE, echo = FALSE}
results_long |>
  group_by(gene_id, grna_group, mean_expression) |>
  summarise(mean_z = mean(z_null), se_z = sd(z_null)/sqrt(n())) |>
  ungroup() |>
  ggplot(aes(x = mean_z, y = se_z, colour = mean_expression)) +
  geom_point() +
  geom_abline(slope = 2, linetype = "dashed") +
  geom_abline(slope = -2, linetype = "dashed") +
  theme_bw()

results_long |>
  group_by(gene_id, grna_group, mean_expression) |>
  summarise(se_z = sd(z_null)) |>
  ungroup() |>
  ggplot(aes(x = se_z)) +
  geom_histogram() +
  facet_grid(mean_expression ~ .) +
  theme_bw()
```

```{r, eval = FALSE, echo = FALSE}
# xi
results_joined |> 
  ggplot(aes(x = mean_expression, y = xi)) + 
  geom_point() +
#  geom_boxplot(fill = "dodgerblue") + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Mean gene expression",
       y = "Mean shift") +
  theme_bw()

# omega
results_joined |> 
  ggplot(aes(x = mean_expression, y = omega)) + 
  geom_boxplot(fill = "dodgerblue") + 
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(x = "Mean gene expression",
       y = "Variance inflation") +
  theme_bw()

# alpha
results_joined |> 
  ggplot(aes(x = mean_expression, y = alpha)) + 
  geom_boxplot(fill = "dodgerblue") + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Mean gene expression",
       y = "Skewness") +
  theme_bw()

# nu
results_joined |> 
  ggplot(aes(x = mean_expression, y = nu)) + 
  geom_boxplot(fill = "dodgerblue") + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_y_log10() +
  labs(x = "Mean gene expression",
       y = "Degrees of freedom") +
  theme_bw()
```

