facet_wrap(. ~ dataset, scales = "free") +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7)
ggplot(data = n_rejected_n_cells_df |> filter(method == "seurat_de"),
mapping = aes(y = n_reject, x = n_undercover_cells)) +
facet_wrap(. ~ dataset, scales = "free") +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7) + theme_bw()
ggplot(data = n_rejected_n_cells_df |> filter(method == "seurat_de"),
mapping = aes(y = n_reject, x = n_undercover_cells)) +
facet_wrap(. ~ dataset, scales = "free") +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7) + theme_bw() +
xlab("N undercover cells") + ylab("N reject")
undercover_res
undercover_res |>
dplyr::group_by(dataset, method) |>
dplyr::mutate(reject = (p_value < alpha/dplyr::n())) |>
dplyr::group_by(dataset, method, undercover_grna) |>
dplyr::summarize(n_reject = sum(reject),
n_undercover_cells = n_undercover_cells[1]) |>
dplyr::ungroup()
undercover_res |>
dplyr::group_by(dataset_rename_w_pairs, method) |>
dplyr::mutate(reject = (p_value < alpha/dplyr::n())) |>
dplyr::group_by(dataset_rename_w_pairs, method, undercover_grna) |>
dplyr::summarize(n_reject = sum(reject),
n_undercover_cells = n_undercover_cells[1]) |>
dplyr::ungroup()
# experimental
lm_df <- n_rejected_n_cells_df |>
filter(method == "seurat_de") |>
group_by(dataset_rename_w_pairs, method) |>
group_modify(function(tibble, key) {
fit <- lm(formula = n_reject ~ n_undercover_cells, data = tibble)
s <- summary(fit)
p <- s$coefficients["n_undercover_cells", "Pr(>|t|)"]
coefs <- coef(fit)
data.frame(intercept = coefs[[1]], slope = coefs[[2]], p_val = p)
})
# 11. for each dataset-method pair, return the number of rejections and number of cells for each undercover gRNA
get_n_reject_n_undercover_cells_df <- function(undercover_res, alpha) {
undercover_res |>
dplyr::group_by(dataset_rename_w_pairs, method) |>
dplyr::mutate(reject = (p_value < alpha/dplyr::n())) |>
dplyr::group_by(dataset_rename_w_pairs, method, undercover_grna) |>
dplyr::summarize(n_reject = sum(reject),
n_undercover_cells = n_undercover_cells[1]) |>
dplyr::ungroup()
}
# experimental
lm_df <- n_rejected_n_cells_df |>
filter(method == "seurat_de") |>
group_by(dataset, method) |>
group_modify(function(tibble, key) {
fit <- lm(formula = n_reject ~ n_undercover_cells, data = tibble)
s <- summary(fit)
p <- s$coefficients["n_undercover_cells", "Pr(>|t|)"]
coefs <- coef(fit)
data.frame(intercept = coefs[[1]], slope = coefs[[2]], p_val = p)
})
# 11. for each dataset-method pair, return the number of rejections and number of cells for each undercover gRNA
get_n_reject_n_undercover_cells_df <- function(undercover_res, alpha) {
undercover_res |>
dplyr::group_by(dataset_rename_w_pairs, method) |>
dplyr::mutate(reject = (p_value < alpha/dplyr::n())) |>
dplyr::group_by(dataset_rename_w_pairs, method, undercover_grna) |>
dplyr::summarize(n_reject = sum(reject),
n_undercover_cells = n_undercover_cells[1]) |>
dplyr::ungroup()
}
undercover_res
# 12. associate n undercover cells w n rejections
associate_n_undercover_cells_w_n_rejections <- function() {
lm_df <- n_rejected_n_cells_df |>
filter(method == "seurat_de") |>
group_by(dataset, method) |>
group_modify(function(tibble, key) {
fit <- lm(formula = n_reject ~ n_undercover_cells, data = tibble)
s <- summary(fit)
p <- s$coefficients["n_undercover_cells", "Pr(>|t|)"]
coefs <- coef(fit)
data.frame(intercept = coefs[[1]], slope = coefs[[2]], p_val = p)
})
ggplot(data = n_rejected_n_cells_df |> filter(method == "seurat_de"),
mapping = aes(y = n_reject, x = n_undercover_cells)) +
facet_wrap(. ~ dataset, scales = "free") +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7) + theme_bw() +
xlab("N undercover cells") + ylab("N reject")
}
9
9
n_rejected_n_cells_df <- get_n_reject_n_undercover_cells_df(undercover_res, alpha = 0.1)
n_rejected_n_cells_df
n_rejected_n_cells_df
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
undercover_res
undercover_res
n_rejected_n_cells_df <- get_n_reject_n_undercover_cells_df(undercover_res, alpha = 0.1)
n_rejected_n_cells_df
n_rejected_n_cells_df |> filter(method == "seurat_de")
n_rejected_n_cells_df_sub
n_rejected_n_cells_df_sub <- n_rejected_n_cells_df
n_rejected_n_cells_df_sub
n_rejected_n_cells_df_sub <- n_rejected_n_cells_df |> filter(method == "seurat_de")
n_rejected_n_cells_df_sub
lm_df <- n_rejected_n_cells_df_sub |>
group_by(dataset, method) |>
group_modify(function(tibble, key) {
fit <- lm(formula = n_reject ~ n_undercover_cells, data = tibble)
s <- summary(fit)
p <- s$coefficients["n_undercover_cells", "Pr(>|t|)"]
coefs <- coef(fit)
data.frame(intercept = coefs[[1]], slope = coefs[[2]], p_val = p)
})
n_rejected_n_cells_df_sub
lm_df <- n_rejected_n_cells_df_sub |>
group_by(dataset_rename_w_pairs, method) |>
group_modify(function(tibble, key) {
fit <- lm(formula = n_reject ~ n_undercover_cells, data = tibble)
s <- summary(fit)
p <- s$coefficients["n_undercover_cells", "Pr(>|t|)"]
coefs <- coef(fit)
data.frame(intercept = coefs[[1]], slope = coefs[[2]], p_val = p)
})
lm_df
ggplot(data = n_rejected_n_cells_df_sub,
mapping = aes(y = n_reject, x = n_undercover_cells)) +
facet_wrap(. ~ dataset, scales = "free") +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7) + theme_bw() +
xlab("N undercover cells") + ylab("N reject")
ggplot(data = n_rejected_n_cells_df_sub,
mapping = aes(y = n_reject, x = n_undercover_cells)) +
facet_wrap(. ~ dataset_rename_w_pairs, scales = "free") +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7) + theme_bw() +
xlab("N undercover cells") + ylab("N reject")
ggplot(data = n_rejected_n_cells_df_sub,
mapping = aes(y = n_reject, x = n_undercover_cells)) +
facet_wrap(. ~ dataset_rename_w_pairs, scales = "free", labeller = label_wrap_gen(35)) +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7) + theme_bw() +
xlab("N undercover cells") + ylab("N reject")
# 12. associate n undercover cells w n rejections
associate_n_undercover_cells_w_n_rejections <- function(n_rejected_n_cells_df_sub) {
lm_df <- n_rejected_n_cells_df_sub |>
group_by(dataset_rename_w_pairs, method) |>
group_modify(function(tibble, key) {
fit <- lm(formula = n_reject ~ n_undercover_cells, data = tibble)
s <- summary(fit)
p <- s$coefficients["n_undercover_cells", "Pr(>|t|)"]
coefs <- coef(fit)
data.frame(intercept = coefs[[1]], slope = coefs[[2]], p_val = p)
})
p <- ggplot(data = n_rejected_n_cells_df_sub,
mapping = aes(y = n_reject, x = n_undercover_cells)) +
facet_wrap(. ~ dataset_rename_w_pairs, scales = "free", labeller = label_wrap_gen(35)) +
geom_point() +
geom_abline(data = lm_df,
mapping = aes(slope = slope, intercept = intercept, col = p_val < 0.05),
lwd = 0.7) + theme_bw() +
xlab("N undercover cells") + ylab("N reject")
return(p)
}
undercover_res
n_rejected_n_cells_df <- get_n_reject_n_undercover_cells_df(undercover_res, alpha = 0.1)
n_rejected_n_cells_df
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |>
filter(method == "seurat_de"))
effective_samp_size_n_rejected_assoc_plot
method <- methods[j]
j <- 1
method <- methods[j]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |>
filter(method == "seurat_de"))
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |>
filter(method == !!method))
method <- methods[j]
# 3. create histograms for the permutation, seurat de, and NB regression methods
methods <- c("permutation_test", "seurat_de", "nb_regression")
method <- methods[j]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |>
filter(method == !!method))
effective_samp_size_n_rejected_assoc_plot
method
methods
method <- methods[3]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |>
filter(method == !!method))
effective_samp_size_n_rejected_assoc_plot
ggsave(filename = paste0(fig_dirm, "assoc_plot_", method, "_grp=", i, ".png"),
plot = effective_samp_size_n_rejected_assoc_plot,
device = "png", scale = 1.1, width = 8, height = 5,
dpi = 330)
ggsave(filename = paste0(fig_dir, "assoc_plot_", method, "_grp=", i, ".png"),
plot = effective_samp_size_n_rejected_assoc_plot,
device = "png", scale = 1.1, width = 8, height = 5,
dpi = 330)
i <- 2
undercover_res <- readRDS(undercover_res_fps[i]) |>
dplyr::mutate(clock_time = NULL, max_ram = NULL)|>
dplyr::mutate(dataset_slash = replace_dataset_underscore_with_slash(dataset))
undercover_res_fps <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"),
"results/undercover_grna_analysis/undercover_result_grp_size_", seq(1, 3), ".rds")
fig_dir <- paste0(.get_config_path("LOCAL_CODE_DIR"), "sceptre2-manuscript/figures/undercover_figs/")
# source the functions
funct_script <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/analyze_undercover_results_plot_functs.R")
source(funct_script)
# load packages
library(ggplot2)
library(katlabutils)
library(future.apply)
library(wesanderson)
plan(multisession)
undercover_res <- readRDS(undercover_res_fps[i]) |>
dplyr::mutate(clock_time = NULL, max_ram = NULL)|>
dplyr::mutate(dataset_slash = replace_dataset_underscore_with_slash(dataset))
undercover_res <- combine_schraivogel_enhancer_screens(undercover_res)
if (!perform_sanity_check(undercover_res)) {
stop("Sanity check failed.")
}
undercover_res <- update_dataset_names(undercover_res, TRUE)
if (FALSE) {
undercover_res_no_chrom <- undercover_res |>
dplyr::filter(!(dataset %in% c("liscovitch_experiment_big_chromatin",
"liscovitch_experiment_small_chromatin")))
undercover_res_chrom_only <- undercover_res |>
dplyr::filter(dataset %in% c("liscovitch_experiment_big_chromatin",
"liscovitch_experiment_small_chromatin"))
# 1. create the qq-plots
trans_qq_plot <- make_trans_qq_plot(undercover_res_no_chrom)
untrans_qq_plot <- make_untrans_qq_plot(undercover_res_no_chrom)
lisc_plot <- make_trans_qq_plot(undercover_res_chrom_only)
ggsave(filename = paste0(fig_dir, "trans_qq_no_chrom_grp=", i, ".png"),
plot = trans_qq_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
ggsave(filename = paste0(fig_dir, "untrans_qq_no_chrom_grp=", i, ".png"),
plot = untrans_qq_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
ggsave(file = paste0(fig_dir, "trans_qq_chrom_only_grp=", i, ".png"),
plot = lisc_plot, device = "png", scale = 1.4, dpi = 330, width = 4, height = 2)
}
# 2. create n pairs rejected plots
n_rejected_df <- compute_n_bonf_rejected(undercover_res = undercover_res_no_chrom, alpha = 0.05)
n_rejected_plot <- make_n_rejected_pairs_plot(n_rejected_df = n_rejected_df, y_max = 1e5)
# 2. create n pairs rejected plots
n_rejected_df <- compute_n_bonf_rejected(undercover_res = undercover_res_no_chrom, alpha = 0.05)
undercover_res_no_chrom <- undercover_res |>
dplyr::filter(!(dataset %in% c("liscovitch_experiment_big_chromatin",
"liscovitch_experiment_small_chromatin")))
undercover_res_chrom_only <- undercover_res |>
dplyr::filter(dataset %in% c("liscovitch_experiment_big_chromatin",
"liscovitch_experiment_small_chromatin"))
if (FALSE) {
# 1. create the qq-plots
trans_qq_plot <- make_trans_qq_plot(undercover_res_no_chrom)
untrans_qq_plot <- make_untrans_qq_plot(undercover_res_no_chrom)
lisc_plot <- make_trans_qq_plot(undercover_res_chrom_only)
ggsave(filename = paste0(fig_dir, "trans_qq_no_chrom_grp=", i, ".png"),
plot = trans_qq_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
ggsave(filename = paste0(fig_dir, "untrans_qq_no_chrom_grp=", i, ".png"),
plot = untrans_qq_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
ggsave(file = paste0(fig_dir, "trans_qq_chrom_only_grp=", i, ".png"),
plot = lisc_plot, device = "png", scale = 1.4, dpi = 330, width = 4, height = 2)
}
# 2. create n pairs rejected plots
n_rejected_df <- compute_n_bonf_rejected(undercover_res = undercover_res_no_chrom, alpha = 0.05)
n_rejected_plot <- make_n_rejected_pairs_plot(n_rejected_df = n_rejected_df, y_max = 1e5)
if (FALSE) {
ggsave(filename = paste0(fig_dir, "barplot_no_chrom_grp=", i, ".png"),
plot = n_rejected_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
}
# 3. create histograms for the permutation, seurat de, and NB regression methods
methods <- c("permutation_test", "seurat_de", "nb_regression")
if (FALSE) {
for (j in seq(1, length(methods))) {
method <- methods[j]
fill <- my_cols[j]
hist_p <- make_histograms(undercover_res |> filter(method == !!method),
fill = my_cols[j])
ggsave(filename = paste0(fig_dir, "histogram_", method, "_grp=", i, ".png"),
plot = hist_p, device = "png", scale = 1.1, width = 8, height = 5, dpi = 330)
}
}
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
n_rejected_n_cells_df <- get_n_reject_n_undercover_cells_df(undercover_res, alpha = 0.1)
# 10. append the number of undercover cells
append_n_undercover_cells <- function(undercover_res) {
undercover_res |>
group_by(undercover_grna, dataset_slash) |>
group_modify(function(tibble, key) {
print(paste0("Working on ", paste0(key$undercover_grna, key$dataset_slash, collapse = " ")))
dataset_name <- as.character(key$dataset_slash)
undercover_grna <- as.character(key$undercover_grna)
grna_feature_covariates <- get_grna_dataset_name(dataset_name, "assignment") |>
load_dataset_modality() |>
get_feature_covariates()
n_undercover_cells <- grna_feature_covariates[undercover_grna, "n_nonzero"] |> sum()
mutate(tibble, n_undercover_cells = n_undercover_cells)
})
}
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
j <- 1
method <- methods[j]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |> filter(method == !!method))
method <- methods[j]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |> filter(method == !!method))
n_rejected_n_cells_df
b
n_rejected_n_cells_df
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
undercover_res
undercover_res
(undercover_res |> dplyr::pull()([1])
(undercover_res |> dplyr::pull()[1]
)
(undercover_res |> dplyr::pull())[1]
(undercover_res |> dplyr::pull(undercover_grna))[1]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |> filter(method == !!method))
tibble <- undercover_res |> filter(undercover_grna == "NO-SITE-707,ONE-NON-GENE-SITE-2", dataset_slash == )
(undercover_res |> dplyr::pull(dataset_slash))[1]
tibble <- undercover_res |> filter(undercover_grna == "NO-SITE-707,ONE-NON-GENE-SITE-2", dataset_slash == "frangieh/co_culture/gene")
key <- data.frame(undercover_grna = "NO-SITE-707,ONE-NON-GENE-SITE-2", dataset_slash = "frangieh/co_culture/gene")
key
tibble
key
print(paste0("Working on ", paste0(key$undercover_grna, key$dataset_slash, collapse = " ")))
dataset_name <- as.character(key$dataset_slash)
undercover_grna <- as.character(key$undercover_grna)
grna_feature_covariates <- get_grna_dataset_name(dataset_name, "assignment") |>
load_dataset_modality() |>
get_feature_covariates()
grna_feature_covariates
undercover_grna
strsplit(x = key$undercover_grna, split = ",", fixed = TRUE) |> unlist()
undercover_grna <- strsplit(x = key$undercover_grna, split = ",", fixed = TRUE) |> unlist()
undercover_grna
undercover_grna <- strsplit(x = key$undercover_grna, split = ",", fixed = TRUE) |> unlist()
grna_f
undercover_grna <- strsplit(x = key$undercover_grna, split = ",", fixed = TRUE) |> unlist()
grna_feature_covariates <- get_grna_dataset_name(dataset_name, "assignment") |>
load_dataset_modality() |>
get_feature_covariates()
n_undercover_cells <- grna_feature_covariates[undercover_grna, "n_nonzero"] |> sum()
n_undercover_cells
grna_feature_covariates[undercover_grna, "n_nonzero"]
# 10. append the number of undercover cells
append_n_undercover_cells <- function(undercover_res) {
undercover_res |>
group_by(undercover_grna, dataset_slash) |>
group_modify(function(tibble, key) {
print(paste0("Working on ", paste0(key$undercover_grna, key$dataset_slash, collapse = " ")))
dataset_name <- as.character(key$dataset_slash)
undercover_grna <- strsplit(x = key$undercover_grna, split = ",", fixed = TRUE) |> unlist()
grna_feature_covariates <- get_grna_dataset_name(dataset_name, "assignment") |>
load_dataset_modality() |>
get_feature_covariates()
n_undercover_cells <- grna_feature_covariates[undercover_grna, "n_nonzero"] |> sum()
mutate(tibble, n_undercover_cells = n_undercover_cells)
})
}
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
key <- data.frame(undercover_grna = "NO-SITE-707,ONE-NON-GENE-SITE-2", dataset_slash = "frangieh/co_culture/gene")
key
undercover_grna <- strsplit(x = key$undercover_grna, split = ",", fixed = TRUE) |> unlist()
undercover_grna
print(paste0("Working on ", key$undercover_grna, key$dataset_slash, collapse = " "))
print(paste0("Working on ", key$undercover_grna, " ", key$dataset_slash))
# 10. append the number of undercover cells
append_n_undercover_cells <- function(undercover_res) {
undercover_res |>
group_by(undercover_grna, dataset_slash) |>
group_modify(function(tibble, key) {
print(paste0("Working on ", key$undercover_grna, " ", key$dataset_slash))
dataset_name <- as.character(key$dataset_slash)
undercover_grna <- strsplit(x = as.character(key$undercover_grna), split = ",", fixed = TRUE) |> unlist()
grna_feature_covariates <- get_grna_dataset_name(dataset_name, "assignment") |>
load_dataset_modality() |>
get_feature_covariates()
n_undercover_cells <- grna_feature_covariates[undercover_grna, "n_nonzero"] |> sum()
mutate(tibble, n_undercover_cells = n_undercover_cells)
})
}
n_rejected_n_cells_df <- get_n_reject_n_undercover_cells_df(undercover_res, alpha = 0.1)
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
undercover_res
undercover_res$n_undercover_cells <- NA
undercover_res$n_undercover_cells <- NULL
undercover_res
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
undercover_res
undercover_res$n_undercover_cells |> unique()
n_rejected_n_cells_df <- get_n_reject_n_undercover_cells_df(undercover_res, alpha = 0.1)
n_rejected_n_cells_df
j
method <- methods[j]
method
methods
methods <- c("seurat_de", "nb_regression")
for (j in seq(1, length(methods))) {
method <- methods[j]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |> filter(method == !!method))
ggsave(filename = paste0(fig_dir, "assoc_plot_", method, "_grp=", i, ".png"),
plot = effective_samp_size_n_rejected_assoc_plot,
device = "png", scale = 1.1, width = 8, height = 5,
dpi = 330)
}
j
method <- methods[j]
method
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |> filter(method == !!method))
effective_samp_size_n_rejected_assoc_plot
method
method <- "seurat_de"
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |> filter(method == !!method))
effective_samp_size_n_rejected_assoc_plot
undercover_res_fps <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"),
"results/undercover_grna_analysis/undercover_result_grp_size_", seq(1, 3), ".rds")
fig_dir <- paste0(.get_config_path("LOCAL_CODE_DIR"), "sceptre2-manuscript/figures/undercover_figs/")
# source the functions
funct_script <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/analyze_undercover_results_plot_functs.R")
source(funct_script)
# load packages
library(ggplot2)
library(katlabutils)
library(future.apply)
library(wesanderson)
plan(multisession)
future_lapply(X = seq(1, 3), FUN = function(i) {
undercover_res <- readRDS(undercover_res_fps[i]) |>
dplyr::mutate(clock_time = NULL, max_ram = NULL)|>
dplyr::mutate(dataset_slash = replace_dataset_underscore_with_slash(dataset))
undercover_res <- combine_schraivogel_enhancer_screens(undercover_res)
if (!perform_sanity_check(undercover_res)) {
stop("Sanity check failed.")
}
undercover_res <- update_dataset_names(undercover_res, TRUE)
undercover_res_no_chrom <- undercover_res |>
dplyr::filter(!(dataset %in% c("liscovitch_experiment_big_chromatin",
"liscovitch_experiment_small_chromatin")))
undercover_res_chrom_only <- undercover_res |>
dplyr::filter(dataset %in% c("liscovitch_experiment_big_chromatin",
"liscovitch_experiment_small_chromatin"))
if (FALSE) {
# 1. create the qq-plots
trans_qq_plot <- make_trans_qq_plot(undercover_res_no_chrom)
untrans_qq_plot <- make_untrans_qq_plot(undercover_res_no_chrom)
lisc_plot <- make_trans_qq_plot(undercover_res_chrom_only)
ggsave(filename = paste0(fig_dir, "trans_qq_no_chrom_grp=", i, ".png"),
plot = trans_qq_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
ggsave(filename = paste0(fig_dir, "untrans_qq_no_chrom_grp=", i, ".png"),
plot = untrans_qq_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
ggsave(file = paste0(fig_dir, "trans_qq_chrom_only_grp=", i, ".png"),
plot = lisc_plot, device = "png", scale = 1.4, dpi = 330, width = 4, height = 2)
}
# 2. create n pairs rejected plots
n_rejected_df <- compute_n_bonf_rejected(undercover_res = undercover_res_no_chrom, alpha = 0.05)
n_rejected_plot <- make_n_rejected_pairs_plot(n_rejected_df = n_rejected_df, y_max = 1e5)
if (FALSE) {
ggsave(filename = paste0(fig_dir, "barplot_no_chrom_grp=", i, ".png"),
plot = n_rejected_plot, device = "png", scale = 1.25, dpi = 330, width = 9, height = 6)
}
# 3. create histograms for the permutation, seurat de, and NB regression methods
methods <- c("permutation_test", "seurat_de", "nb_regression")
if (FALSE) {
for (j in seq(1, length(methods))) {
method <- methods[j]
fill <- my_cols[j]
hist_p <- make_histograms(undercover_res |> filter(method == !!method),
fill = my_cols[j])
ggsave(filename = paste0(fig_dir, "histogram_", method, "_grp=", i, ".png"),
plot = hist_p, device = "png", scale = 1.1, width = 8, height = 5, dpi = 330)
}
}
# 4. create plot exploring connection between effective sample size and rejection rate
undercover_res <- append_n_undercover_cells(undercover_res)
n_rejected_n_cells_df <- get_n_reject_n_undercover_cells_df(undercover_res, alpha = 0.1)
methods <- c("seurat_de", "nb_regression")
for (j in seq(1, length(methods))) {
method <- methods[j]
effective_samp_size_n_rejected_assoc_plot <- associate_n_undercover_cells_w_n_rejections(n_rejected_n_cells_df |> filter(method == !!method))
ggsave(filename = paste0(fig_dir, "assoc_plot_", method, "_grp=", i, ".png"),
plot = effective_samp_size_n_rejected_assoc_plot,
device = "png", scale = 1.1, width = 8, height = 5,
dpi = 330)
}
})
.get_config_path()
.get_config_path
