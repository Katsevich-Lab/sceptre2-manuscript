---
title: 'Debugging `sceptre` 4: Frangieh data'
author: "Tim"
date: "2022-10-14"
output: html_document
---

```{r, message = FALSE, echo = FALSE}
library(tidyverse)
library(katlabutils)
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")

# load the auxilliary functions
funct_script <- paste0(.get_config_path("LOCAL_CODE_DIR"), "sceptre2-manuscript/writeups/undercover_results_eda/analyze_undercover_results_plot_functs.R")
source(funct_script)

# 1. undercover res
sceptre_debug <- readRDS(paste0(result_dir, "undercover_grna_analysis/sceptre_debug.rds"))
```

```{r, message = FALSE, echo = FALSE}
replace_slash_w_underscore <- function(df) {
  df |> dplyr::mutate(dataset = gsub(pattern = "/",
                                replacement = "_",
                                fixed = TRUE,
                                x = dataset))
}

update_df <- function(df) {
  df |>
    replace_slash_w_underscore() |>
    combine_schraivogel_enhancer_screens() |>
    update_dataset_names(add_n_pairs = TRUE)
}

sceptre_debug <- update_df(sceptre_debug)
```


This is the fourth installment in the debugging SCEPTRE series. I try to understand what is going on with the Frangieh data. I look at three issues:

- Direction of the effects (i.e., the log-fold changes) on the perturb-seq and TAP-seq data
- The "control group" (i.e., the NTCs cells or the compliment of the treatment cells)
- The possibility that some cells received both a non-targeting gRNA and a targeting gRNA
- Thinking more carefully about MIMOSCA -- what might MIMOSCA be doing right? Plotting the MIMOSCA p-values against the (e.g.) Fisher exact p-values to search for problem pairs.

# 1. Direction of the effects

I study the direction of the effect --- and in particular, the estimated log fold change --- on the Frangieh perturb-seq and TAP-seq data.

```{r}
x <- sceptre_debug |>
  filter(dataset == "schraivogel_ground_truth_perturbseq_gene") |>
  mutate(log_fold_change = ifelse(log_fold_change == -Inf, -3, log_fold_change))

x |> ggplot(mapping = aes(y = p_value_emp)) +
   stat_qq_points(ymin = 1e-9, size = 0.8) +
   facet_wrap(~dataset_rename_w_pairs, scales = "free", ncol = 3, labeller = label_wrap_gen(35)) +
   geom_abline(col = "darkred") +
   stat_qq_band() +
   theme_bw() +
   scale_x_continuous(trans = revlog_trans(10)) +
   scale_y_continuous(trans = revlog_trans(10)) +
   labs(x = "Expected quantile", y = "Observed quantile") +
   theme(legend.position = "bottom",
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())
```

We see that when the LFC is positive, calibration is OK. By contrast, when the LFC is negative, inflation arises. Why? 

```{r}
x |>
  ggplot(mapping = aes(x = log_fold_change)) +
  geom_histogram(bins = 25, fill = "white", col = "black") +
  theme_bw()

x |>
  mutate(lfc_gt0 = log_fold_change >= 0) |>
  group_by(lfc_gt0) |>
  summarize(count = n())

x |>
  filter(log_fold_change <= 0) |>
  ggplot(aes(y = p_value_emp)) +
  stat_qq_points(ymin = 1e-9, size = 0.8) +
   facet_wrap(~dataset_rename_w_pairs, scales = "free", ncol = 3, labeller = label_wrap_gen(35)) +
   geom_abline(col = "darkred") +
   stat_qq_band() +
   theme_bw() +
   scale_x_continuous(trans = revlog_trans(10)) +
   scale_y_continuous(trans = revlog_trans(10)) +
   labs(x = "Expected quantile", y = "Observed quantile") +
   theme(legend.position = "bottom",
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())
```


```{r}
# conditioning on z >= 0 OK
z <- rnorm(10000)
z <- z[z >= 0]
p <- 2 * pnorm(q = -abs(z))
hist(p)
sceptre::make_qq_plot(p)
```
