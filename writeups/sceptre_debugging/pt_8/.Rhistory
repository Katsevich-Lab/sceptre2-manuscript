"sceptre"),
dataset %in% c("papalexi_eccite_screen_protein",
"schraivogel_enhancer_screen",
"papalexi_eccite_screen_gene",
"frangieh_co_culture_gene",
"frangieh_control_gene",
"frangieh_ifn_gamma_gene"))
x |>
compute_n_bonf_rejected() |>
make_n_rejected_pairs_plot(log_trans = FALSE, scales = "free")
sample_size_df_nt |>
ggplot(mapping = aes(x = n_nonzero_treatment)) +
geom_histogram(bins = 15, fill = "white", col = "black") +
theme_bw()
sample_size_df_nt |>
filter(n_nonzero_treatment == 0)
sample_size_df_nt |>
filter(n_nonzero_treatment == 0) |>
nrow()
sample_size_df_nt |>
filter(n_nonzero_treatment == 0) |>
nrow()
to_plot <- rbind(schraiv_sceptre_exact, schraiv_other) |>
left_join(y = sample_size_df_nt, by = c("response_id", "undercover_grna", "dataset"))
head(to_plot)
to_plot <- rbind(schraiv_sceptre_exact, schraiv_other) |>
left_join(y = sample_size_df_nt, by = c("response_id", "undercover_grna", "dataset"))
to_plot <- rbind(schraiv_sceptre_exact, schraiv_other) |>
left_join(y = sample_size_df_nt, by = c("response_id", "undercover_grna", "dataset"))
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"nb_regression")) |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
to_plot |> head()
to_plot$method |> unique()
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method")) |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method")) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
to_plot <- rbind(schraiv_sceptre_exact, schraiv_other) |>
left_join(y = sample_size_df_nt, by = c("response_id", "undercover_grna", "dataset")) |>
update_dataset_names()
head(to_plot)
to_plot$dataset_rename_w_pairs |> head()
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method")) |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method")) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method"),
undercover_grna != "non-targeting-00022") |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
to_plot
p
result_dir
fisher_exact <- readRDS(paste0(result_dir, "undercover_grna_analysis/fisher_exact_1.rds"))
head(fisher_exact)
fisher_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/fisher_exact_1.rds")) |>
replace_slash_w_underscore()
head(fisher_exact)
fisher_exact$dataset |> unique()
fisher_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/fisher_exact_1.rds")) |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens()
head(fisher_exact)
fisher_exact$dataset |> unique
fisher_exact$dataset |> unique()
fisher_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/fisher_exact_1.rds")) |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
filter(dataset %in% c("schraivogel_ground_truth_perturbseq_gene",
"schraivogel_enhancer_screen"))
head(fisher_exact)
fisher_exact$dataset |> unique()
fisher_exact |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene") |>
ggplot(mapping = aes(y = p_value)) +
tat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10))
fisher_exact |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene") |>
ggplot(mapping = aes(y = p_value)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10))
fisher_exact |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene") |>
ggplot(mapping = aes(y = p_value)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
facet_wrap(undercover_grna ~ ., nrow = ncol = 3)
fisher_exact |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene") |>
ggplot(mapping = aes(y = p_value)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
facet_wrap(undercover_grna ~ ., ncol = 3)
source("~/.active-rstudio-document", echo=TRUE)
fisher_exact |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene") |>
ggplot(mapping = aes(y = p_value)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
facet_wrap(undercover_grna ~ ., ncol = 3)
fisher_exact$dataset |> unique()
fisher_exact |>
filter(dataset == "schraivogel_enhancer_screen") |>
ggplot(mapping = aes(y = p_value)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
facet_wrap(undercover_grna ~ ., ncol = 3)
to_plot |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene", method == "sceptre (exact)") |>
ggplot(mapping = aes(y = p_value)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
facet_wrap(undercover_grna ~ ., ncol = 3)
to_plot |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene", method == "sceptre (exact)")
to_plot |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene", method == "sceptre_(exact)")
to_plot$method |> unique()
to_plot <- rbind(schraiv_sceptre_exact, schraiv_other) |>
left_join(y = sample_size_df_nt, by = c("response_id", "undercover_grna", "dataset")) |>
update_dataset_names()
to_plot$method |> unique()
to_plot |>
filter(dataset == "schraivogel_ground_truth_perturbseq_gene", method == "sceptre_(exact)")
to_plot$dataset |> unique()
fisher_exact$dataset |> unique()
fisher_exact |>
filter(dataset == "schraivogel_enhancer_screen") |>
ggplot(mapping = aes(y = p_value)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
facet_wrap(undercover_grna ~ ., ncol = 3)
to_plot |>
filter(method == "sceptre (exact)") |> head()
to_plot |>
filter(method == "sceptre (exact)") |>
ggplot(mapping = aes(y = p_value)) |> head()
to_plot$dataset |> unique()
library(katlabutils)
library(tidyverse)
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
replace_slash_w_underscore <- function(df) {
df |> dplyr::mutate(dataset = gsub(pattern = "/",
replacement = "_",
fixed = TRUE,
x = dataset))
}
funct_script <- paste0(.get_config_path("LOCAL_CODE_DIR"), "sceptre2-manuscript/writeups/undercover_results_eda/analyze_undercover_results_plot_functs.R")
source(funct_script)
# 1. positive control results
pc_res <- readRDS(paste0(result_dir,
"positive_control_analysis/pc_results.rds"))
# 2. Schraivogel enhancer screen (SCEPTRE exact)
schraiv_sceptre_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/sceptre_debug_bigB_schraiv.rds")) |>
mutate(method = "sceptre (exact)") |>
replace_slash_w_underscore()
# 3. Schraivogel enhancer screen results
schraiv_other <- readRDS(paste0(result_dir,
"undercover_grna_analysis/undercover_result_grp_size_1.rds")) |>
select(-clock_time, -max_ram) |>
replace_slash_w_underscore() |>
filter(dataset %in% c("schraivogel_enhancer_screen_chr11_gene",
"schraivogel_enhancer_screen_chr8_gene"))
# 4. sample size df
sample_size_df <- readRDS(paste0(result_dir,
"dataset_sample_sizes/n_nonzero_cells_per_grna.rds")) |>
dplyr::mutate(dataset = dataset_concat,
dataset_concat = NULL, paper = NULL, modality = NULL) |>
dplyr::rename(grna_group = target, response_id = feature_id) |>
dplyr::filter(dataset %in% c("schraivogel/enhancer_screen_chr11/gene",
"schraivogel/enhancer_screen_chr8/gene")) |>
replace_slash_w_underscore()
sample_size_df_nt <- sample_size_df |>
filter(grna_group == "non-targeting")
sample_size_df_t <- sample_size_df |>
filter(grna_group != "non-targeting")
ntc_effective_samp_size <- sample_size_df_nt |>
group_by(response_id, dataset) |>
summarize(effective_samp_size = sum(n_nonzero_cells))
sample_size_df_nt <- left_join(x = sample_size_df_nt,
y = ntc_effective_samp_size,
by = c("response_id", "dataset")) |>
mutate(n_nonzero_treatment = n_nonzero_cells,
n_nonzero_control = effective_samp_size - n_nonzero_cells) |>
rename("undercover_grna" = "grna_id")
x <- pc_res |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
update_dataset_names() |>
filter(method %in% c("fisher_exact",
"seurat_de",
"weissman_method",
"sceptre"),
dataset %in% c("papalexi_eccite_screen_protein",
"schraivogel_enhancer_screen",
"papalexi_eccite_screen_gene",
"frangieh_co_culture_gene",
"frangieh_control_gene",
"frangieh_ifn_gamma_gene"))
x |>
compute_n_bonf_rejected() |>
make_n_rejected_pairs_plot(log_trans = FALSE, scales = "free")
x |>
filter(dataset == "papalexi_eccite_screen_protein")
sample_size_df_nt |>
ggplot(mapping = aes(x = n_nonzero_treatment)) +
geom_histogram(bins = 15, fill = "white", col = "black") +
theme_bw()
sample_size_df_nt |>
filter(n_nonzero_treatment == 0) |>
nrow()
n_pass_qc <- sample_size_df_nt |>
filter(n_nonzero_treatment >= 7, n_nonzero_control >= 30) |>
nrow()
n_total <- sample_size_df_nt |> nrow()
n_pass_qc/n_total
to_plot <- rbind(schraiv_sceptre_exact, schraiv_other) |>
left_join(y = sample_size_df_nt, by = c("response_id", "undercover_grna", "dataset")) |>
update_dataset_names()
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method")) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
to_plot$dataset |> unique()
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method"),
dataset == "schraivogel_enhancer_screen_chr8_gene") |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method"),
dataset == "schraivogel_enhancer_screen_chr11_gene") |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
to_plot |>
filter(method == "sceptre (exact)") |>
ggplot(mapping = aes(y = p_value)) +
facet_wrap(undercover_grna ~ .) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
head(to_plot)
to_plot |>
filter(method == "seurat_de") |>
ggplot(mapping = aes(y = p_value)) +
facet_wrap(undercover_grna ~ ., ncol = 4) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
paste0(result_dir,
"undercover_grna_analysis")
fisher_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/fisher_exact_1.rds"))
head(fisher_exact)
fisher_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/fisher_exact_1.rds")) |>
replace_dataset_underscore_with_slash()
head(fisher_exact$dataset)
unique(fisher_exact$dataset)
fisher_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/fisher_exact_1.rds")) |>
replace_dataset_underscore_with_slash() |>
filter(dataset == "schraivogel/ground_truth_perturbseq/gene")
fisher_exact <- readRDS(paste0(result_dir,
"undercover_grna_analysis/fisher_exact_1.rds")) |>
filter(dataset == "schraivogel/ground_truth_perturbseq/gene")
head(fisher_exact)
fisher_exact |>
ggplot(mapping = aes(y = p_value)) +
facet_wrap(undercover_grna ~ ., ncol = 4) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
head(to_plot)
to_plot |>
filter(method == "sceptre (exact)") |>
ggplot(mapping = aes(y = p_value)) +
facet_wrap(undercover_grna ~ ., ncol = 4) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p <- to_plot |>
filter(method %in% c("sceptre (exact)",
"schraivogel_method",
"seurat_de",
"weissman_method",
"liscovitch_method"),
n_nonzero_treatment >= 7,
n_nonzero_control >= 30) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
geom_abline(col = "darkred") +
stat_qq_band() +
theme_bw() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected quantile", y = "Observed quantile") +
theme(legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank())
p
