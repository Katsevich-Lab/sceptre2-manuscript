---
title: 'Debugging `sceptre` 8: Schraivogel enhancer screen data and positive controls'
author: "Tim"
date: "2022-11-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the eight installment of the debugging `sceptre` series. I explore two questions:

1. What do the SCEPTRE (exact) results look like on the positive control data?
2. What does the calibration of SCEPTRE (exact) look like on the Schraivogel enhancer screen data (with and without QC)?

In both cases I compare SCEPTRE (exact) to competitors.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(katlabutils)
library(tidyverse)
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")

replace_slash_w_underscore <- function(df) {
  df |> dplyr::mutate(dataset = gsub(pattern = "/",
                                replacement = "_",
                                fixed = TRUE,
                                x = dataset))
}

funct_script <- paste0(.get_config_path("LOCAL_CODE_DIR"), "sceptre2-manuscript/writeups/undercover_results_eda/analyze_undercover_results_plot_functs.R")
source(funct_script)

# 1. positive control results
pc_res <- readRDS(paste0(result_dir,
                         "positive_control_analysis/pc_results.rds"))

# 2. Schraivogel enhancer screen (SCEPTRE exact)
schraiv_sceptre_exact <- readRDS(paste0(result_dir,
                                 "undercover_grna_analysis/sceptre_debug_bigB_schraiv.rds")) |>
  mutate(method = "sceptre (exact)") |>
  replace_slash_w_underscore()

# 3. Schraivogel enhancer screen results
schraiv_other <- readRDS(paste0(result_dir,
                                "undercover_grna_analysis/undercover_result_grp_size_1.rds")) |>
  select(-clock_time, -max_ram) |>
  replace_slash_w_underscore() |>
  filter(dataset %in% c("schraivogel_enhancer_screen_chr11_gene",
                        "schraivogel_enhancer_screen_chr8_gene"))

# 4. Fisher exact
fisher_exact <- readRDS(paste0(result_dir,
                                "undercover_grna_analysis/fisher_exact_1.rds")) |>
  filter(dataset == "schraivogel/ground_truth_perturbseq/gene")

# 5. sample size df
sample_size_df <- readRDS(paste0(result_dir,
                                    "dataset_sample_sizes/n_nonzero_cells_per_grna.rds")) |>
  dplyr::mutate(dataset = dataset_concat,
                dataset_concat = NULL, paper = NULL, modality = NULL) |>
  dplyr::rename(grna_group = target, response_id = feature_id) |>
  dplyr::filter(dataset %in% c("schraivogel/enhancer_screen_chr11/gene",
                               "schraivogel/enhancer_screen_chr8/gene")) |>
  replace_slash_w_underscore()

sample_size_df_nt <- sample_size_df |>
  filter(grna_group == "non-targeting")
sample_size_df_t <- sample_size_df |>
  filter(grna_group != "non-targeting")

ntc_effective_samp_size <- sample_size_df_nt |>
  group_by(response_id, dataset) |>
  summarize(effective_samp_size = sum(n_nonzero_cells))

sample_size_df_nt <- left_join(x = sample_size_df_nt,
                            y = ntc_effective_samp_size,
                            by = c("response_id", "dataset")) |>
  mutate(n_nonzero_treatment = n_nonzero_cells,
         n_nonzero_control = effective_samp_size - n_nonzero_cells) |>
  rename("undercover_grna" = "grna_id")
```

## Positive control results

I plot the positive control results of SCEPTRE (exact) alongside those of several competitors.

```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.align = "center"}
x <- pc_res |>
  replace_slash_w_underscore() |>
  combine_schraivogel_enhancer_screens() |>
  update_dataset_names() |>
  filter(method %in% c("fisher_exact",
                       "seurat_de",
                       "weissman_method",
                       "sceptre"),
         dataset %in% c("papalexi_eccite_screen_protein",
                        "schraivogel_enhancer_screen",
                        "papalexi_eccite_screen_gene",
                        "frangieh_co_culture_gene",
                        "frangieh_control_gene",
                        "frangieh_ifn_gamma_gene"))

x |>
  compute_n_bonf_rejected() |>
  make_n_rejected_pairs_plot(log_trans = FALSE, scales = "free")
```

SCEPTRE (exact) is by far the most powerful method on the Frangieh data. In fact, SCEPTRE (exact) exhibits greater power than Seurat DE, despite the fact the SCEPTRE (exact) is much better calibrated than Seurat DE. Weissman method, which is conservative on the negative control data, is even less powerful than Seurat DE. Fisher exact comes in last place, making (for example) only about 75% of the discoveries as SCEPTRE on the Control data.

Next, on the Papalexi data, SCEPTRE (exact) and Seurat DE exhibit similar power, although Seurat DE does make one more discovery than SCEPTRE. Weissman method, which is grossly inflated, makes the greatest number of discoveries. Somewhat surprisingly, Fisher exact and SCEPTRE (exact) make the same number of discoveries. (I had expected Fisher exact to be underpowered, as Fisher exact is calibrated on the Papalexi data despite the fact that it does not adjust for confounders.) Next, all methods yield very small p-values on the Papalexi protein data:

```{r}
x |> 
  filter(dataset == "papalexi_eccite_screen_protein")
```

Finally, SCEPTRE (exact) and Seurat DE are equally powerful on the Schraivogel enhancer screen data, followed by Fisher exact and then by Weissman method. An interesting avenue would be to explore the calibration and power of SCEPTRE (exact) *without* covariates on the Frangieh and (especially) Papalexi data.

## Schraivogel enhancer screen data

Next, I examine the Schraivogel enhancer screen data. First, I make a histogram of the number of nonzero cells per gRNA: 

```{r, echo = FALSE, fig.align = "center", fig.height = 4, fig.width = 5, message=FALSE, warning=FALSE}
sample_size_df_nt |>
  ggplot(mapping = aes(x = n_nonzero_treatment)) +
  geom_histogram(bins = 15, fill = "white", col = "black") +
  theme_bw()
```

Expression levels of course are greater on the Schraivogel enhancer screen data than on the Papalexi and Frangieh data. Only a handful of negative control pairs (34) have zero treatment cells with nonzero expression.

```{r}
sample_size_df_nt |>
  filter(n_nonzero_treatment == 0) |>
  nrow()
```

Meanwhile, about 95% of pairs pass the (somewhat arbitrary) QC threshold have having at least seven treatment cells with nonzero expression and 30 control cells with nonzero expression.

```{r}
n_pass_qc <- sample_size_df_nt |>
  filter(n_nonzero_treatment >= 7, n_nonzero_control >= 30) |>
  nrow()
n_total <- sample_size_df_nt |> nrow()
n_pass_qc/n_total
```

Thus, issues related to sample size likely are less pressing on the Schraivogel enhancer screen data than on the Papalexi and Frangieh data.

Next, I plot the results of five methods on the Schraivogel enhancer screen negative control data: SCEPTRE (exact), Schraivogel method, Seurat DE, Weissman method, and NB regression. I filter for pairs with >= 10 nonzero treatment cells >= 30 nonzero control cells.

```{r, echo=FALSE, fig.align = "center", fig.height = 6, fig.width = 7, message=FALSE, warning=FALSE}
to_plot <- rbind(schraiv_sceptre_exact, schraiv_other) |>
  left_join(y = sample_size_df_nt, by = c("response_id", "undercover_grna", "dataset")) |>
  update_dataset_names()

p <- to_plot |>
  filter(method %in% c("sceptre (exact)",
                       "schraivogel_method",
                       "seurat_de",
                       "weissman_method",
                       "liscovitch_method"),
         n_nonzero_treatment >= 7,
         n_nonzero_control >= 30) |>
  ggplot(mapping = aes(y = p_value, col = Method)) +
   stat_qq_points(ymin = 1e-8, size = 0.8) +
   geom_abline(col = "darkred") +
   stat_qq_band() +
   theme_bw() +
   scale_x_continuous(trans = revlog_trans(10)) +
   scale_y_continuous(trans = revlog_trans(10)) +
   labs(x = "Expected quantile", y = "Observed quantile") +
   theme(legend.position = "bottom",
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())
p
```

Liscovitch method clearly is the worst. The other methods are fairly similar. SCEPTRE (exact) exhibits good calibration up until about 1e-03, at which point SCEPTRE (exact) becomes mildly inflated. I plot the results of SCEPTRE (exact) only, faceting by gRNA.

```{r, echo=FALSE, fig.align = "center", fig.height = 16, fig.width = 8, message=FALSE, warning=FALSE}
# facet the plot by gRNA
to_plot |>
  filter(method == "sceptre (exact)") |>
  ggplot(mapping = aes(y = p_value)) +
  facet_wrap(undercover_grna ~ ., ncol = 4) +
  stat_qq_points(ymin = 1e-8, size = 0.8) +
     stat_qq_band() +
   theme_bw() +
   scale_x_continuous(trans = revlog_trans(10)) +
   scale_y_continuous(trans = revlog_trans(10)) +
   labs(x = "Expected quantile", y = "Observed quantile") +
   theme(legend.position = "bottom",
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())
```

The most inflated gRNA is non-targeting-00022. Interestingly, non-targeting-00022 also poses the greatest difficulty on the Schraivogel perturb-seq dataset. I plot the results of Fisher exact test on the pertub-seq data below, faceting by gRNA.

```{r, echo=FALSE, fig.align = "center", fig.height = 16, fig.width = 8, message=FALSE, warning=FALSE}
fisher_exact |>
  mutate() |>
  ggplot(mapping = aes(y = p_value)) +
  facet_wrap(undercover_grna ~ ., ncol = 4) +
  stat_qq_points(ymin = 1e-8, size = 0.8) +
     stat_qq_band() +
   theme_bw() +
   scale_x_continuous(trans = revlog_trans(10)) +
   scale_y_continuous(trans = revlog_trans(10)) +
   labs(x = "Expected quantile", y = "Observed quantile") +
   theme(legend.position = "bottom",
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())
```

Perhaps this is evidence of off-targeting effects among some gRNAs? At any rate, removing non-targeting-00022 does not change the calibration of the methods too much (not plotted).

# SCEPTRE (exact) power vs. sample size analysis

I investigate the connection between sample size and the power of SCEPTRE (exact). First, I plot p-value vs. N treatment (i.e., the number of cells in the "treatment" group with nonzero expression) on the positive control data. We see that as N treatment gets smaller, the p-values generally get larger (as expected). Operationally defining a "highly significant" p-value as $5 \cdot 10^{-6}$ (which is the minumum p-value that SCEPTRE (exact) can output), we see that the minimum value of N treatment required to produce a high significant p-value on the Frangieh data is roughly 10. (There is, however, an exception: on the Frangieh Control data, a pair with only six treatment cells with nonzero expression yielded a highly significant p-value). We observe smilar trends on the Schraivogel enhancer screen data (although I note that SCEPTRE is midly inflated on this dataset).

A reasonable QC criterion is therefore to filter for pairs that contain at least 10 treatment cells with nonzero expression. 

```{r, echo = FALSE, warning=FALSE, message=FALSE}
datasets_to_study <- c("papalexi_eccite_screen_protein",
                 "schraivogel_enhancer_screen",
                 "papalexi_eccite_screen_gene",
                 "frangieh_co_culture_gene",
                 "frangieh_control_gene",
                 "frangieh_ifn_gamma_gene")

# 1. positive control results
pc_res <- readRDS(paste0(result_dir,
                         "positive_control_analysis/pc_results.rds")) |>
  replace_slash_w_underscore() |>
  combine_schraivogel_enhancer_screens() |>
  update_dataset_names() |>
  filter(method == "sceptre",
         dataset %in% datasets_to_study)

# 2. sample size
sample_size_df <- readRDS(paste0(result_dir,
                                    "dataset_sample_sizes/n_nonzero_cells_per_grna.rds")) |>
  dplyr::mutate(dataset = dataset_concat,
                dataset_concat = NULL, paper = NULL, modality = NULL) |>
  dplyr::rename(grna_group = target, response_id = feature_id) |>
  replace_slash_w_underscore() |>
  combine_schraivogel_enhancer_screens()

control_sample_size_df <- sample_size_df |>
  filter(grna_group == "non-targeting") |>
  group_by(response_id, dataset) |>
  summarize(n_control = sum(n_nonzero_cells))

to_join <- sample_size_df |>
  filter(dataset %in% datasets_to_study,
         grna_group %in% pc_res$grna_group,
         response_id %in% pc_res$response_id) |>
  group_by(grna_group, response_id,
           dataset) |>
  summarize(n_treatment = sum(n_nonzero_cells)) |>
  select(response_id, grna_group, n_treatment, dataset)

pc_res_w_ss <- left_join(x = pc_res,
                         y = to_join,
                         by = c("grna_group", "response_id", "dataset")) |>
  left_join(y = control_sample_size_df, by = c("response_id", "dataset"))
```

```{r, echo = FALSE, fig.align = "center", fig.height = 5, fig.width = 10}
pc_res_w_ss |>
  ggplot(mapping = aes(x = n_treatment, y = p_value)) +
  facet_wrap(dataset_rename_w_pairs ~ ., scales = "free_y") +
  geom_point(cex = 0.8) +
  geom_vline(xintercept = 10, col = "darkred") +
  scale_x_log10() +
  scale_y_continuous(trans = revlog_trans(10)) +
  geom_hline(yintercept = 1e-5, col = "darkblue") +
  theme_bw() +
  xlab("N treatment") +
  ylab("p-value")
```

Next, I plot p-value against the number of control cells with nonzero expression. I color points according to whether the number of treatment cells for that pair (with nonzero expression) exceeds the threshold of 10 (selected above).

```{r, echo = FALSE, fig.align = "center", fig.height = 5, fig.width = 10}
pc_res_w_ss |>
  mutate(n_treatment_big = n_treatment >= 10) |>
  ggplot(mapping = aes(x = n_control, y = p_value, col = n_treatment_big)) +
  facet_wrap(dataset_rename_w_pairs ~ ., scales = "free_y") +
  geom_point(cex = 0.8) +
  scale_x_log10() +
  scale_y_continuous(trans = revlog_trans(10)) +
  geom_hline(yintercept = 1e-5, col = "darkblue") +
  theme_bw() +
  geom_vline(xintercept = 700) +
  xlab("N control") +
  ylab("p-value")
```

We see that only pairs with sufficiently many nonzero control cells (> 700, give or take) reject at a highly significant level. Furthermore, as N nonzero control is highly correlated with N nonzero treatment (see previous writeup), pairs with more than 700 nonzero control cells generally have more than 10 nonzero treatment cells. (The converse also holds.) Given that power likely is driven by N nonzero treatment rather than N nonzero control (as N nonzero treatment typically is much smaller than N nonzero control), I do not see much point in adding a metric based on N nonzero control to the QC criteria. To avoid pathological corner cases, however, it might be a good idea to require that N nonzero control exceed 10 (say).

In conclusion, I propose the following pairwise QC criterion: keep pairs that have at least 10 treatment cells with nonzero expression and 10 control cells with nonzero expression; throw out all others. This pairwise criterion optionally can be applied in conjunction with gene-wise, gRNA-wise, and cell-wise QC. For example, gene-wise and gRNA-wise QC can be applied to remove aberrant genes and gRNAs. In our project we perform minimal gene-wise and gRNA-wise QC, filtering for genes expressed in at least 0.005 of cells and gRNAs expressed in at least 10 cells. Furthermore, we inherit the cell-wise QC carried out by the original authors.

