---
title: "Evaluating several methods on the Schraivogel discovery pairs"
author: "Tim"
date: "2023-04-10"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

I apply several methods to a subset of the Schraivogel discovery pairs: Schraivogel method, Seurat DE, and NB regression. NB regression is applied *without* batch as a covariate. I also apply four variants of SCEPTRE to the data: exact vs. approximate, and with vs. without batch included as a covariate. I notate these four variants as follows: SCEPTRE-exact-with-batch, SCEPTRE-exact-no-batch, SCEPTRE-approximate-with-batch, and SCEPTRE-approximate-no-batch. 

```{r, echo=FALSE}
# load packages
library(ondisc)
library(lowmoi)

# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
                               "data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)

# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
```

I load the SCEPTRE results that Gene generated on the Schraivogel discovery pairs.

```{r}
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
gk_orig_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir,
                                          "schraivogel_schraivogel_chr_8_results.rds"))
```

### Analyzing the pathological pairs

Many of the p-values are small. In fact, about 50\% of the p-values are less than 0.001, which seems a bit strange. Let us randomly sample 5,000 of the pairs for which SCEPTRE produces a p-value below 0.001.

```{r}
pairs_to_analyze <- gk_sceptre_schraivogel_res |>
   dplyr::filter(p_value < 0.001) |>
   dplyr::sample_n(5000) |>
   dplyr::select(response_id, grna_group)
```

I subject these pairs to NB regression, Seurat DE, Schraivogel Method, SCEPTRE-exact-with-batch, SCEPTRE-exact-no-batch, SCEPTRE-approximate-with-batch, and SCEPTRE-approximate-no-batch. These methods (especially Seurat DE and Schraivogel Method) take some time to run.

```{r, echo=FALSE}
# NB regression no batch
fp <- paste0(schraivogel_chr8_result_dir, "nb_discovery_5000.rds")
if (!file.exists(fp)) {
nb_res <- nb_regression_w_covariates(response_odm = response_odm,
                                     grna_odm = grna_odm,
                                     response_grna_group_pairs = pairs_to_analyze)
saveRDS(nb_res, fp)
} else {
  nb_res <- readRDS(fp)
}
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
```


```{r,echo=FALSE}
# Seurat DE
fp <- paste0(schraivogel_chr8_result_dir, "seurat_discovery_5000.rds")
if (!file.exists(fp)) {
  seurat_res <- seurat_de(response_odm = response_odm,
                          grna_odm = grna_odm,
                          response_grna_group_pairs = pairs_to_analyze)
  saveRDS(seurat_res, fp)
} else {
  seurat_res <- readRDS(fp)
}
```


```{r,echo=FALSE}
# Schraivogel method
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
if (!file.exists(fp)) {
  schraivogel_res <- schraivogel_method(response_odm = response_odm,
                                      grna_odm = grna_odm,
                                      response_grna_group_pairs = pairs_to_analyze)
  saveRDS(schraivogel_res, fp)
} else {
  schraivogel_res <- readRDS(fp)
}
```


```{r,echo=FALSE}
# sceptre approximate no batch 
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_no_batch_discovery_5000.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
  sceptre_approximate_no_batch_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = pairs_to_analyze,
                       with_covariates = TRUE,
                       test_stat = "full",
                       print_progress = FALSE)
  saveRDS(sceptre_approximate_no_batch_res, fp)
} else {
  sceptre_approximate_no_batch_res <- readRDS(fp)
}
```


```{r,echo=FALSE}
# sceptre approximate with batch 
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_with_batch_discovery_5000.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
  sceptre_approximate_with_batch_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = pairs_to_analyze,
                       with_covariates = TRUE,
                       test_stat = "full",
                       print_progress = FALSE)
  saveRDS(sceptre_approximate_with_batch_res, fp)
} else {
  sceptre_approximate_with_batch_res <- readRDS(fp)
}
```


```{r,echo=FALSE}
# sceptre exact no batch 
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery_5000.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
  sceptre_exact_no_batch_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = pairs_to_analyze,
                       with_covariates = TRUE,
                       test_stat = "exact_full",
                       print_progress = FALSE)
  saveRDS(sceptre_exact_no_batch_res, fp)
} else {
  sceptre_exact_no_batch_res <- readRDS(fp)
}
```


```{r,echo=FALSE}
# sceptre exact with batch
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_with_batch_discovery_5000.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
  sceptre_exact_with_batch_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = pairs_to_analyze,
                       with_covariates = TRUE,
                       test_stat = "exact_full",
                       print_progress = FALSE)
  saveRDS(sceptre_exact_with_batch_res, fp)
} else {
  sceptre_exact_with_batch_res <- readRDS(fp)
}
```

```{r,echo=FALSE}
nb_res <- nb_res |> dplyr::mutate(method = "nb_reg", spikiness = "medium") 
seurat_res <- seurat_res |> dplyr::mutate(method = "seurat", spikiness = "medium")
schraivogel_res <- schraivogel_res |> dplyr::mutate(method = "schraivogel_method", spikiness = "medium")
sceptre_approximate_no_batch_res <- sceptre_approximate_no_batch_res |> dplyr::mutate(method = "sceptre_approximate_no_batch", spikiness = "medium")
sceptre_approximate_with_batch_res <- sceptre_approximate_with_batch_res |> dplyr::mutate(method = "sceptre_approximate_with_batch", spikiness = "high")
sceptre_exact_no_batch_res <- sceptre_exact_no_batch_res |> dplyr::mutate(method = "sceptre_exact_no_batch", spikiness = "medium")
sceptre_exact_with_batch_res <- sceptre_exact_with_batch_res |> dplyr::mutate(method = "sceptre_exact_with_batch", spikiness = "low")
combined_res <- rbind(nb_res, seurat_res, schraivogel_res,
                      sceptre_approximate_with_batch_res,
                      sceptre_approximate_no_batch_res,
                      sceptre_exact_no_batch_res,
                      sceptre_exact_with_batch_res)
```

I plot a histogram of the p-values outputted by each method. I color the histogram by "degree of spikiness" (as determined by me): high, medium, or low. SCEPTRE-approximate-with-batch is the spikiest near zero. Next, NB regression, SCEPTRE-approximate-no-batch, SCEPTRE-exact-no-batch, Schraivogel Method, and Seurat exhibit intermediate spikiness. Finally, SCEPTRE-exact-with-batch shows a low degree of spikiness. It is kind of remarkable how different the various instances of SCEPTRE are.

```{r}
ggplot(combined_res, mapping = aes(x = p_value, fill = spikiness)) +
  facet_wrap(.~method, scales = "free_y", nrow = 4) +
  geom_histogram(bins = 40, col = "black")
```

SCEPTRE-approximate-with-batch likely is pathological. NB regression, SCEPTRE-approximate-no-batch, SCEPTRE-exact-no-batch, Schraivogel Method, and Seurat produce roughly similar p-value distributions. Meanwhile, SCEPTRE-exact-with-batch is more uniform. SCEPTRE-exact-with-batch is the only method that attempts to adjust for batch effects. This likely explains why it produces a different output than the other methods.

### Analyzing the entire discovery set

I now apply SCEPTRE-exact-no-batch and SCEPTRE-exact-with-batch to the entire Schraivogel discovery set. I compare to the Schraivogel Method results.

```{r, echo=FALSE}
all_pairs <- gk_sceptre_schraivogel_res |> dplyr::select(response_id, grna_group)

fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
  sceptre_exact_no_batch_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = all_pairs,
                       with_covariates = TRUE,
                       test_stat = "exact_full",
                       print_progress = TRUE)
  saveRDS(sceptre_exact_no_batch_res, fp)
} else {
  sceptre_exact_no_batch_res <- readRDS(fp)
}
```

First,

```{r}

```

SCEPTRE-exact-no-batch appears to have moderate spikiness near zero.

```{r}
ggplot(data = sceptre_exact_no_batch_res, mapping = aes(x = p_value)) +
  geom_histogram(bins = 40, fill = "white", col = "black") + theme_bw()
```



```{r}
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_with_batch_discovery.rds")
if (!file.exists(fp)) {
  response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
  sceptre_exact_with_batch_res <- sceptre(response_odm = response_odm,
                       grna_odm = grna_odm,
                       response_grna_group_pairs = all_pairs,
                       with_covariates = TRUE,
                       test_stat = "exact_full",
                       print_progress = TRUE)
  saveRDS(sceptre_exact_with_batch_res, fp)
} else {
  sceptre_exact_with_batch_res <- readRDS(fp)
}
```


compare <- dplyr::left_join(x = schraivogel_res |> dplyr::select(response_id, grna_group, p_value),
                 y = gk_orig_schraivogel_res |> dplyr::select(response_id, grna_group, p_value = pvalue),
                 by = c("response_id", "grna_group"),
                 suffix = c("_tim", "_orig"))
