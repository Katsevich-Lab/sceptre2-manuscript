# load packages
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
# load packages
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_discovery_5000.rds")
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "nb_discovery_5000.rds")
if (!file.exists(fp)) {
nb_res <- nb_regression_w_covariates(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(nb_res, fp)
} else {
nb_res <- readRDS(fp)
}
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
pairs_to_analyze
library(lowmoi)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_with_batch_discovery_5000.rds")
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_with_batch_discovery_5000.rds")
!file.exists(fp)
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
sceptre_approximate_with_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "full",
print_progress = FALSE)
saveRDS(sceptre_approximate_with_batch_res, fp)
sceptre_approximate_with_batch_res
hist(sceptre_approximate_with_batch_res$p_value)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_no_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_approximate_no_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "full",
print_progress = FALSE)
saveRDS(sceptre_approximate_no_batch_res, fp)
} else {
sceptre_approximate_no_batch_res <- readRDS(fp)
}
sceptre_approximate_no_batch_res$p_value |> hist()
# sceptre exact no batch
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_exact_no_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "full",
print_progress = FALSE)
saveRDS(sceptre_exact_no_batch_res, fp)
} else {
sceptre_exact_no_batch_res <- readRDS(fp)
}
hist(sceptre_exact_no_batch_res$p_value)
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_exact_no_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_no_batch_res, fp)
hist(sceptre_exact_no_batch_res$p_value)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_with_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_exact_with_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_with_batch_res, fp)
} else {
sceptre_exact_with_batch_res <- readRDS(fp)
}
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_with_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
sceptre_exact_with_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_with_batch_res, fp)
} else {
sceptre_exact_with_batch_res <- readRDS(fp)
}
hist(sceptre_exact_with_batch_res$p_value)
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
if (!file.exists(fp)) {
schraivogel_res <- schraivogel_method(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(schraivogel_res, fp)
} else {
schraivogel_res <- readRDS(fp)
}
schraivogel_res
hist(schraivogel_res$p_value)
