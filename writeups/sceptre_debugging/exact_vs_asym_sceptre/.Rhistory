sceptre_approximate_no_batch_res,
sceptre_exact_no_batch_res,
sceptre_exact_with_batch_res)
ggplot(combined_res, mapping = aes(x = p_value)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40)
ggplot(combined_res, mapping = aes(x = p_value)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40, fill = spikiness)
nb_res <- nb_res |> dplyr::mutate(method = "nb_reg", spikiness = "medium")
seurat_res <- seurat_res |> dplyr::mutate(method = "seurat", spikiness = "medium")
schraivogel_res <- schraivogel_res |> dplyr::mutate(method = "schraivogel_res", spikiness = "medium")
sceptre_approximate_no_batch_res <- sceptre_approximate_no_batch_res |> dplyr::mutate(method = "sceptre_approximate_no_batch", spikiness = "medium")
sceptre_approximate_with_batch_res <- sceptre_approximate_with_batch_res |> dplyr::mutate(method = "sceptre_approximate_with_batch", spikiness = "high")
sceptre_exact_no_batch_res <- sceptre_exact_no_batch_res |> dplyr::mutate(method = "sceptre_exact_no_batch", spikiness = "medium")
sceptre_exact_with_batch_res <- sceptre_exact_with_batch_res |> dplyr::mutate(method = "sceptre_exact_with_batch", spikiness = "low")
combined_res <- rbind(nb_res, seurat_res, schraivogel_res,
sceptre_approximate_with_batch_res,
sceptre_approximate_no_batch_res,
sceptre_exact_no_batch_res,
sceptre_exact_with_batch_res)
ggplot(combined_res, mapping = aes(x = p_value)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40, fill = spikiness)
ggplot(combined_res, mapping = aes(x = p_value, fill = spikiness)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40)
ggplot(combined_res, mapping = aes(x = p_value, fill = spikiness)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40, col = "black")
ggplot(combined_res, mapping = aes(x = p_value, fill = spikiness)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40, col = "black")
plot(seurat_res$p_value, schraivogel_res$p_value)
plot(-log(seurat_res$p_value, base = 10),
-log(schraivogel_res$p_value, base = 10))
plot(-log(nb_res$p_value, base = 10),
-log(schraivogel_res$p_value, base = 10))
plot(nb_res$p_value, schraivogel_res$p_value)
plot(sceptre_exact_no_batch_res$p_value, schraivogel_res$p_value)
plot(sceptre_exact_no_batch_res$p_value, schraivogel_res$p_value)
plot(sceptre_exact_no_batch_res$p_value, sceptre_approximate_no_batch_res$p_value)
plot(sceptre_exact_no_batch_res$p_value, sceptre_exact_with_batch_res$p_value)
head(nb_res)
head(schraivogel_res)
ehad(combined_res)
head(combined_res)
knitr::opts_chunk$set(echo = TRUE)
# load packages
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
head(gk_sceptre_schraivogel_res)
head(gk_sceptre_schraivogel_res)
all_pairs <- gk_sceptre_schraivogel_res |> dplyr::select(response_id, grna_group)
all_pairs <- gk_sceptre_schraivogel_res |> dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery_5000.rds")
10
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery.rds")
file.exists(fp)
all_pairs <- gk_sceptre_schraivogel_res |> dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_exact_no_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = all_pairs,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_no_batch_res, fp)
} else {
sceptre_exact_no_batch_res <- readRDS(fp)
}
all_pairs <- gk_sceptre_schraivogel_res |> dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_exact_no_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = all_pairs,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = TRUE)
saveRDS(sceptre_exact_no_batch_res, fp)
} else {
sceptre_exact_no_batch_res <- readRDS(fp)
}
head(sceptre_exact_no_batch_res)
plot(sceptre_exact_no_batch_res$p_value)
hist(sceptre_exact_no_batch_res$p_value)
head(sceptre_exact_no_batch_res)
head(sceptre_exact_no_batch_res)
ggplot(data = sceptre_exact_no_batch_res, mapping = aes(x = p_value)) +
geom_histogram() + theme_bw()
ggplot(data = sceptre_exact_no_batch_res, mapping = aes(x = p_value)) +
geom_histogram(bins = 40, fill = "white", col = "black") + theme_bw()
gk_orig_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir,
"schraivogel_schraivogel_chr_8_results.rds"))
head(gk_orig_schraivogel_res)
tail(gk_orig_schraivogel_res)
hist(gk_orig_schraivogel_res$pvalue)
nrow(gk_orig_schraivogel_res)
schraivogel_res |> nrow()
head(schraivogel_res)
dplyr::left_join(x = schraivogel_res |> dplyr::select(response_id, grna_group, p_value)),
dplyr::left_join(x = schraivogel_res |> dplyr::select(response_id, grna_group, p_value),
y = gk_orig_schraivogel_res |> dplyr::select(response_id, grna_group, p_value = pvalue),
by = c("response_id", "grna_group"),
suffix = c("my_", "orig_"))
compare <- dplyr::left_join(x = schraivogel_res |> dplyr::select(response_id, grna_group, p_value),
y = gk_orig_schraivogel_res |> dplyr::select(response_id, grna_group, p_value = pvalue),
by = c("response_id", "grna_group"),
suffix = c("my_", "orig_"))
compare <- dplyr::left_join(x = schraivogel_res |> dplyr::select(response_id, grna_group, p_value),
y = gk_orig_schraivogel_res |> dplyr::select(response_id, grna_group, p_value = pvalue),
by = c("response_id", "grna_group"),
suffix = c("_tim", "_orig"))
plot(compare$p_value_tim, compare$p_value_orig)
# load packages
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
orig_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir,
"schraivogel_schraivogel_chr_8_results.rds"))
orig_schraivogel_res
# load packages
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
orig_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir,
"schraivogel_schraivogel_chr_8_results.rds"))
pairs_to_analyze <- data.frame(response_id = "PTDSS1",
grna_group = "chr8:97842054-97842529")
pairs_to_analyze
orig_schraivogel_res
schraivogel_res <- schraivogel_method(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
schraivogel_res
orig_schraivogel_res
orig_schraivogel_res |> dplyr::filter(response_id == pairs_to_analyze$response_id,
grna_group == pairs_to_analyze$grna_group)
schraivogel_method(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
###################################
# LOAD ORIGINAL SSCHRAIVOGEL RESULT
###################################
orig_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "schraivogel_schraivogel_chr_8_results.rds"))
pairs_to_analyze <- data.frame(response_id = "PTDSS1",
grna_group = "chr8:97842054-97842529")
schraivogel_res_tim <- schraivogel_method(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
schraivogel_res_orig |> dplyr::filter(response_id == pairs_to_analyze$response_id,
grna_group == pairs_to_analyze$grna_group)
orig_schraivogel_res |> dplyr::filter(response_id == pairs_to_analyze$response_id,
grna_group == pairs_to_analyze$grna_group)
schraivogel_res_tim
response_odm
grna_odm
head(pairs_to_analyze)
# load packages
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
gk_orig_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir,
"schraivogel_schraivogel_chr_8_results.rds"))
pairs_to_analyze <- gk_sceptre_schraivogel_res |>
dplyr::filter(p_value < 0.001) |>
dplyr::sample_n(5000) |>
dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "nb_discovery_5000.rds")
if (!file.exists(fp)) {
nb_res <- nb_regression_w_covariates(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(nb_res, fp)
} else {
nb_res <- readRDS(fp)
}
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
fp <- paste0(schraivogel_chr8_result_dir, "seurat_discovery_5000.rds")
if (!file.exists(fp)) {
seurat_res <- seurat_de(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(seurat_res, fp)
} else {
seurat_res <- readRDS(fp)
}
fp <- paste0(schraivogel_chr8_result_dir, "nb_discovery_5000.rds")
if (!file.exists(fp)) {
nb_res <- nb_regression_w_covariates(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(nb_res, fp)
} else {
nb_res <- readRDS(fp)
}
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
head(gk_sceptre_schraivogel_res)
gk_orig_schraivogel_res |> head()
gk_orig_schraivogel_res$pvalue |> hist()
gk_orig_schraivogel_res |> dplyr::mutate(pair = paste0(response_id, grna_group)) |> head()
head(pairs_to_analyze)
paste0(pairs_to_analyze$response_id, pairs_to_analyze$grna_group)
gk_orig_schraivogel_res |>
dplyr::mutate(pair = paste0(response_id, grna_group)) |>
dplyr::filter(pair %in% paste0(pairs_to_analyze$response_id, pairs_to_analyze$grna_group))
gk_orig_schraivogel_res |>
dplyr::mutate(pair = paste0(response_id, grna_group)) |>
dplyr::filter(pair %in% paste0(pairs_to_analyze$response_id, pairs_to_analyze$grna_group)) |>
dplyr::select(response_id, grna_group, p_value = pvalue)
gk_orig_schraivogel_res |>
dplyr::mutate(pair = paste0(response_id, grna_group)) |>
dplyr::filter(pair %in% paste0(pairs_to_analyze$response_id, pairs_to_analyze$grna_group)) |>
dplyr::select(response_id, grna_group, p_value = pvalue)
schraivogel_res <- gk_orig_schraivogel_res |>
dplyr::mutate(pair = paste0(response_id, grna_group)) |>
dplyr::filter(pair %in% paste0(pairs_to_analyze$response_id, pairs_to_analyze$grna_group)) |>
dplyr::select(response_id, grna_group, p_value = pvalue)
head(schraivogel_res <- gk_orig_schraivogel_res |>
dplyr::mutate(pair = paste0(response_id, grna_group)) |>
dplyr::filter(pair %in% paste0(pairs_to_analyze$response_id, pairs_to_analyze$grna_group)) |>
dplyr::select(response_id, grna_group, p_value = pvalue))
head(schraivogel_res)
hist(schraivogel_res)
hist(schraivogel_res$p_value)
knitr::opts_chunk$set(echo = TRUE)
# load packages
library(ondisc)
library(lowmoi)
# load data
LOCAL_SCEPTRE2_DATA_DIR <-.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
schraivogel_chr8_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR,
"data/schraivogel/enhancer_screen_chr8/")
# response info
response_odm_fp <- paste0(schraivogel_chr8_dir, "gene/matrix.odm")
response_metadata_fp <- paste0(schraivogel_chr8_dir, "gene/metadata_qc.rds")
response_odm <- read_odm(odm_fp = response_odm_fp, metadata_fp = response_metadata_fp)
# grna info
grna_odm_fp <- paste0(schraivogel_chr8_dir, "grna_expression/matrix.odm")
grna_metadata_fp <- paste0(schraivogel_chr8_dir, "grna_expression/metadata_qc.rds")
grna_odm <- read_odm(odm_fp = grna_odm_fp, metadata_fp = grna_metadata_fp)
schraivogel_chr8_result_dir <- paste0(LOCAL_SCEPTRE2_DATA_DIR, "results/schraivogel_analysis/")
gk_sceptre_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir, "sceptre_schraivogel_chr_8_results.rds"))
gk_orig_schraivogel_res <- readRDS(paste0(schraivogel_chr8_result_dir,
"schraivogel_schraivogel_chr_8_results.rds"))
pairs_to_analyze <- gk_sceptre_schraivogel_res |>
dplyr::filter(p_value < 0.001) |>
dplyr::sample_n(5000) |>
dplyr::select(response_id, grna_group)
# NB regression no batch
fp <- paste0(schraivogel_chr8_result_dir, "nb_discovery_5000.rds")
if (!file.exists(fp)) {
nb_res <- nb_regression_w_covariates(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(nb_res, fp)
} else {
nb_res <- readRDS(fp)
}
pairs_to_analyze <- nb_res |> dplyr::select(response_id, grna_group)
# Seurat DE
fp <- paste0(schraivogel_chr8_result_dir, "seurat_discovery_5000.rds")
if (!file.exists(fp)) {
seurat_res <- seurat_de(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(seurat_res, fp)
} else {
seurat_res <- readRDS(fp)
}
# Schraivogel method
#fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
#if (!file.exists(fp)) {
#  schraivogel_res <- schraivogel_method(response_odm = response_odm,
#                                      grna_odm = grna_odm,
#                                      response_grna_group_pairs = pairs_to_analyze)
#  saveRDS(schraivogel_res, fp)
#} else {
#  schraivogel_res <- readRDS(fp)
#}
schraivogel_res <- gk_orig_schraivogel_res |>
dplyr::mutate(pair = paste0(response_id, grna_group)) |>
dplyr::filter(pair %in% paste0(pairs_to_analyze$response_id, pairs_to_analyze$grna_group)) |>
dplyr::select(response_id, grna_group, p_value = pvalue)
# sceptre approximate no batch
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_no_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_approximate_no_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "full",
print_progress = FALSE)
saveRDS(sceptre_approximate_no_batch_res, fp)
} else {
sceptre_approximate_no_batch_res <- readRDS(fp)
}
# sceptre approximate with batch
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_approximate_with_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
sceptre_approximate_with_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "full",
print_progress = FALSE)
saveRDS(sceptre_approximate_with_batch_res, fp)
} else {
sceptre_approximate_with_batch_res <- readRDS(fp)
}
# sceptre exact no batch
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_no_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero))
sceptre_exact_no_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_no_batch_res, fp)
} else {
sceptre_exact_no_batch_res <- readRDS(fp)
}
# sceptre exact with batch
fp <- paste0(schraivogel_chr8_result_dir, "sceptre_exact_with_batch_discovery_5000.rds")
if (!file.exists(fp)) {
response_odm@misc$sceptre_formula <- formula(~log(response_n_umis) + log(response_n_nonzero) + batch)
sceptre_exact_with_batch_res <- sceptre(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze,
with_covariates = TRUE,
test_stat = "exact_full",
print_progress = FALSE)
saveRDS(sceptre_exact_with_batch_res, fp)
} else {
sceptre_exact_with_batch_res <- readRDS(fp)
}
nb_res <- nb_res |> dplyr::mutate(method = "nb_reg", spikiness = "medium")
seurat_res <- seurat_res |> dplyr::mutate(method = "seurat", spikiness = "medium")
schraivogel_res <- schraivogel_res |> dplyr::mutate(method = "schraivogel_method", spikiness = "medium")
sceptre_approximate_no_batch_res <- sceptre_approximate_no_batch_res |> dplyr::mutate(method = "sceptre_approximate_no_batch", spikiness = "medium")
sceptre_approximate_with_batch_res <- sceptre_approximate_with_batch_res |> dplyr::mutate(method = "sceptre_approximate_with_batch", spikiness = "high")
sceptre_exact_no_batch_res <- sceptre_exact_no_batch_res |> dplyr::mutate(method = "sceptre_exact_no_batch", spikiness = "medium")
sceptre_exact_with_batch_res <- sceptre_exact_with_batch_res |> dplyr::mutate(method = "sceptre_exact_with_batch", spikiness = "low")
combined_res <- rbind(nb_res, seurat_res, schraivogel_res,
sceptre_approximate_with_batch_res,
sceptre_approximate_no_batch_res,
sceptre_exact_no_batch_res,
sceptre_exact_with_batch_res)
ggplot(combined_res, mapping = aes(x = p_value, fill = spikiness)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40, col = "black")
nb_res <- nb_res |>
dplyr::mutate(method = "nb_reg", spikiness = "medium")
seurat_res <- seurat_res |>
dplyr::mutate(method = "seurat", spikiness = "medium")
schraivogel_res <- schraivogel_res |>
dplyr::mutate(method = "schraivogel_method", spikiness = "low")
sceptre_approximate_no_batch_res <- sceptre_approximate_no_batch_res |>
dplyr::mutate(method = "sceptre_approximate_no_batch", spikiness = "medium")
sceptre_approximate_with_batch_res <- sceptre_approximate_with_batch_res |>
dplyr::mutate(method = "sceptre_approximate_with_batch", spikiness = "high")
sceptre_exact_no_batch_res <- sceptre_exact_no_batch_res |>
dplyr::mutate(method = "sceptre_exact_no_batch", spikiness = "medium")
sceptre_exact_with_batch_res <- sceptre_exact_with_batch_res |>
dplyr::mutate(method = "sceptre_exact_with_batch", spikiness = "low")
combined_res <- rbind(nb_res, seurat_res, schraivogel_res,
sceptre_approximate_with_batch_res,
sceptre_approximate_no_batch_res,
sceptre_exact_no_batch_res,
sceptre_exact_with_batch_res)
ggplot(combined_res, mapping = aes(x = p_value, fill = spikiness)) +
facet_wrap(.~method, scales = "free_y", nrow = 4) +
geom_histogram(bins = 40, col = "black")
seurat_res
seurat_res |> dplyr::arrange(p_value)
seurat_res |> dplyr::arrange(p_value) |> head(20)
head(sceptre_exact_with_batch_res)
head(sceptre_exact_with_batch_res) |> head(40)
head(sceptre_exact_with_batch_res, 40)
head(sceptre_exact_with_batch_res, 100)
head(sceptre_exact_no_batch_res)
head(sceptre_exact_no_batch_res, 40)
head(sceptre_exact_with_batch_res, 40)
head(sceptre_exact_no_batch_res, 40)
sceptre_exact_no_batch_res |> dplyr::filter(response_id == "MRPL13")
sceptre_exact_no_batch_res |> dplyr::filter(response_id == "MRPL13") |> dplyr::pull(p_value)
nrow(sceptre_exact_no_batch_res)
0.1/5000
sceptre_no_batch_mrpl13_p <- sceptre_exact_no_batch_res |> dplyr::filter(response_id == "MRPL13") |> dplyr::pull(p_value)
.1/nrow(sceptre_exact_no_batch_res)
sceptre_no_batch_mrpl13_p < .1/nrow(sceptre_exact_no_batch_res)
sum(sceptre_no_batch_mrpl13_p < .1/nrow(sceptre_exact_no_batch_res))
sceptre_exact_no_batch_res |> dplyr::filter(response_id == "MRPL13") |> dplyr::pull(p_value)
seurat_mrpl13_p <- sceptre_exact_no_batch_res |> dplyr::filter(response_id == "MRPL13") |> dplyr::pull(p_value)
sum(seurat_mrpl13_p < .1/nrow(sceptre_exact_no_batch_res))
sum(sceptre_no_batch_mrpl13_p < .1/nrow(sceptre_exact_no_batch_res))
sum(seurat_mrpl13_p < .1/nrow(sceptre_exact_no_batch_res))
head(sceptre_exact_no_batch_res)
dplyr::left_join(sceptre_exact_no_batch_res, seurat_res, by = c("response_id", "grna_group"), suffix = c("_sceptre_no_batch", "seurat"))
dplyr::left_join(sceptre_exact_no_batch_res, seurat_res, by = c("response_id", "grna_group"), suffix = c("_sceptre_no_batch", "_seurat"))
to_plot <- dplyr::left_join(sceptre_exact_no_batch_res,
seurat_res, by = c("response_id", "grna_group"),
suffix = c("_sceptre_no_batch", "_seurat"))
head(to_plot)
ggplot(data = to_plot, mapping = aes(x =p_value_sceptre_no_batch , y = p_value_seurat)) +
geom_point()
ggplot(data = to_plot, mapping = aes(x =p_value_sceptre_no_batch , y = p_value_seurat)) +
geom_point() + scale_x_continuous(trans = sceptre:::revlog_trans(10)) + scale_y_continuous(trans = sceptre:::revlog_trans(10))
ggplot(data = to_plot, mapping = aes(x =p_value_sceptre_no_batch , y = p_value_seurat)) +
geom_point() + scale_x_continuous(trans = sceptre:::revlog_trans(10)) +
scale_y_continuous(trans = sceptre:::revlog_trans(10)) + geom_abline(slope = 1, intercept = 0, col = "blue")
head(to_plot)
ggplot(data = to_plot |> dplyr::filter(p_value_sceptre_no_batch > 1e-30),
mapping = aes(x =p_value_sceptre_no_batch , y = p_value_seurat)) +
geom_point() + scale_x_continuous(trans = sceptre:::revlog_trans(10)) +
scale_y_continuous(trans = sceptre:::revlog_trans(10)) +
geom_abline(slope = 1, intercept = 0, col = "blue")
head(sceptre_exact_with_batch_res)
sceptre_exact_with_batch_res |> dplyr::filter(response_id == "MRPL13") |> dplyr::pull(p_value)
sceptre_no_batch_mrpl13_p <- sceptre_exact_with_batch_res |> dplyr::filter(response_id == "MRPL13") |> dplyr::pull(p_value)
sum(sceptre_no_batch_mrpl13_p < .1/nrow(sceptre_exact_no_batch_res))
schraivogel_res |>
dplyr::filter(response_id == "MRPL13") |>
dplyr::pull(p_value)
schraivogel_mrpl13_p <- schraivogel_res |>
dplyr::filter(response_id == "MRPL13") |>
dplyr::pull(p_value)
sum(schraivogel_mrpl13_p < .1/nrow(sceptre_exact_no_batch_res))
head(schraivogel_res, 40)
schraivogel_res |> dplyr::filter(p_value)
schraivogel_res |> dplyr::arrange(p_value)
sceptre_exact_with_batch_res |> dplyr::arrange(p_value)
sceptre_exact_with_batch_res |> dplyr::arrange(p_value) |> head(10)
schraivogel_res
# Schraivogel method
fp <- paste0(schraivogel_chr8_result_dir, "schraivogel_method_discovery_5000.rds")
if (!file.exists(fp)) {
schraivogel_res_us <- schraivogel_method(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = pairs_to_analyze)
saveRDS(schraivogel_res_us, fp)
} else {
schraivogel_res_us <- readRDS(fp)
}
schraivogel_res_us
schraivogel_res_us <- schraivogel_res_us |>
dplyr::mutate(method = "schraivogel_method_us", spikiness = "medium")
schraivogel_res_us
schraivogel_res_us
schraivogel_res
to_plot <- rbind(schraivogel_res_us, schraivogel_res)
to_plot
ggplot(to_plot, mapping = aes(x = p_value, fill = spikiness)) +
facet_wrap(.~method, scales = "free_y", nrow = 1) +
geom_histogram(bins = 40, col = "black") + theme_bw()
