library(ondisc)
library(sceptre2)
papalexi_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/papalexi/eccite_screen/")
# gene info
gene_odm_fp <- paste0(papalexi_dir, "gene/matrix.odm")
# grna info
grna_odm_fp <- paste0(papalexi_dir, "grna_assignment/matrix.odm")
# protein info
protein_odm_fp <- paste0(papalexi_dir, "protein/matrix.odm")
# mm odm metadata fp
mm_metadata_fp <- paste0(papalexi_dir, "multimodal_metadata.rds")
# construct mm odm
mm_odm <- read_multimodal_odm(odm_fps = c(gene_odm_fp, grna_odm_fp, protein_odm_fp),
multimodal_metadata_fp = mm_metadata_fp)
# set formulas, grna group target name
gene_formula <- ~ log(gene_n_umis) + log(gene_n_nonzero) + bio_rep + phase + p_mito
protein_formula <- ~ log(protein_n_umis) + bio_rep + phase + p_mito
grna_group <- "target"
# set hyperparameters
B <- 2500000
side <- "both"
max_b_per_batch <- 250000
in_memory <- TRUE
statistic <- "full" # "distilled" is faster but might be less powerful
return_dist <- FALSE
screen_b <- 25000
# randomly select gene-grna group pairs to analyze
gene_grna_group_pairs <- expand.grid(response_id = mm_odm |>
get_modality("gene") |>
get_feature_ids() |>
sample(10),
grna_group = c("BRD4", "IRF1"))
# select protein-grna group pairs to analyze
protein_grna_group_pairs <- expand.grid(response_id = mm_odm |>
get_modality("protein") |>
get_feature_ids(),
grna_group = c("BRD4", "IRF1"))
# analyze the gene data
gene_result <- run_sceptre_low_moi(mm_odm = mm_odm,
response_grna_group_pairs = gene_grna_group_pairs,
form = gene_formula,
response_modality_name = "gene",
grna_modality_name = "grna_assignment",
grna_group_column_name = "target",
B = B,
side = side,
max_b_per_batch = max_b_per_batch,
in_memory = in_memory,
statistic = statistic,
return_dist = return_dist,
screen_b = screen_b)
