plot.margin = margin(t = 5.5, r = 5.5, b = 5.5, l = 5.5, unit = "pt")) +
scale_y_continuous(breaks = seq(1, max(n_bonf_rej$n_reject), by = 2), expand = c(0, 0)) +
ggtitle("")
breaks_v
p_bar <- n_bonf_rej |> ggplot2::ggplot(ggplot2::aes(x = Method, y = n_reject, fill = Method)) +
ggplot2::geom_col(col = "black") +
ylab("N Bonferoni rejections") +
xlab("Method") + my_theme_no_legend +
theme(axis.text.x = element_blank(),
plot.margin = margin(t = 5.5, r = 5.5, b = 5.5, l = 5.5, unit = "pt")) +
scale_y_continuous(breaks = seq(1, max(n_bonf_rej$n_reject), by = 2), expand = c(0, 0)) +
ggtitle("")
get_plots_for_dataset <- function(dataset, tit) {
df_sub <- benchmark_res |> filter(dataset == !!dataset)
p_qq <- ggplot(data = df_sub, mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.85) +
stat_qq_band() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") + my_theme_no_legend +
ggtitle(tit)
n_bonf_rej <- benchmark_res |>
filter(dataset == !!dataset) |>
compute_n_bonf_rejections()
max_reject <- max(n_bonf_rej$n_reject)
breaks_v <-  seq(1, max_reject, by = if (max_reject >= 6) 2 else 1)
p_bar <- n_bonf_rej |> ggplot2::ggplot(ggplot2::aes(x = Method, y = n_reject, fill = Method)) +
ggplot2::geom_col(col = "black") +
ylab("N Bonferoni rejections") +
xlab("Method") + my_theme_no_legend +
theme(axis.text.x = element_blank(),
plot.margin = margin(t = 5.5, r = 5.5, b = 5.5, l = 5.5, unit = "pt")) +
scale_y_continuous(breaks = breaks_v, expand = c(0, 0)) +
ggtitle("")
return(list(p_qq = p_qq, p_bar = p_bar))
}
papa_plots <- get_plots_for_dataset("papalexi_eccite_screen_gene", "Papalexi (gene) neg. controls")
papa_protein_plots <- get_plots_for_dataset("papalexi_eccite_screen_protein", "Papalexi (protein) neg. controls")
ifn_gama_plots <- get_plots_for_dataset("frangieh_ifn_gamma_gene", "Frangieh IFN-\u03B3 neg. controls")
co_culture_plots <- get_plots_for_dataset("frangieh_co_culture_gene", "Frangieh IFN-\u03B3 neg. controls")
fig_top <- cowplot::plot_grid(papa_plots$p_qq, papa_plots$p_bar,
papa_protein_plots$p_qq, papa_protein_plots$p_bar,
ifn_gama_plots$p_qq, ifn_gama_plots$p_bar,
co_culture_plots$p_qq, co_culture_plots$p_bar,
labels = c("a", "", "b", "", "c", "", "d", ""),
rel_widths = c(0.38, 0.12, 0.38, 0.12),
ncol = 4, nrow = 2, align = "h")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_3/r_output.png")
ggsave(filename = to_save_fp, plot = fig_top, device = "png",
scale = 1.2, width = 6.5, height = 4.2, dpi = 330)
########################################################
# PANNELS A-D: SCEPTRE vs. Seurat De on several datasets
########################################################
benchmark_res <- undercover_res |>
filter(method %in% c("sceptre", "seurat_de")) |>
mutate(Method = forcats::fct_recode(Method, "SCEPTRE" = "Sceptre"))
get_plots_for_dataset <- function(dataset, tit) {
df_sub <- benchmark_res |> filter(dataset == !!dataset)
p_qq <- ggplot(data = df_sub, mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.85) +
stat_qq_band() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") + my_theme_no_legend +
ggtitle(tit)
n_bonf_rej <- benchmark_res |>
filter(dataset == !!dataset) |>
compute_n_bonf_rejections()
max_reject <- max(n_bonf_rej$n_reject)
breaks_v <-  seq(1, max_reject, by = if (max_reject >= 7) 2 else 1)
p_bar <- n_bonf_rej |> ggplot2::ggplot(ggplot2::aes(x = Method, y = n_reject, fill = Method)) +
ggplot2::geom_col(col = "black") +
ylab("N Bonferoni rejections") +
xlab("Method") + my_theme_no_legend +
theme(axis.text.x = element_blank(),
plot.margin = margin(t = 5.5, r = 5.5, b = 5.5, l = 5.5, unit = "pt")) +
scale_y_continuous(breaks = breaks_v, expand = c(0, 0)) +
ggtitle("")
return(list(p_qq = p_qq, p_bar = p_bar))
}
papa_plots <- get_plots_for_dataset("papalexi_eccite_screen_gene", "Papalexi (gene) neg. controls")
papa_protein_plots <- get_plots_for_dataset("papalexi_eccite_screen_protein", "Papalexi (protein) neg. controls")
ifn_gama_plots <- get_plots_for_dataset("frangieh_ifn_gamma_gene", "Frangieh IFN-\u03B3 neg. controls")
co_culture_plots <- get_plots_for_dataset("frangieh_co_culture_gene", "Frangieh IFN-\u03B3 neg. controls")
fig_top <- cowplot::plot_grid(papa_plots$p_qq, papa_plots$p_bar,
papa_protein_plots$p_qq, papa_protein_plots$p_bar,
ifn_gama_plots$p_qq, ifn_gama_plots$p_bar,
co_culture_plots$p_qq, co_culture_plots$p_bar,
labels = c("a", "", "b", "", "c", "", "d", ""),
rel_widths = c(0.38, 0.12, 0.38, 0.12),
ncol = 4, nrow = 2, align = "h")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_3/r_output.png")
ggsave(filename = to_save_fp, plot = fig_top, device = "png",
scale = 1.2, width = 6.5, height = 4.2, dpi = 330)
p_e <- camp_df |>
filter(dataset == "frangieh_ifn_gamma_gene") |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
stat_qq_band() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.title = element_blank(),
legend.position = c(0.32, 0.75),
legend.margin = margin(t = -0.5, unit='cm')) +
guides(color = guide_legend(
keywidth = 0.0,
keyheight = 0.15,
default.unit = "inch")) +
ggtitle("Frangieh IFN-\u03B3 negative controls")
p_f <- camp_df |>
filter(dataset == "papalexi_eccite_screen_gene") |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.8) +
stat_qq_band() +
scale_x_continuous(trans = revlog_trans(10)) +
scale_y_continuous(trans = revlog_trans(10)) +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.title = element_blank(),
legend.position = c(0.32, 0.75),
legend.margin = margin(t = -0.5, unit='cm')) +
guides(color = guide_legend(
keywidth = 0.0,
keyheight = 0.15,
default.unit = "inch")) +
ggtitle("Papalexi (gene modality) negative controls")
fig_bottom <- cowplot::plot_grid(p_e, p_f, ncol = 2, labels = c("d", "e"))
fig_bottom
########################
# CREATE COMBINED FIGURE
########################
fig_bottom <- cowplot::plot_grid(fig_top, fig_bottom, nrow = 2, rel_heights = c(2/3, 1/3))
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_3/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.75, height = 7, dpi = 330)
fig_top <- cowplot::plot_grid(papa_plots$p_qq, papa_plots$p_bar,
papa_protein_plots$p_qq, papa_protein_plots$p_bar,
ifn_gama_plots$p_qq, ifn_gama_plots$p_bar,
co_culture_plots$p_qq, co_culture_plots$p_bar,
labels = c("a", "", "b", "", "c", "", "d", ""),
rel_widths = c(0.38, 0.12, 0.38, 0.12),
ncol = 4, nrow = 2, align = "h")
fig_bottom <- cowplot::plot_grid(p_e, p_f, ncol = 2, labels = c("d", "e"))
########################
# CREATE COMBINED FIGURE
########################
fig_bottom <- cowplot::plot_grid(fig_top, fig_bottom, nrow = 2, rel_heights = c(2/3, 1/3))
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_3/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.75, height = 7, dpi = 330)
fig_top
fig_bottom
library(lowmoi)
library(tidyverse)
sceptre2_results_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sample_size_df <- readRDS(paste0(sceptre2_results_dir, "dataset_sample_sizes/n_nonzero_cells_per_grna.rds"))
sceptre2_results_dir
head(sample_size_df)
library(lowmoi)
library(tidyverse)
sceptre2_results_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sample_size_df <- readRDS(paste0(sceptre2_results_dir, "dataset_sample_sizes/n_nonzero_cells_per_grna.rds"))
sceptre2_results_dir
head(sample_size_df)
sceptre2_results_dir
sceptre2_results_dir
paste0(sceptre2_results_dir, "positive_control_analysis/")
pc_res <- readRDS(paste0(sceptre2_results_dir, "positive_control_analysis/pc_results.rds"))
head(pc_res)
tail(pc_res)
nrow(pc_res)
head(pc_res)
pc_res
head(sample_size_df)
if ("schraivogel/enhancer_screen_chr11/gene" %in% undercover_res$dataset &&
"schraivogel/enhancer_screen_chr8/gene" %in% undercover_res$dataset) {
x <- undercover_res |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
update_dataset_and_method_names()
} else {
x <- undercover_res |>
replace_slash_w_underscore() |>
update_dataset_and_method_names()
}
x <- pc_res |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
update_dataset_and_method_names()
load_all("~/research_code/lowmoi")
if ("schraivogel/enhancer_screen_chr11/gene" %in% undercover_res$dataset &&
"schraivogel/enhancer_screen_chr8/gene" %in% undercover_res$dataset) {
x <- pc_res |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
update_dataset_and_method_names()
} else {
x <- pc_res |>
replace_slash_w_underscore() |>
update_dataset_and_method_names()
}
pc_res$dataset |> head()
if ("schraivogel/enhancer_screen_chr11/gene" %in% pc_res$dataset &&
"schraivogel/enhancer_screen_chr8/gene" %in% pc_res$dataset) {
x <- pc_res |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
update_dataset_and_method_names()
} else {
x <- pc_res |>
replace_slash_w_underscore() |>
update_dataset_and_method_names()
}
head(x)
x$dataset |> unique()
1/10000
x |> filter(method == "sceptre")
x |> filter(method == "sceptre") |> head()
1/1000
0.1/1000
0.0000008 < 1e-5
head(sample_size_df)
tail(sample_size_df)
nrow(sample_size_df)
head(sample_size_df)
head(pc_res)
head(sample_size_df)
head(pc_res$dataset)
sample_size_df |>
filter(feature_id %in% unique(pc_res$response_id),
target %in% unique(pc_res$grna_group),
dataset_concat %in% unique(pc_res$dataset)) |> head()
sample_size_df_pc <- sample_size_df |>
filter(feature_id %in% unique(pc_res$response_id),
target %in% unique(pc_res$grna_group),
dataset_concat %in% unique(pc_res$dataset)) |>
dplyr::mutate(dataset = dataset_concat,
dataset_concat = NULL, paper = NULL, modality = NULL) |>
dplyr::rename(grna_group = target, response_id = feature_id) |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens()
sample_size_df_pc
#
sample_size_df_pc <- sample_size_df |>
filter(feature_id %in% unique(pc_res$response_id),
dataset_concat %in% unique(pc_res$dataset)) |>
dplyr::mutate(dataset = dataset_concat,
dataset_concat = NULL, paper = NULL, modality = NULL) |>
dplyr::rename(grna_group = target, response_id = feature_id) |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens()
head(sample_size_df_pc)
head(sample_size_df_pc)
sample_size_df_pc |>
dplyr::group_by(grna_group, response_id, dataset) |>
dplyr::summarize(n_treatment = sum(n_nonzero_cells))
control_sample_size_df <- sample_size_df_pc |>
filter(grna_group == "non-targeting") |>
group_by(response_id, dataset) |>
summarize(n_control = sum(n_nonzero_cells))
control_sample_size_df
to_join <- sample_size_df_pc |>
group_by(grna_group, response_id,
dataset) |>
summarize(n_treatment = sum(n_nonzero_cells)) |>
select(response_id, grna_group, n_treatment, dataset)
to_join
ead(pc_res)
head(pc_res)
left_join(x = x,
y = to_join,
by = c("grna_group", "response_id", "dataset"))
left_join(x = x,
y = to_join,
by = c("grna_group", "response_id", "dataset")) |>
left_join(y = control_sample_size_df, by = c("response_id", "dataset"))
pc_res_w_ss <- left_join(x = x,
y = to_join,
by = c("grna_group", "response_id", "dataset")) |>
left_join(y = control_sample_size_df, by = c("response_id", "dataset"))
head(pc_res_w_ss)
load_all()
library(lowmoi)
library(tidyverse)
library(lowmoi)
library(lowmoi)
library(tidyverse)
library(lowmoi)
library(tidyverse)
sceptre2_results_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sample_size_df <- readRDS(paste0(sceptre2_results_dir, "dataset_sample_sizes/n_nonzero_cells_per_grna.rds"))
pc_res <- readRDS(paste0(sceptre2_results_dir, "positive_control_analysis/pc_results.rds"))
sceptre2_results_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sample_size_df <- readRDS(paste0(sceptre2_results_dir, "dataset_sample_sizes/n_nonzero_cells_per_grna.rds"))
pc_res <- readRDS(paste0(sceptre2_results_dir, "positive_control_analysis/pc_results.rds"))
# add sample size info to pc res
pc_res_proc <- process_pc_results(pc_res, sample_size_df)
process_pc_results
library(lowmoi)
library(lowmoi)
library(tidyverse)
sceptre2_results_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sample_size_df <- readRDS(paste0(sceptre2_results_dir, "dataset_sample_sizes/n_nonzero_cells_per_grna.rds"))
# pc results
rm(list = c("resampling_res", "resampling_res_processed"))
pc_res <- readRDS(paste0(sceptre2_results_dir, "positive_control_analysis/pc_results.rds"))
pc_res_processed <- process_pc_result(pc_res, sample_size_df)
head(pc_res_processed)
pc_res_processed$Method |> unique()
sceptre2_results_dir
saveRDS(object = pc_res_processed,
file = paste0(sceptre2_results_dir, "positive_control_analysis/pc_results_processed.rds"))
library(ondisc)
library(sceptre2)
library(microbenchmark)
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/extra_analyses/")
###########################
# STEP 1: SET UP SIMULATION
###########################
# 1. load Papalexi data
response_odm <- lowmoi::load_dataset_modality("papalexi/eccite_screen/gene")
grna_odm <- lowmoi::load_dataset_modality("papalexi/eccite_screen/grna_assignment")
grna_targets <- lowmoi::get_target_assignments_via_max_op(grna_odm)
# 2. get the gRNA group info
my_grna <- "CUL3"
grna_group_info <- sceptre2:::get_grna_group_info(grna_group_assignments = grna_targets,
input_grna_groups = my_grna)
idxs <- c(grna_group_info$grna_specific_idxs[[my_grna]],
grna_group_info$grna_specific_idxs[["non-targeting"]])
orig_x <- c(rep(1, grna_group_info$n_cells_per_grna[[my_grna]]),
rep(0, grna_group_info$n_cells_per_grna[["non-targeting"]]))
# 3. get covariate matrix
covariate_matrix_df <- response_odm |>
get_cell_covariates() |>
dplyr::slice(idxs) |>
dplyr::select(n_nonzero, n_umis, bio_rep, phase, p_mito)
row.names(covariate_matrix_df) <- NULL
Z <- model.matrix(object = formula(~ log(n_nonzero) + log(n_umis) + bio_rep + phase + p_mito),
data = covariate_matrix_df)
colnames(Z) <- c("intercept", "lg_n_nonzero", "lg_n_umis", "bio_rep_d1", "bio_rep_d2", "phase_d1", "phase_d2", "p_mito")
# 4. select gene
set.seed(3)
ex_gene <- response_odm |>
get_feature_covariates() |>
dplyr::arrange(desc(mean_expression)) |>
dplyr::slice(1:100) |>
dplyr::sample_n(1) |>
row.names()
orig_y <- as.numeric(response_odm[[ex_gene, idxs]])
# 5. get the model for y | Z
fit_y_orig <- MASS::glm.nb(formula = orig_y ~ . + 0, data = as.data.frame(Z))
theta <- fit_y_orig$theta
mus_y <- as.numeric(fit_y_orig$fitted.values)
# 6. get the model for x | Z
fit_x <- glm(formula = orig_x ~ . + 0, family = binomial(), data = as.data.frame(Z))
mus_x <- as.numeric(fit_x$fitted.values)
#################################
# STEP 2: RUN SIMULATION FUNCTION
#################################
run_simulation <- function(Y, idx_mat, Z, theta_hypothesized, n_sim = NULL) {
if (is.null(n_sim)) n_sim <- ncol(Y)
sapply(seq(1, n_sim), function(i) {
print(paste0("Running simulation ", i))
y <- Y[,i]
# regress the synthetic Y onto Z
fit <- glm(y ~ Z + 0,
family = MASS::negative.binomial(theta = theta_hypothesized))
# extract z-scores
z_scores <- sceptre2:::run_glm_perm_score_test_with_ingredients(Z = Z,
working_resid = fit$residuals,
w = fit$weights,
index_mat = idx_mat)
z_star <- z_scores[1]
z_null <- z_scores[-1]
z_star
# compute theoretical and empirical p-values
p_theory <- 2 * pnorm(q = -abs(z_star), lower.tail = TRUE)
p_camp <- sceptre2:::compute_empirical_p_value(z_star = z_star, z_null = z_null, "both")
# finally, compute permutation
ts <- apply(X = idx_mat, MARGIN = 2, FUN = function(col) mean(y[col]))
t_star <- ts[1]
t_null <- ts[-1]
p_perm <- sceptre2:::compute_empirical_p_value(t_star, t_null, "both")
c(p_theory = p_theory, p_camp = p_camp, p_perm = p_perm)
}) |> t()
}
##############################################
# STEP 3: GENERATE CORRELATED DATA AND RUN SIM
##############################################
n_sim <- 2000
# y first
Y <- sapply(X = mus_y, FUN = function(mu_y) MASS::rnegbin(n = n_sim, mu = mu_y, theta = theta)) |> t()
# generate x so that x is correlated with z
x <- sapply(X = mus_x, FUN = function(mu_x) rbinom(n = 1, size = 1, prob = mu_x))
x_idx <- which(x == 1)
B <- 100000
x_tilde <- replicate(n = B, expr = sample.int(n = length(x), size = sum(x))) - 1L
######################
# ASSESS RUNNING TIME
######################
# 1. regress y on Z
glm_time <- microbenchmark(fit <- glm(y ~ Z + 0,
family = MASS::negative.binomial(theta = theta)),
times = 30, unit = "s") |> summary()
library(ondisc)
library(sceptre2)
library(microbenchmark)
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/extra_analyses/")
###########################
# STEP 1: SET UP SIMULATION
###########################
# 1. load Papalexi data
response_odm <- lowmoi::load_dataset_modality("papalexi/eccite_screen/gene")
grna_odm <- lowmoi::load_dataset_modality("papalexi/eccite_screen/grna_assignment")
grna_targets <- lowmoi::get_target_assignments_via_max_op(grna_odm)
# 2. get the gRNA group info
my_grna <- "CUL3"
grna_group_info <- sceptre2:::get_grna_group_info(grna_group_assignments = grna_targets,
input_grna_groups = my_grna)
idxs <- c(grna_group_info$grna_specific_idxs[[my_grna]],
grna_group_info$grna_specific_idxs[["non-targeting"]])
orig_x <- c(rep(1, grna_group_info$n_cells_per_grna[[my_grna]]),
rep(0, grna_group_info$n_cells_per_grna[["non-targeting"]]))
# 3. get covariate matrix
covariate_matrix_df <- response_odm |>
get_cell_covariates() |>
dplyr::slice(idxs) |>
dplyr::select(n_nonzero, n_umis, bio_rep, phase, p_mito)
row.names(covariate_matrix_df) <- NULL
Z <- model.matrix(object = formula(~ log(n_nonzero) + log(n_umis) + bio_rep + phase + p_mito),
data = covariate_matrix_df)
colnames(Z) <- c("intercept", "lg_n_nonzero", "lg_n_umis", "bio_rep_d1", "bio_rep_d2", "phase_d1", "phase_d2", "p_mito")
# 4. select gene
set.seed(3)
ex_gene <- response_odm |>
get_feature_covariates() |>
dplyr::arrange(desc(mean_expression)) |>
dplyr::slice(1:100) |>
dplyr::sample_n(1) |>
row.names()
orig_y <- as.numeric(response_odm[[ex_gene, idxs]])
# 5. get the model for y | Z
fit_y_orig <- MASS::glm.nb(formula = orig_y ~ . + 0, data = as.data.frame(Z))
theta <- fit_y_orig$theta
mus_y <- as.numeric(fit_y_orig$fitted.values)
# 6. get the model for x | Z
fit_x <- glm(formula = orig_x ~ . + 0, family = binomial(), data = as.data.frame(Z))
mus_x <- as.numeric(fit_x$fitted.values)
######################
# ASSESS RUNNING TIME
######################
# 1. regress y on Z
glm_time <- microbenchmark(fit <- glm(y ~ Z + 0,
family = MASS::negative.binomial(theta = theta)),
times = 30, unit = "s") |> summary()
##############################################
# STEP 3: GENERATE CORRELATED DATA AND RUN SIM
##############################################
n_sim <- 2000
# y first
Y <- sapply(X = mus_y, FUN = function(mu_y) MASS::rnegbin(n = n_sim, mu = mu_y, theta = theta)) |> t()
# generate x so that x is correlated with z
x <- sapply(X = mus_x, FUN = function(mu_x) rbinom(n = 1, size = 1, prob = mu_x))
x_idx <- which(x == 1)
B <- 100000
x_tilde <- replicate(n = B, expr = sample.int(n = length(x), size = sum(x))) - 1L
idx_mat <- cbind(matrix(x_idx, ncol = 1), x_tilde)
######################
# ASSESS RUNNING TIME
######################
# 1. regress y on Z
glm_time <- microbenchmark(fit <- glm(y ~ Z + 0,
family = MASS::negative.binomial(theta = theta)),
times = 30, unit = "s") |> summary()
######################
# ASSESS RUNNING TIME
######################
y <- Y[,1]
# 1. regress y on Z
glm_time <- microbenchmark(fit <- glm(y ~ Z + 0,
family = MASS::negative.binomial(theta = theta)),
times = 30, unit = "s") |> summary()
# 2. permute x B times
x_idx <- which(x == 1)
B <- 100000
random_idx_time <- microbenchmark(x_tilde <- replicate(n = B, expr = sample.int(n = length(x), size = sum(x))),
times = 5, unit = "s") |> summary()
idx_mat <- cbind(matrix(x_idx, ncol = 1), x_tilde) - 1L
# 3. get null z-scores
z_score_time <- microbenchmark(z_scores <- sceptre2:::run_glm_perm_score_test_with_ingredients(Z = Z,
working_resid = fit$residuals,
w = fit$weights,
index_mat = idx_mat), times = 30, unit = "s") |> summary()
z_star <- z_scores[1]
z_null <- z_scores[-1]
ks.test(z_scores, pnorm)
hist(z_scores)
abline(v = z_star)
p_theoretical <- 2 * pnorm(q = -abs(z_star), lower.tail = TRUE)
p_perm <- sceptre2:::compute_empirical_p_value(z_star = z_star, z_null = z_null, "both")
p_theoretical
p_perm
