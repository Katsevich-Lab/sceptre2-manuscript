for (modality in modality_list) {
save_odm(odm = get_modality(multimodal_odm, modality),
metadata_fp = paste0(dataset_dir, "/", modality, "/", metadata_file_name))
}
}
# read
read_multimodal_odm <- function(paper, dataset, sceptre2_data_dir = paste0(sceptre2_offsite_dir, "data/")) {
dataset_dir <- paste0(sceptre2_data_dir, paper, "/", dataset)
modality_vect <- list.files(dataset_dir)
odm_list <- list()
for (modality in modality_vect) {
odm_dir <- paste0(dataset_dir, "/", modality, "/")
curr_odm <- read_odm(odm_fp = paste0(odm_dir, "matrix.odm"),
metadata_fp = paste0(odm_dir, "metadata_orig.rds"))
odm_list <- c(odm_list, curr_odm)
}
names(odm_list) <- modality_vect
ret <- multimodal_ondisc_matrix(odm_list)
return(ret)
}
# 1) Liscovitch
# First, load the chromatin and grna modalities for experiment_small and experiment_big
exp_small_multimodal <- read_multimodal_odm(paper = "liscovitch", dataset = "experiment_small")
exp_big_multimodal <- read_multimodal_odm(paper = "liscovitch", dataset = "experiment_big")
# Second, define the QC function
run_lisc_cell_qc <- function(multimodal_odm, n_gRNA_reads = 100, n_atac_frags = 500, p_reads_one_gRNA_seq) {
gRNA_mod <- get_modality(multimodal_odm, "grna")
assignable <- gRNA_mod[[1:nrow(gRNA_mod),]] |> apply(MARGIN = 2, FUN = function(col) {
max(col)/sum(col) > p_reads_one_gRNA_seq
})
multimodal_odm <- multimodal_odm[,assignable]
high_quality <-  multimodal_odm |>
get_cell_covariates() |>
dplyr::filter(chromatin_n_fragments >= n_atac_frags) |>
dplyr::filter(grna_n_umis >= 100) |> row.names()
multimodal_odm[,high_quality]
}
# next, apply the QC, first to the small experiment and then to the big experiment
experiment_small_multimodal_cell_qc <- run_lisc_cell_qc(experiment_small_multimodal, p_reads_one_gRNA_seq = 0.99)
# next, apply the QC, first to the small experiment and then to the big experiment
experiment_small_multimodal_cell_qc <- run_lisc_cell_qc(exp_small_multimodal, p_reads_one_gRNA_seq = 0.99)
experiment_big_multimodal_cell_qc <- run_lisc_cell_qc(exp_big_multimodal, p_reads_one_gRNA_seq = 0.90)
# save multimodal odms
save_multimodal_odm(experiment_small_multimodal_cell_qc, "liscovitch", "experiment_small", "metadata_cell_qc.rds")
save_multimodal_odm(experiment_big_multimodal_cell_qc, "liscovitch", "experiment_big", "metadata_cell_qc.rds")
# 2) Frangieh
# First, load the co_culture, control, and ifn_gamma multimodal_odms
read_multimodal_odm(paper = "frangieh", dataset = "co_culture")
# 2) Frangieh
# First, load the co_culture, control, and ifn_gamma multimodal_odms
multimodal_odm_list <- list(co_culture = read_multimodal_odm(paper = "frangieh", dataset = "co_culture"),
control = read_multimodal_odm(paper = "frangieh", dataset = "control"),
ifn_gamma = read_multimodal_odm(paper = "frangieh", dataset = "ifn_gamma"))
multimodal_odm_list
multimodal_odm
multimodal_odm
multimodal_odm <- multimodal_odm_list$co_culture
multimodal_odm
multimodal_odm |> get_cell_covariates()
multimodal_odm |> get_cell_covariates() |> head()
multimodal_odm |> get_cell_covariates() |> head() |> dplyr::pull(grna_n_nonzero)
multimodal_odm |> get_cell_covariates() |> dplyr::pull(grna_n_nonzero)
multimodal_odm |> get_cell_covariates() |> dplyr::pull(grna_n_nonzero)|> hist()
multimodal_odm |>
get_cell_covariates() |>
dplyr::pull(grna_n_nonzero)
cellwise_grna_count <- multimodal_odm |>
get_cell_covariates() |>
dplyr::pull(grna_n_nonzero)
head(cellwise_grna_count)
cellwise_grna_count
sum(cellwise_grna_count == 1)
mean(cellwise_grna_count == 1)
multimodal_odm[,cellwise_grna_count == 1]
sum(cellwise_grna_count == 1)
# Second, write the QC function
run_frangieh_cell_qc <- function(multimodal_odm) {
cellwise_grna_count <- multimodal_odm |>
get_cell_covariates() |>
dplyr::pull(grna_n_nonzero)
ret <- multimodal_odm[,cellwise_grna_count == 1]
return(ret)
}
# Second, write the QC function; this function simply restricts attention to cells that have received exactly 1 gRNA.
run_frangieh_cell_qc <- function(multimodal_odm) {
cellwise_grna_count <- multimodal_odm |>
get_cell_covariates() |>
dplyr::pull(grna_n_nonzero)
ret <- multimodal_odm[,cellwise_grna_count == 1]
return(ret)
}
multimodal_odm_list
for (experiment in multimodal_odm_list) {
experiment
}
for (experiment in multimodal_odm_list) {
print(experiment)
}
# Third, apply the QC function to the data
lapply(X = multimodal_odm_list,
FUN = run_frangieh_cell_qc)
# Third, apply the QC function to the data
multimodal_odm_list_qc <- lapply(X = multimodal_odm_list, FUN = run_frangieh_cell_qc)
multimodal_odm_list_qc
length(multimodal_odm_list_qc)
multimodal_odm_list_qc
# Finally, save the multimodal odms
names(multimodal_odm_list_qc)
# Finally, save the multimodal odms
exp_names <- names(multimodal_odm_list_qc)
exp_names
curr_multimodal_odm <- multimodal_odm_list_qc[[exp_name]]
exp_name <- exp_names[1]
exp_name
curr_multimodal_odm <- multimodal_odm_list_qc[[exp_name]]
curr_multimodal_odm
curr_multimodal_odm <- multimodal_odm_list_qc[[exp_name]]
exp_name
for (exp_name in exp_names) {
curr_multimodal_odm <- multimodal_odm_list_qc[[exp_name]]
save_multimodal_odm(multimodal_odm = curr_multimodal_odm,
paper = "frangieh",
dataset = exp_name,
metadata_file_name = "metadata_cell_qc.rds")
}
# set directories
sceptre2_dir <- .get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
# load packages
library(ondisc)
library(ondisc)
# load/create dirs
offsite_dir <- .get_config_path("LOCAL_LISCOVITCH_2021_DATA_DIR")
intermediate_files_dir <- paste0(offsite_dir, "intermediate/")
processed_dir <- paste0(offsite_dir, "processed/")
if (!dir.exists(processed_dir)) dir.create(processed_dir)
experiment_1_dir <- paste0(processed_dir, "experiment_small/")
experiment_2_dir <- paste0(processed_dir, "experiment_big/")
if (!dir.exists(experiment_1_dir)) dir.create(experiment_1_dir)
if (!dir.exists(experiment_2_dir)) dir.create(experiment_2_dir)
experiment_1_dir_chip <- paste0(experiment_1_dir, "chromatin/")
experiment_1_dir_gRNA <- paste0(experiment_1_dir, "gRNA/")
if (!dir.exists(experiment_1_dir_chip)) dir.create(experiment_1_dir_chip)
if (!dir.exists(experiment_1_dir_gRNA)) dir.create(experiment_1_dir_gRNA)
experiment_2_dir_chip <-  paste0(experiment_2_dir, "chromatin/")
experiment_2_dir_gRNA <- paste0(experiment_2_dir, "gRNA/")
if (!dir.exists(experiment_2_dir_chip)) dir.create(experiment_2_dir_chip)
if (!dir.exists(experiment_2_dir_gRNA)) dir.create(experiment_2_dir_gRNA)
# write function to initialize odms
write_m_list <- function(m_list, chip_counts_odm_fp, chip_counts_metadata_fp, gRNA_counts_odm_fp, gRNA_counts_metadata_fp, files_used_in_exp) {
chip_counts <- m_list$atac_count
gRNA_counts <- m_list$gRNA_count
n_fragments <- m_list$fragment_lib_sizes
# initialize the chip counts odm
chip_odm <- create_ondisc_matrix_from_R_matrix(r_matrix = chip_counts,
barcodes = colnames(chip_counts),
features_df = data.frame(row.names(chip_counts)),
odm_fp = chip_counts_odm_fp)
# modify chip metadata; add n_fragments per cell and file_used_in_exp
feat_ids <- chip_odm |> get_feature_ids()
used_in_exp_bool <- feat_ids %in% files_used_in_exp
chip_odm_mod <- chip_odm |> mutate_cell_covariates(n_fragments = n_fragments$n_fragments,
n_nonzero = NULL, n_umis = NULL)
save_odm(odm = chip_odm_mod, metadata_fp = chip_counts_metadata_fp)
# initialize the gRNA odm
gRNA_odm <- create_ondisc_matrix_from_R_matrix(r_matrix = gRNA_counts,
barcodes = colnames(gRNA_counts),
features_df = data.frame(row.names(gRNA_counts)),
odm_fp = gRNA_counts_odm_fp,
metadata_fp = gRNA_counts_metadata_fp)
# add information about target and target_type
gRNA_ids <- gsub(pattern = "non_targeting", replacement = "non-targeting", x = gRNA_odm |> get_feature_ids(), fixed = TRUE)
target <- strsplit(x = gRNA_ids, split = "_", fixed = TRUE) |> sapply(FUN = function(entry) entry[1])
target_type <- ifelse(target %in% c("NT", "non-targeting"), "non-targeting", "gene")
gRNA_odm_mod <- gRNA_odm |> mutate_feature_covariates(target = target, target_type = target_type)
save_odm(odm = gRNA_odm_mod, metadata_fp = gRNA_counts_metadata_fp)
}
# load data for ODM 1, and initialize
m_list <- readRDS(paste0(intermediate_files_dir, "matrix_list_1.rds"))
library(ondisc)
# load/create dirs
offsite_dir <- .get_config_path("LOCAL_LISCOVITCH_2021_DATA_DIR")
intermediate_files_dir <- paste0(offsite_dir, "intermediate/")
processed_dir <- paste0(offsite_dir, "processed/")
if (!dir.exists(processed_dir)) dir.create(processed_dir)
experiment_1_dir <- paste0(processed_dir, "experiment_small/")
experiment_2_dir <- paste0(processed_dir, "experiment_big/")
if (!dir.exists(experiment_1_dir)) dir.create(experiment_1_dir)
if (!dir.exists(experiment_2_dir)) dir.create(experiment_2_dir)
experiment_1_dir_chip <- paste0(experiment_1_dir, "chromatin/")
experiment_1_dir_gRNA <- paste0(experiment_1_dir, "gRNA/")
if (!dir.exists(experiment_1_dir_chip)) dir.create(experiment_1_dir_chip)
if (!dir.exists(experiment_1_dir_gRNA)) dir.create(experiment_1_dir_gRNA)
experiment_2_dir_chip <-  paste0(experiment_2_dir, "chromatin/")
experiment_2_dir_gRNA <- paste0(experiment_2_dir, "gRNA/")
if (!dir.exists(experiment_2_dir_chip)) dir.create(experiment_2_dir_chip)
if (!dir.exists(experiment_2_dir_gRNA)) dir.create(experiment_2_dir_gRNA)
# write function to initialize odms
write_m_list <- function(m_list, chip_counts_odm_fp, chip_counts_metadata_fp, gRNA_counts_odm_fp, gRNA_counts_metadata_fp, files_used_in_exp) {
chip_counts <- m_list$atac_count
gRNA_counts <- m_list$gRNA_count
n_fragments <- m_list$fragment_lib_sizes
# initialize the chip counts odm
chip_odm <- create_ondisc_matrix_from_R_matrix(r_matrix = chip_counts,
barcodes = colnames(chip_counts),
features_df = data.frame(row.names(chip_counts)),
odm_fp = chip_counts_odm_fp)
# modify chip metadata; add n_fragments per cell and file_used_in_exp
feat_ids <- chip_odm |> get_feature_ids()
used_in_exp_bool <- feat_ids %in% files_used_in_exp
chip_odm_mod <- chip_odm |> mutate_cell_covariates(n_fragments = n_fragments$n_fragments,
n_nonzero = NULL, n_umis = NULL)
save_odm(odm = chip_odm_mod, metadata_fp = chip_counts_metadata_fp)
# initialize the gRNA odm
gRNA_odm <- create_ondisc_matrix_from_R_matrix(r_matrix = gRNA_counts,
barcodes = colnames(gRNA_counts),
features_df = data.frame(row.names(gRNA_counts)),
odm_fp = gRNA_counts_odm_fp,
metadata_fp = gRNA_counts_metadata_fp)
# add information about target and target_type
gRNA_ids <- gsub(pattern = "non_targeting", replacement = "non-targeting", x = gRNA_odm |> get_feature_ids(), fixed = TRUE)
target <- strsplit(x = gRNA_ids, split = "_", fixed = TRUE) |> sapply(FUN = function(entry) entry[1])
target_type <- ifelse(target %in% c("NT", "non-targeting"), "non-targeting", "gene")
gRNA_odm_mod <- gRNA_odm |> mutate_feature_covariates(target = target, target_type = target_type)
save_odm(odm = gRNA_odm_mod, metadata_fp = gRNA_counts_metadata_fp)
}
# load data for ODM 1, and initialize
m_list <- readRDS(paste0(intermediate_files_dir, "matrix_list_1.rds"))
chip_counts_odm_fp <- paste0(experiment_1_dir_chip, "chip_counts.odm")
chip_counts_metadata_fp <- paste0(experiment_1_dir_chip, "metadata.rds")
gRNA_counts_odm_fp <- paste0(experiment_1_dir_gRNA, "gRNA_counts.odm")
gRNA_counts_metadata_fp <- paste0(experiment_1_dir_gRNA, "metadata.rds")
files_used_in_exp <- c("H2AZ.broadPeak", "H3K27Ac.broadPeak", "H3K27me3.broadPeak",
"H3K36me3.broadPeak", "H3K4me1.broadPeak", "H3K4me2.broadPeak",
"H3K4me3.broadPeak", "H3K79me2.broadPeak", "H3K9Ac.broadPeak",
"H3K9me1.broadPeak", "H3K9me3.broadPeak", "H4K20me1.broadPeak")
write_m_list(m_list = m_list,
chip_counts_odm_fp = chip_counts_odm_fp,
chip_counts_metadata_fp = chip_counts_metadata_fp,
gRNA_counts_odm_fp = gRNA_counts_odm_fp,
gRNA_counts_metadata_fp = gRNA_counts_metadata_fp,
files_used_in_exp = files_used_in_exp)
# load data for ODM 2, and initialize
m_list <- readRDS(paste0(intermediate_files_dir, "matrix_list_2.rds"))
chip_counts_odm_fp <- paste0(experiment_2_dir_chip, "chip_counts.odm")
chip_counts_metadata_fp <- paste0(experiment_2_dir_chip, "metadata.rds")
gRNA_counts_odm_fp <- paste0(experiment_2_dir_gRNA, "gRNA_counts.odm")
gRNA_counts_metadata_fp <- paste0(experiment_2_dir_gRNA, "metadata.rds")
all_chip_names <- m_list$atac_count |> row.names()
files_used_in_exp_2 <- all_chip_names[!(all_chip_names %in% files_used_in_exp)]
write_m_list(m_list = m_list,
chip_counts_odm_fp = chip_counts_odm_fp,
chip_counts_metadata_fp = chip_counts_metadata_fp,
gRNA_counts_odm_fp = gRNA_counts_odm_fp,
gRNA_counts_metadata_fp = gRNA_counts_metadata_fp,
files_used_in_exp = files_used_in_exp_2)
# set directories
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
papers <- list.files(sceptre2_data_dir)
# load packages
library(ondisc)
# loop over papers
for (paper in papers) {
# loop over datasets
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
for (dataset in datasets) {
# loop over modalities
dataset_dir <- paste0(paper_dir, dataset, "/")
modalities <- list.files(dataset_dir)
for (modality in modalities) {
print(paste0("paper: ", paper, ", dataset: ", dataset, ", modality: ", modality))
modality_dir <- paste0(dataset_dir, modality, "/")
metadata_fp <- paste0(modality_dir, "metadata_cell_qc.rds")
to_save_metadata_fp <- paste0(modality_dir, "metadata_qc.rds")
# if the modality is NOT gRNA... (if it is, then skip; no feature QC on the gRNA matrix for now)
if (modality != "grna") {
odm_fp <- paste0(modality_dir, "matrix.odm")
if (!file.exists(metadata_fp)) metadata_fp <- paste0(modality_dir, "metadata_orig.rds")
# read the odm
odm <- read_odm(odm_fp = odm_fp, metadata_fp = metadata_fp)
highly_exp_feats <- get_highly_expressed_features(odm, frac_expressed = 0.005)
if (nrow(odm) == length(highly_exp_feats)) {
# symbolic link to the current metadata_fp if no subset necessary
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
} else {
# create a new metadata_fp if subset necessary
odm_sub <- odm[highly_exp_feats,]
save_odm(odm = odm_sub, metadata_fp = to_save_metadata_fp)
}
} else {
# the modality IS gRNA; simply create a symbolic link (no qc)
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
}
}
}
}
library(ondisc)
# load/create dirs
offsite_dir <- .get_config_path("LOCAL_LISCOVITCH_2021_DATA_DIR")
intermediate_files_dir <- paste0(offsite_dir, "intermediate/")
processed_dir <- paste0(offsite_dir, "processed/")
if (!dir.exists(processed_dir)) dir.create(processed_dir)
experiment_1_dir <- paste0(processed_dir, "experiment_small/")
experiment_2_dir <- paste0(processed_dir, "experiment_big/")
if (!dir.exists(experiment_1_dir)) dir.create(experiment_1_dir)
if (!dir.exists(experiment_2_dir)) dir.create(experiment_2_dir)
experiment_1_dir_chip <- paste0(experiment_1_dir, "chromatin/")
experiment_1_dir_gRNA <- paste0(experiment_1_dir, "gRNA/")
if (!dir.exists(experiment_1_dir_chip)) dir.create(experiment_1_dir_chip)
if (!dir.exists(experiment_1_dir_gRNA)) dir.create(experiment_1_dir_gRNA)
experiment_2_dir_chip <-  paste0(experiment_2_dir, "chromatin/")
experiment_2_dir_gRNA <- paste0(experiment_2_dir, "gRNA/")
if (!dir.exists(experiment_2_dir_chip)) dir.create(experiment_2_dir_chip)
if (!dir.exists(experiment_2_dir_gRNA)) dir.create(experiment_2_dir_gRNA)
# write function to initialize odms
write_m_list <- function(m_list, chip_counts_odm_fp, chip_counts_metadata_fp, gRNA_counts_odm_fp, gRNA_counts_metadata_fp, files_used_in_exp) {
chip_counts <- m_list$atac_count
gRNA_counts <- m_list$gRNA_count
n_fragments <- m_list$fragment_lib_sizes
# initialize the chip counts odm
chip_odm <- create_ondisc_matrix_from_R_matrix(r_matrix = chip_counts,
barcodes = colnames(chip_counts),
features_df = data.frame(row.names(chip_counts)),
odm_fp = chip_counts_odm_fp)
# modify chip metadata; add n_fragments per cell and file_used_in_exp
feat_ids <- chip_odm |> get_feature_ids()
used_in_exp_bool <- feat_ids %in% files_used_in_exp
chip_odm_mod <- chip_odm |> mutate_cell_covariates(n_fragments = n_fragments$n_fragments,
n_nonzero = NULL, n_umis = NULL)
save_odm(odm = chip_odm_mod, metadata_fp = chip_counts_metadata_fp)
# initialize the gRNA odm
gRNA_odm <- create_ondisc_matrix_from_R_matrix(r_matrix = gRNA_counts,
barcodes = colnames(gRNA_counts),
features_df = data.frame(row.names(gRNA_counts)),
odm_fp = gRNA_counts_odm_fp,
metadata_fp = gRNA_counts_metadata_fp)
# add information about target and target_type
gRNA_ids <- gsub(pattern = "non_targeting", replacement = "non-targeting", x = gRNA_odm |> get_feature_ids(), fixed = TRUE)
target <- strsplit(x = gRNA_ids, split = "_", fixed = TRUE) |> sapply(FUN = function(entry) entry[1])
target_type <- ifelse(target %in% c("NT", "non-targeting"), "non-targeting", "gene")
gRNA_odm_mod <- gRNA_odm |> mutate_feature_covariates(target = target, target_type = target_type)
save_odm(odm = gRNA_odm_mod, metadata_fp = gRNA_counts_metadata_fp)
}
# load data for ODM 1, and initialize
m_list <- readRDS(paste0(intermediate_files_dir, "matrix_list_1.rds"))
chip_counts_odm_fp <- paste0(experiment_1_dir_chip, "chip_counts.odm")
chip_counts_metadata_fp <- paste0(experiment_1_dir_chip, "metadata.rds")
gRNA_counts_odm_fp <- paste0(experiment_1_dir_gRNA, "gRNA_counts.odm")
gRNA_counts_metadata_fp <- paste0(experiment_1_dir_gRNA, "metadata.rds")
files_used_in_exp <- c("H2AZ.broadPeak", "H3K27Ac.broadPeak", "H3K27me3.broadPeak",
"H3K36me3.broadPeak", "H3K4me1.broadPeak", "H3K4me2.broadPeak",
"H3K4me3.broadPeak", "H3K79me2.broadPeak", "H3K9Ac.broadPeak",
"H3K9me1.broadPeak", "H3K9me3.broadPeak", "H4K20me1.broadPeak")
write_m_list(m_list = m_list,
chip_counts_odm_fp = chip_counts_odm_fp,
chip_counts_metadata_fp = chip_counts_metadata_fp,
gRNA_counts_odm_fp = gRNA_counts_odm_fp,
gRNA_counts_metadata_fp = gRNA_counts_metadata_fp,
files_used_in_exp = files_used_in_exp)
# load data for ODM 2, and initialize
m_list <- readRDS(paste0(intermediate_files_dir, "matrix_list_2.rds"))
chip_counts_odm_fp <- paste0(experiment_2_dir_chip, "chip_counts.odm")
chip_counts_metadata_fp <- paste0(experiment_2_dir_chip, "metadata.rds")
gRNA_counts_odm_fp <- paste0(experiment_2_dir_gRNA, "gRNA_counts.odm")
gRNA_counts_metadata_fp <- paste0(experiment_2_dir_gRNA, "metadata.rds")
all_chip_names <- m_list$atac_count |> row.names()
files_used_in_exp_2 <- all_chip_names[!(all_chip_names %in% files_used_in_exp)]
write_m_list(m_list = m_list,
chip_counts_odm_fp = chip_counts_odm_fp,
chip_counts_metadata_fp = chip_counts_metadata_fp,
gRNA_counts_odm_fp = gRNA_counts_odm_fp,
gRNA_counts_metadata_fp = gRNA_counts_metadata_fp,
files_used_in_exp = files_used_in_exp_2)
# set directories
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
papers <- list.files(sceptre2_data_dir)
# load packages
library(ondisc)
# loop over papers
for (paper in papers) {
# loop over datasets
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
for (dataset in datasets) {
# loop over modalities
dataset_dir <- paste0(paper_dir, dataset, "/")
modalities <- list.files(dataset_dir)
for (modality in modalities) {
print(paste0("paper: ", paper, ", dataset: ", dataset, ", modality: ", modality))
modality_dir <- paste0(dataset_dir, modality, "/")
metadata_fp <- paste0(modality_dir, "metadata_cell_qc.rds")
to_save_metadata_fp <- paste0(modality_dir, "metadata_qc.rds")
# if the modality is NOT gRNA... (if it is, then skip; no feature QC on the gRNA matrix for now)
if (modality != "grna") {
odm_fp <- paste0(modality_dir, "matrix.odm")
if (!file.exists(metadata_fp)) metadata_fp <- paste0(modality_dir, "metadata_orig.rds")
# read the odm
odm <- read_odm(odm_fp = odm_fp, metadata_fp = metadata_fp)
highly_exp_feats <- get_highly_expressed_features(odm, frac_expressed = 0.005)
if (nrow(odm) == length(highly_exp_feats)) {
# symbolic link to the current metadata_fp if no subset necessary
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
} else {
# create a new metadata_fp if subset necessary
odm_sub <- odm[highly_exp_feats,]
save_odm(odm = odm_sub, metadata_fp = to_save_metadata_fp)
}
} else {
# the modality IS gRNA; simply create a symbolic link (no qc)
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
}
}
}
}
285 - 46
(285 - 45)/45
modality
modalities
print(paste0("paper: ", paper, ", dataset: ", dataset, ", modality: ", modality))
modality_dir <- paste0(dataset_dir, modality, "/")
metadata_fp <- paste0(modality_dir, "metadata_cell_qc.rds")
modality_dir
metadata_fp <- paste0(modality_dir, "metadata_cell_qc.rds")
metadata_fp
to_save_metadata_fp <- paste0(modality_dir, "metadata_qc.rds")
modality != "grna"
to_save_metadata_fp
metadata_fp
?R.utils::createLink
odm_sub
to_save_metadata_fp
save_odm(odm = odm_sub, metadata_fp = to_save_metadata_fp)
# the modality IS gRNA; simply create a symbolic link (no qc)
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
to_save_metadata_fp
metadata_fp
to_save_metadata_fp
metadata_fp
to_save_metadata_fp <- paste0(modality_dir, "metadata_qc.rds")
if (!file.exists(metadata_fp)) metadata_fp <- paste0(modality_dir, "metadata_orig.rds")
metadata_fp
# the modality IS gRNA; simply create a symbolic link (no qc)
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
to_save_metadata_fp
metadata_fp
metadata_fp
to_save_metadata_fp
metadata_fp
to_save_metadata_fp
# the modality IS gRNA; simply create a symbolic link (no qc)
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
to_save_metadata_fp
to_save_metadata_fp
metadata_fp
metadata_fp
# the modality IS gRNA; simply create a symbolic link (no qc)
R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp)
to_save_metadata_fp
metadata_fp
# the modality IS gRNA; simply create a symbolic link (no qc)
paste0("ln -s ", metadata_fp, to_save_metadata_fp)
# the modality IS gRNA; simply create a symbolic link (no qc)
paste("ln -s", metadata_fp, to_save_metadata_fp)
system(R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp))
to_save_metadata_fp
metadata_fp
system(R.utils::createLink(link = to_save_metadata_fp, target = metadata_fp))
# the modality IS gRNA; simply create a symbolic link (no qc)
paste("ln -s", metadata_fp, to_save_metadata_fp)
# the modality IS gRNA; simply create a symbolic link (no qc)
system(paste("ln -s", metadata_fp, to_save_metadata_fp))
# This script performs a lightweight feature QC on all datasets under consideration.
# set directories
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
papers <- list.files(sceptre2_data_dir)
# load packages
library(ondisc)
for (paper in papers) {
# loop over datasets
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
for (dataset in datasets) {
# loop over modalities
dataset_dir <- paste0(paper_dir, dataset, "/")
modalities <- list.files(dataset_dir)
for (modality in modalities) {
print(paste0("paper: ", paper, ", dataset: ", dataset, ", modality: ", modality))
modality_dir <- paste0(dataset_dir, modality, "/")
metadata_fp <- paste0(modality_dir, "metadata_cell_qc.rds")
if (!file.exists(metadata_fp)) metadata_fp <- paste0(modality_dir, "metadata_orig.rds")
to_save_metadata_fp <- paste0(modality_dir, "metadata_qc.rds")
# if the modality is NOT gRNA... (if it is, then skip; no feature QC on the gRNA matrix for now)
if (modality != "grna") {
odm_fp <- paste0(modality_dir, "matrix.odm")
# read the odm
odm <- read_odm(odm_fp = odm_fp, metadata_fp = metadata_fp)
highly_exp_feats <- get_highly_expressed_features(odm, frac_expressed = 0.005)
if (nrow(odm) == length(highly_exp_feats)) {
# symbolic link to the current metadata_fp if no subset necessary
system(paste("ln -s", metadata_fp, to_save_metadata_fp))
} else {
# create a new metadata_fp if subset necessary
odm_sub <- odm[highly_exp_feats,]
save_odm(odm = odm_sub, metadata_fp = to_save_metadata_fp)
}
} else {
# the modality IS gRNA; simply create a symbolic link (no qc)
system(paste("ln -s", metadata_fp, to_save_metadata_fp))
}
}
}
}
