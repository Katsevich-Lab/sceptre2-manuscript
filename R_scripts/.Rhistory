paper
paper <- papers[1]
paper
library(ondisc)
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
df <- lapply(papers, function(paper) {
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
lapply(X = datasets, FUN = function(dataset) {
print(paste0("paper: ", paper, " dataset: ", dataset))
# mm_odm <- lowmoi::read_all_modalities(paper = paper, dataset = dataset, sceptre2_data_dir = sceptre2_data_dir)
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
modalities <- names(mm_odm@modalities)
remaining_modalities <- modalities[!(modalities %in% c("grna_assignment", "grna_expression"))]
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
# load the gRNA assignments
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
unique_grnas <- unique(cellwise_grna_assignments)
grna_tbl <- lapply(unique_grnas, function(grna) {
which(cellwise_grna_assignments == grna)
}) |> stats::setNames(nm = unique_grnas)
# loop through modalities
lapply(X = remaining_modalities, FUN = function(modality) {
print(paste0("Working on modality ", modality))
curr_modality <- get_modality(mm_odm, modality)
feature_ids <- get_feature_ids(curr_modality)[1:4]
# loop through feature IDs; load the relevant feature
lapply(X = seq(1, length(feature_ids)), FUN = function(i) {
feature_id <- feature_ids[i]
if (i %% 200 == 0) print(paste0("Working on ", feature_id, "."))
gene_exp <- curr_modality[[feature_id,]] |> as.numeric()
# loop through grnas, finding the number of nonzero cells for each grna
n_nonzero_cells <- sapply(grna_tbl, FUN = function(curr_grna_idx) {
gene_exp[curr_grna_idx] |> sum()
})
df <- data.frame(feature_id = feature_id,
grna_id = names(grna_tbl),
n_nonzero_cells = n_nonzero_cells)
rownames(df) <- NULL
return(df)
}) |> data.table::rbindlist() |>
dplyr::mutate(feature_id = factor(feature_id),
grna_id = factor(grna_id),
modality = factor(modality))
}) |> data.table::rbindlist() |>
dplyr::mutate(dataset = factor(dataset))
}) |> data.table::rbindlist() |>
dplyr::mutate(paper = factor(paper))
}) |> data.table::rbindlist()
head(df)
tail(df)
nrow(df)
df$feature_id |> head()
df$grna_id |> head()
df$n_nonzero_cells |> head()
df$modality |> head()
df$dataset |> head()
df$paper |> head()
library(ondisc)
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
sceptre2_data_dir
.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
sceptre2_data_dir
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
sceptre2_data_dir
sceptre2_data_dir
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
library(ondisc)
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
sceptre2_sample_sizes_dir
if (!dir.exists(sceptre2_sample_sizes_dir)) dir.create(sceptre2_sample_sizes_dir)
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
papers
sceptre2_sample_sizes_dir
df <- lapply(papers, function(paper) {
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
lapply(X = datasets, FUN = function(dataset) {
print(paste0("paper: ", paper, " dataset: ", dataset))
# mm_odm <- lowmoi::read_all_modalities(paper = paper, dataset = dataset, sceptre2_data_dir = sceptre2_data_dir)
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
modalities <- names(mm_odm@modalities)
remaining_modalities <- modalities[!(modalities %in% c("grna_assignment", "grna_expression"))]
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
# load the gRNA assignments
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
unique_grnas <- unique(cellwise_grna_assignments)
grna_tbl <- lapply(unique_grnas, function(grna) {
which(cellwise_grna_assignments == grna)
}) |> stats::setNames(nm = unique_grnas)
# loop through modalities
lapply(X = remaining_modalities, FUN = function(modality) {
print(paste0("Working on modality ", modality))
curr_modality <- get_modality(mm_odm, modality)
feature_ids <- get_feature_ids(curr_modality)[1:4]
# loop through feature IDs; load the relevant feature
lapply(X = seq(1, length(feature_ids)), FUN = function(i) {
feature_id <- feature_ids[i]
if (i %% 200 == 0) print(paste0("Working on ", feature_id, "."))
gene_exp <- curr_modality[[feature_id,]] |> as.numeric()
# loop through grnas, finding the number of nonzero cells for each grna
n_nonzero_cells <- sapply(grna_tbl, FUN = function(curr_grna_idx) {
gene_exp[curr_grna_idx] |> sum()
})
df <- data.frame(feature_id = feature_id,
grna_id = names(grna_tbl),
n_nonzero_cells = n_nonzero_cells)
rownames(df) <- NULL
return(df)
}) |> data.table::rbindlist() |>
dplyr::mutate(feature_id = factor(feature_id),
grna_id = factor(grna_id),
modality = factor(modality))
}) |> data.table::rbindlist() |>
dplyr::mutate(dataset = factor(dataset))
}) |> data.table::rbindlist() |>
dplyr::mutate(paper = factor(paper))
}) |> data.table::rbindlist()
df
library(ondisc)
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
if (!dir.exists(sceptre2_sample_sizes_dir)) dir.create(sceptre2_sample_sizes_dir)
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
df <- lapply(papers, function(paper) {
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
lapply(X = datasets, FUN = function(dataset) {
print(paste0("paper: ", paper, " dataset: ", dataset))
# mm_odm <- lowmoi::read_all_modalities(paper = paper, dataset = dataset, sceptre2_data_dir = sceptre2_data_dir)
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
modalities <- names(mm_odm@modalities)
remaining_modalities <- modalities[!(modalities %in% c("grna_assignment", "grna_expression"))]
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
# load the gRNA assignments
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
unique_grnas <- unique(cellwise_grna_assignments)
grna_tbl <- lapply(unique_grnas, function(grna) {
which(cellwise_grna_assignments == grna)
}) |> stats::setNames(nm = unique_grnas)
# loop through modalities
lapply(X = remaining_modalities, FUN = function(modality) {
print(paste0("Working on modality ", modality))
curr_modality <- get_modality(mm_odm, modality)
feature_ids <- get_feature_ids(curr_modality)[1:4]
# loop through feature IDs; load the relevant feature
lapply(X = seq(1, length(feature_ids)), FUN = function(i) {
feature_id <- feature_ids[i]
if (i %% 200 == 0) print(paste0("Working on ", feature_id, "."))
gene_exp <- curr_modality[[feature_id,]] |> as.numeric()
# loop through grnas, finding the number of nonzero cells for each grna
n_nonzero_cells <- sapply(grna_tbl, FUN = function(curr_grna_idx) {
gene_exp[curr_grna_idx] |> sum()
})
df <- data.frame(feature_id = feature_id,
grna_id = names(grna_tbl),
n_nonzero_cells = n_nonzero_cells)
rownames(df) <- NULL
return(df)
}) |> data.table::rbindlist() |>
dplyr::mutate(feature_id = factor(feature_id),
grna_id = factor(grna_id),
modality = factor(modality))
}) |> data.table::rbindlist() |>
dplyr::mutate(dataset = factor(dataset))
}) |> data.table::rbindlist() |>
dplyr::mutate(paper = factor(paper))
}) |> data.table::rbindlist()
.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
.get_config_path("LOCAL_SCEPTRE2_DATA_DIR")
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "/data")
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
if (!dir.exists(sceptre2_sample_sizes_dir)) dir.create(sceptre2_sample_sizes_dir)
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
df <- lapply(papers, function(paper) {
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
lapply(X = datasets, FUN = function(dataset) {
print(paste0("paper: ", paper, " dataset: ", dataset))
# mm_odm <- lowmoi::read_all_modalities(paper = paper, dataset = dataset, sceptre2_data_dir = sceptre2_data_dir)
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
modalities <- names(mm_odm@modalities)
remaining_modalities <- modalities[!(modalities %in% c("grna_assignment", "grna_expression"))]
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
# load the gRNA assignments
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
unique_grnas <- unique(cellwise_grna_assignments)
grna_tbl <- lapply(unique_grnas, function(grna) {
which(cellwise_grna_assignments == grna)
}) |> stats::setNames(nm = unique_grnas)
# loop through modalities
lapply(X = remaining_modalities, FUN = function(modality) {
print(paste0("Working on modality ", modality))
curr_modality <- get_modality(mm_odm, modality)
feature_ids <- get_feature_ids(curr_modality)[1:4]
# loop through feature IDs; load the relevant feature
lapply(X = seq(1, length(feature_ids)), FUN = function(i) {
feature_id <- feature_ids[i]
if (i %% 200 == 0) print(paste0("Working on ", feature_id, "."))
gene_exp <- curr_modality[[feature_id,]] |> as.numeric()
# loop through grnas, finding the number of nonzero cells for each grna
n_nonzero_cells <- sapply(grna_tbl, FUN = function(curr_grna_idx) {
gene_exp[curr_grna_idx] |> sum()
})
df <- data.frame(feature_id = feature_id,
grna_id = names(grna_tbl),
n_nonzero_cells = n_nonzero_cells)
rownames(df) <- NULL
return(df)
}) |> data.table::rbindlist() |>
dplyr::mutate(feature_id = factor(feature_id),
grna_id = factor(grna_id),
modality = factor(modality))
}) |> data.table::rbindlist() |>
dplyr::mutate(dataset = factor(dataset))
}) |> data.table::rbindlist() |>
dplyr::mutate(paper = factor(paper))
}) |> data.table::rbindlist()
df
paper <- :frangieh
paper <- "frangieh"
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
dataset <- datasets[1]
print(paste0("paper: ", paper, " dataset: ", dataset))
datasets
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
datasets
print(paste0("paper: ", paper))
sceptre2_data_dir
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data")
datasets <- list.files(paper_dir)
datasets
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
paste0(sceptre2_data_dir, paper, "/")
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
datasets
lapply(X = datasets, FUN = function(dataset) {
print(paste0("paper: ", paper, " dataset: ", dataset))
# mm_odm <- lowmoi::read_all_modalities(paper = paper, dataset = dataset, sceptre2_data_dir = sceptre2_data_dir)
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
modalities <- names(mm_odm@modalities)
remaining_modalities <- modalities[!(modalities %in% c("grna_assignment", "grna_expression"))]
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
# load the gRNA assignments
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
unique_grnas <- unique(cellwise_grna_assignments)
grna_tbl <- lapply(unique_grnas, function(grna) {
which(cellwise_grna_assignments == grna)
}) |> stats::setNames(nm = unique_grnas)
# loop through modalities
lapply(X = remaining_modalities, FUN = function(modality) {
print(paste0("Working on modality ", modality))
curr_modality <- get_modality(mm_odm, modality)
feature_ids <- get_feature_ids(curr_modality)[1:4]
# loop through feature IDs; load the relevant feature
lapply(X = seq(1, length(feature_ids)), FUN = function(i) {
feature_id <- feature_ids[i]
if (i %% 200 == 0) print(paste0("Working on ", feature_id, "."))
gene_exp <- curr_modality[[feature_id,]] |> as.numeric()
# loop through grnas, finding the number of nonzero cells for each grna
n_nonzero_cells <- sapply(grna_tbl, FUN = function(curr_grna_idx) {
gene_exp[curr_grna_idx] |> sum()
})
df <- data.frame(feature_id = feature_id,
grna_id = names(grna_tbl),
n_nonzero_cells = n_nonzero_cells)
rownames(df) <- NULL
return(df)
}) |> data.table::rbindlist() |>
dplyr::mutate(feature_id = factor(feature_id),
grna_id = factor(grna_id),
modality = factor(modality))
}) |> data.table::rbindlist() |>
dplyr::mutate(dataset = factor(dataset))
}) |> data.table::rbindlist() |>
dplyr::mutate(paper = factor(paper))
library(ondisc)
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
if (!dir.exists(sceptre2_sample_sizes_dir)) dir.create(sceptre2_sample_sizes_dir)
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
df <- lapply(papers, function(paper) {
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
lapply(X = datasets, FUN = function(dataset) {
print(paste0("paper: ", paper, " dataset: ", dataset))
# mm_odm <- lowmoi::read_all_modalities(paper = paper, dataset = dataset, sceptre2_data_dir = sceptre2_data_dir)
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
modalities <- names(mm_odm@modalities)
remaining_modalities <- modalities[!(modalities %in% c("grna_assignment", "grna_expression"))]
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
# load the gRNA assignments
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
unique_grnas <- unique(cellwise_grna_assignments)
grna_tbl <- lapply(unique_grnas, function(grna) {
which(cellwise_grna_assignments == grna)
}) |> stats::setNames(nm = unique_grnas)
# loop through modalities
lapply(X = remaining_modalities, FUN = function(modality) {
print(paste0("Working on modality ", modality))
curr_modality <- get_modality(mm_odm, modality)
feature_ids <- get_feature_ids(curr_modality)[1:4]
# loop through feature IDs; load the relevant feature
lapply(X = seq(1, length(feature_ids)), FUN = function(i) {
feature_id <- feature_ids[i]
if (i %% 200 == 0) print(paste0("Working on ", feature_id, "."))
gene_exp <- curr_modality[[feature_id,]] |> as.numeric()
# loop through grnas, finding the number of nonzero cells for each grna
n_nonzero_cells <- sapply(grna_tbl, FUN = function(curr_grna_idx) {
gene_exp[curr_grna_idx] |> sum()
})
df <- data.frame(feature_id = feature_id,
grna_id = names(grna_tbl),
n_nonzero_cells = n_nonzero_cells)
rownames(df) <- NULL
return(df)
}) |> data.table::rbindlist() |>
dplyr::mutate(feature_id = factor(feature_id),
grna_id = factor(grna_id),
modality = factor(modality))
}) |> data.table::rbindlist() |>
dplyr::mutate(dataset = factor(dataset))
}) |> data.table::rbindlist() |>
dplyr::mutate(paper = factor(paper))
}) |> data.table::rbindlist()
head(df)
df
sceptre2_sample_sizes_dir
library(ondisc)
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
if (!dir.exists(sceptre2_sample_sizes_dir)) dir.create(sceptre2_sample_sizes_dir)
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
sceptre2_data_dir
sceptre2_data_dir
sceptre2_data_dir
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
sceptre2_sample_sizes_dir
sceptre2_sample_sizes_dir
sceptre2_sample_sizes_dir
sceptre2_sample_sizes_dir
sceptre2_sample_sizes_dir
saveRDS(object = df, file = paste0(sceptre2_sample_sizes_dir, "n_nonzero_cells_df.rds"))
papers
paper <- papers[1]
paper
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
datasets
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
datasets
datasets
dataset <- datasets[1]
dataset
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
mm_odm
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
cellwise_grna_assignments
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna)
table(cellwise_grna_assignments)
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna) |>
table()
cellwise_grna_assignments
names(cellwise_grna_assignments)
data.frame(
grna_id = names(cellwise_grna_assignments),
n_cells = as.integer(cellwise_grna_assignments)
)
df <- data.frame(
grna_id = names(cellwise_grna_assignments),
n_cells = as.integer(cellwise_grna_assignments)
)
df
df <- data.frame(
grna_id = names(cellwise_grna_assignments),
n_cells = as.integer(cellwise_grna_assignments))
df
head(Df)
head(df)
paper
df <- data.frame(
grna_id = names(cellwise_grna_assignments),
n_cells = as.integer(cellwise_grna_assignments)) |>
dplyr::mutate(paper = factor(paper), dataset = factor(dataset))
df
head(df)
tail(df)
lapply(X = datasets, FUN = function(dataset) {
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna) |>
table()
data.frame(
grna_id = names(cellwise_grna_assignments),
n_cells = as.integer(cellwise_grna_assignments)) |>
dplyr::mutate(paper = factor(paper), dataset = factor(dataset))
}) |> data.table::rbindlist()
#####################################################
# SECOND: compute the simple number of cells per gRNA
#####################################################
df <- lapply(papers, function(paper) {
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
lapply(X = datasets, FUN = function(dataset) {
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna) |>
table()
data.frame(
grna_id = names(cellwise_grna_assignments),
n_cells = as.integer(cellwise_grna_assignments)) |>
dplyr::mutate(paper = factor(paper), dataset = factor(dataset))
}) |> data.table::rbindlist()
}) |> data.table::rbindlist()
head(df)
tail(df)
df
head(df, 100)
saveRDS(object = df, file = paste0(sceptre2_sample_sizes_dir, "n_cells_per_grna.rds"))
saveRDS(object = df, file = paste0(sceptre2_sample_sizes_dir, "n_cells_per_grna.rds"))
library(ondisc)
sceptre2_data_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "data/")
sceptre2_sample_sizes_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "internal/dataset_sample_sizes/")
if (!dir.exists(sceptre2_sample_sizes_dir)) dir.create(sceptre2_sample_sizes_dir)
papers <- c("frangieh", "liscovitch",  "papalexi", "schraivogel", "simulated")
#####################################################
# SECOND: compute the simple number of cells per gRNA
#####################################################
df <- lapply(papers, function(paper) {
print(paste0("paper: ", paper))
paper_dir <- paste0(sceptre2_data_dir, paper, "/")
datasets <- list.files(paper_dir)
lapply(X = datasets, FUN = function(dataset) {
paper_fp <- paste0(paper, "/", dataset)
mm_odm <- lowmoi::load_dataset_multimodal(paper_fp = paper_fp,
offsite_dir = .get_config_path("LOCAL_SCEPTRE2_DATA_DIR"))
grna_assign_modality <- get_modality(mm_odm, "grna_assignment")
cellwise_grna_assignments <- grna_assign_modality |>
get_cell_covariates() |>
dplyr::pull(assigned_grna) |>
table()
data.frame(
grna_id = names(cellwise_grna_assignments),
n_cells = as.integer(cellwise_grna_assignments)) |>
dplyr::mutate(paper = factor(paper), dataset = factor(dataset))
}) |> data.table::rbindlist()
}) |> data.table::rbindlist()
head(df)
