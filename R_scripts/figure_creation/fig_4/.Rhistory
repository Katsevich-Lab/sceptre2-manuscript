# Load packages
library(tidyverse)
library(katlabutils)
library(ggpubr)
library(grid)
library(gridExtra)
library(gtable)
# Resolve namespace conflicts
conflicts_prefer(dplyr::filter)
reject_thresh <- 1e-5   # threshold for rejection of positive controls
alpha <- 0.1            # target FWER level for negative controls
max_false_reject <- 50  # maximum false rejections to display power
# Load packages
library(tidyverse)
library(katlabutils)
library(ggpubr)
library(grid)
library(gridExtra)
library(gtable)
# Resolve namespace conflicts
conflicts_prefer(dplyr::filter)
#################################################################
# Set analysis parameters
#################################################################
reject_thresh <- 1e-5   # threshold for rejection of positive controls
alpha <- 0.1            # target FWER level for negative controls
max_false_reject <- 50  # maximum false rejections to display power
#################################################################
# Load results
#################################################################
# source shared figure script
shared_fig_script <- paste0(
.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/shared_figure_script.R"
)
source(shared_fig_script)
# directory with results
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
library(lowmoi)
library(tidyverse)
sceptre2_results_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sample_size_df <- readRDS(paste0(sceptre2_results_dir, "dataset_sample_sizes/n_nonzero_cells_per_grna.rds"))
library(lowmoi)
library(tidyverse)
sceptre2_results_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
sample_size_df <- readRDS(paste0(sceptre2_results_dir, "dataset_sample_sizes/n_nonzero_cells_per_grna.rds"))
sceptre2_results_dir
# discovery results
disc_res <- readRDS(paste0(sceptre2_results_dir, "discovery_analyses/discovery_results_0423.rds"))
disc_res
head(disc_res)
process_pc_result
disc_res_processed <- process_pc_result(pc_res = disc_res,
sample_size_df = sample_size_df)
head(disc_res_processed)
x <- disc_res_processed |> dplyr::filter(method == "sceptre")
head(x)
x$p_value |> is.na() |> any()
x |> na.omit() |> head()
x_sub <- x |> na.omit()
x_sub$n_treatment |> min()
x_sub$n_control |> min()
head(x_sub)
head(x)
min(x$n_treatment)
x_sub <- x |> dplyr::filter(n_treatment >= 7L, n_control >= 7L)
heda(x_sub)
head(x_sub)
x_sub$p_value |> is.na()
x_sub$p_value |> is.na() |> any()
head(x)
disc_res_processed <- process_pc_result(pc_res = disc_res,
sample_size_df = sample_size_df)
process_pc_result
pc_res <- disc_res
sample_size_df <- sample_size_df
if ("schraivogel/enhancer_screen_chr11/gene" %in% pc_res$dataset &&
"schraivogel/enhancer_screen_chr8/gene" %in% pc_res$dataset) {
x <- pc_res |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
update_dataset_and_method_names()
} else {
x <- pc_res |>
replace_slash_w_underscore() |>
update_dataset_and_method_names()
}
load_all("~/research_code/lowmoi")
if ("schraivogel/enhancer_screen_chr11/gene" %in% pc_res$dataset &&
"schraivogel/enhancer_screen_chr8/gene" %in% pc_res$dataset) {
x <- pc_res |>
replace_slash_w_underscore() |>
combine_schraivogel_enhancer_screens() |>
update_dataset_and_method_names()
} else {
x <- pc_res |>
replace_slash_w_underscore() |>
update_dataset_and_method_names()
}
sample_size_df_pc <- sample_size_df |>
filter(feature_id %in% unique(pc_res$response_id),
dataset_concat %in% unique(pc_res$dataset)) |>
dplyr::mutate(dataset = dataset_concat,
dataset_concat = NULL, paper = NULL, modality = NULL) |>
dplyr::rename(grna_group = target, response_id = feature_id) |>
replace_slash_w_underscore()
combine_schraivogel_enhancer_screens
head(sample_size_df_pc$dataset)
unique(sample_size_df_pc$dataset)
if ("schraivogel_enhancer_screen_chr11_gene" %in% unique(sample_size_df_pc$dataset) ||
"schraivogel_enhancer_screen_chr8_gene" %in% unique(sample_size_df_pc$dataset)) {
sample_size_df_pc <- sample_size_df_pc |> combine_schraivogel_enhancer_screens()
}
control_sample_size_df <- sample_size_df_pc |>
filter(grna_group == "non-targeting") |>
group_by(response_id, dataset) |>
summarize(n_control = sum(n_nonzero_cells))
to_join <- sample_size_df_pc |>
group_by(grna_group, response_id, dataset) |>
summarize(n_treatment = sum(n_nonzero_cells)) |>
select(response_id, grna_group, n_treatment, dataset)
pc_res_w_ss <- left_join(x = x,
y = to_join,
by = c("grna_group", "response_id", "dataset")) |>
left_join(y = control_sample_size_df, by = c("response_id", "dataset"))
head(pc_res_w_ss)
