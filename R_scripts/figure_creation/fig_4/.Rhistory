pc_res$dataset |> unique()
pc_res |> filter(dataset == "simulated_experiment_2_gene")
pc_res
dataset_rename
head(pc_res)
pc_res$dataset_rename |> unique()
pc_res
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh")))
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF)
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename)
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename)
n_true_rejections_tab
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method"))
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method"))
n_true_rejections_tab
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method"))
n_true_rejections_tab$dataset_rename |> unique()
n_true_rejections_tab$dataset_rename |> filter(dataset == "simulated_experiment_2_gene")
n_true_rejections_tab$dataset_rename |> dplyr::filter(dataset == "simulated_experiment_2_gene")
n_true_rejections_tab |> dplyr::filter(dataset == "simulated_experiment_2_gene")
n_true_rejections_tab
n_true_rejections_tab
n_true_rejections_tab$dataset_rename |> unique()
n_true_rejections_tab$dataset_rename |> filter(dataset_rename = "simulated_experiment_2_gene")
n_true_rejections_tab$dataset_rename |> filter(dataset_rename == "simulated_experiment_2_gene")
n_true_rejections_tab |> filter(dataset_rename == "simulated_experiment_2_gene")
<- pc_res |>
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-")) |>
select(dataset_rename, Method, n_pc_reject, `PC pairs`) |>
pivot_wider(names_from = Method, values_from = n_pc_reject) |>
relocate("SCEPTRE", .after = "dataset_rename") |>
relocate(`PC pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-")) |>
select(dataset_rename, Method, n_pc_reject, `PC pairs`) |>
pivot_wider(names_from = Method, values_from = n_pc_reject) |>
relocate(`PC pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_true_rejections_tab
0.1/1000
2.5 * (0.1/1000)
2.5 * (1000/0.1)
25000 / 5000
1000
1/25000
# Load packages
library(tidyverse)
library(katlabutils)
library(ggpubr)
library(grid)
library(gridExtra)
library(gtable)
# Resolve namespace conflicts
conflicts_prefer(dplyr::filter)
#################################################################
# Set analysis parameters
#################################################################
reject_thresh <- 1e-5   # threshold for rejection of positive controls
alpha <- 0.1            # target FWER level for negative controls
max_false_reject <- 50  # maximum false rejections to display power
#################################################################
# Load results
#################################################################
# source shared figure script
shared_fig_script <- paste0(
.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/shared_figure_script.R"
)
source(shared_fig_script)
# directory with results
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
# results of undercover analysis
undercover_res <- readRDS(paste0(
result_dir,
"undercover_grna_analysis/undercover_result_grp_1_0523_processed.rds"
)) |>
filter(
n_nonzero_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_nonzero_control >= N_NONZERO_CONTROL_CUTOFF
)
pc_res <- readRDS(paste0(
result_dir,
"positive_control_analysis/pc_results_0523_processed.rds"
)) |>
dplyr::filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF)
#################################################################
n_false_rejections <- undercover_res |>
filter(!(Method %in% c(c("NB regression (no covariates)",
"NB regression (w/ covariates)",
"SCEPTRE (no covariates)")))) |>
group_by(dataset_rename, Method) |>
summarize(n_false_reject = sum(p_value < alpha/n()),
Method = Method[1],
`NT pairs` = n(),
.groups = "drop")
n_false_rejections_tab <- n_false_rejections |>
pivot_wider(names_from = Method, values_from = n_false_reject) |>
relocate("SCEPTRE", .after = "dataset_rename") |>
relocate(`NT pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_false_rejections_tab <- n_false_rejections_tab |>
mutate(across(everything(), as.character)) |>
bind_rows(
n_false_rejections_tab |>
summarise(across(-c(Dataset, `NT pairs`), mean)) |>
mutate(Dataset = "Average") |>
mutate(across(-Dataset, function(x)(as.character(round(x, 1)))))
)  |>
mutate(`NT pairs` = ifelse(is.na(`NT pairs`), "", `NT pairs`))
n_false_rejections_tab <- n_false_rejections_tab[,c("Dataset", "SCEPTRE", "Seurat-Wilcox", "Seurat-NB", "t-test", "MAST", "KS test", "MIMOSCA", "NT pairs")]
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "Seurat-Wilcox"] <- "Seurat-\nWilcox"
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "Seurat-NB"] <- "Seurat-\nNB"
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "NT pairs"] <- "NT\npairs"
n_false_rejections_tab
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-")) |>
select(dataset_rename, Method, n_pc_reject, `PC pairs`) |>
pivot_wider(names_from = Method, values_from = n_pc_reject) |>
relocate("SCEPTRE", .after = "dataset_rename") |>
relocate(`PC pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_true_rejections_tab <- n_true_rejections_tab[,c("Dataset", "SCEPTRE", "Seurat-Wilcox", "Seurat-NB", "t-test", "MAST", "KS test", "MIMOSCA", "PC pairs")]
n_true_rejections_tab <- n_true_rejections_tab[,c("Dataset", "SCEPTRE", "Seurat-Wilcox", "Seurat-NB", "t-test", "MAST", "KS test", "MIMOSCA", "PC pairs")]
n_true_rejections_tab
# results of positive control analysis
pc_res <- readRDS(paste0(
result_dir,
"positive_control_analysis/pc_results_0124_processed.rds"
)) |>
dplyr::filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF)
#################################################################
# Process negative control results into final table
#################################################################
n_false_rejections <- undercover_res |>
filter(!(Method %in% c(c("NB regression (no covariates)",
"NB regression (w/ covariates)",
"SCEPTRE (no covariates)")))) |>
group_by(dataset_rename, Method) |>
summarize(n_false_reject = sum(p_value < alpha/n()),
Method = Method[1],
`NT pairs` = n(),
.groups = "drop")
n_false_rejections_tab <- n_false_rejections |>
pivot_wider(names_from = Method, values_from = n_false_reject) |>
relocate("SCEPTRE", .after = "dataset_rename") |>
relocate(`NT pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_false_rejections_tab <- n_false_rejections_tab |>
mutate(across(everything(), as.character)) |>
bind_rows(
n_false_rejections_tab |>
summarise(across(-c(Dataset, `NT pairs`), mean)) |>
mutate(Dataset = "Average") |>
mutate(across(-Dataset, function(x)(as.character(round(x, 1)))))
)  |>
mutate(`NT pairs` = ifelse(is.na(`NT pairs`), "", `NT pairs`))
n_false_rejections_tab <- n_false_rejections_tab[,c("Dataset", "SCEPTRE", "Seurat-Wilcox", "Seurat-NB", "t-test", "MAST", "KS test", "MIMOSCA", "NT pairs")]
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "Seurat-Wilcox"] <- "Seurat-\nWilcox"
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "Seurat-NB"] <- "Seurat-\nNB"
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "NT pairs"] <- "NT\npairs"
#################################################################
# Process positive control results
#################################################################
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-")) |>
select(dataset_rename, Method, n_pc_reject, `PC pairs`) |>
pivot_wider(names_from = Method, values_from = n_pc_reject) |>
relocate("SCEPTRE", .after = "dataset_rename") |>
relocate(`PC pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_true_rejections_tab <- n_true_rejections_tab[,c("Dataset", "SCEPTRE", "Seurat-Wilcox", "Seurat-NB", "t-test", "MAST", "KS test", "MIMOSCA", "PC pairs")]
n_true_rejections_tab
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop")
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method"))
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-"))
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-")) |>
select(dataset_rename, Method, n_pc_reject, `PC pairs`)
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-")) |>
select(dataset_rename, Method, n_pc_reject, `PC pairs`) |>
pivot_wider(names_from = Method, values_from = n_pc_reject) |>
relocate("SCEPTRE", .after = "dataset_rename")
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop")
pc_res
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop")
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |> dplyr::pull(dataset_rename) |> unique()
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |> dplyr::filter(dataset == "simulated_experiment_2_gene")
pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |> dplyr::filter(dataset_rename == "simulated_experiment_2_gene")
258 + 234 + 148 - 45 - 245 + 176 + 45 - 78 - 98
245 + 45 + 78 + 98
# Load packages
library(tidyverse)
library(katlabutils)
library(ggpubr)
library(grid)
library(gridExtra)
library(gtable)
# Resolve namespace conflicts
conflicts_prefer(dplyr::filter)
#################################################################
# Set analysis parameters
#################################################################
reject_thresh <- 1e-5   # threshold for rejection of positive controls
alpha <- 0.1            # target FWER level for negative controls
max_false_reject <- 50  # maximum false rejections to display power
#################################################################
# Load results
#################################################################
# source shared figure script
shared_fig_script <- paste0(
.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/shared_figure_script.R"
)
source(shared_fig_script)
# directory with results
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/")
# results of undercover analysis
undercover_res <- readRDS(paste0(
result_dir,
"undercover_grna_analysis/undercover_result_grp_1_0523_processed.rds"
)) |>
filter(
n_nonzero_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_nonzero_control >= N_NONZERO_CONTROL_CUTOFF
)
# results of positive control analysis
pc_res <- readRDS(paste0(
result_dir,
"positive_control_analysis/pc_results_0124_processed.rds"
)) |>
dplyr::filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF)
head(pr_res)
pc_res
head(pc_res)
pc_res$dataset_rename
# results of positive control analysis
pc_res <- readRDS(paste0(
result_dir,
"positive_control_analysis/pc_results_0124_processed.rds"
)) |>
dplyr::filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF)
#################################################################
# Process negative control results into final table
#################################################################
n_false_rejections <- undercover_res |>
filter(!(Method %in% c(c("NB regression (no covariates)",
"NB regression (w/ covariates)",
"SCEPTRE (no covariates)")))) |>
group_by(dataset_rename, Method) |>
summarize(n_false_reject = sum(p_value < alpha/n()),
Method = Method[1],
`NT pairs` = n(),
.groups = "drop")
n_false_rejections_tab <- n_false_rejections |>
pivot_wider(names_from = Method, values_from = n_false_reject) |>
relocate("SCEPTRE", .after = "dataset_rename") |>
relocate(`NT pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_false_rejections_tab <- n_false_rejections_tab |>
mutate(across(everything(), as.character)) |>
bind_rows(
n_false_rejections_tab |>
summarise(across(-c(Dataset, `NT pairs`), mean)) |>
mutate(Dataset = "Average") |>
mutate(across(-Dataset, function(x)(as.character(round(x, 1)))))
)  |>
mutate(`NT pairs` = ifelse(is.na(`NT pairs`), "", `NT pairs`))
n_false_rejections_tab <- n_false_rejections_tab[,c("Dataset", "SCEPTRE", "Seurat-Wilcox", "Seurat-NB", "t-test", "MAST", "KS test", "MIMOSCA", "NT pairs")]
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "Seurat-Wilcox"] <- "Seurat-\nWilcox"
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "Seurat-NB"] <- "Seurat-\nNB"
colnames(n_false_rejections_tab)[colnames(n_false_rejections_tab) == "NT pairs"] <- "NT\npairs"
#################################################################
# Process positive control results
#################################################################
n_true_rejections_tab <- pc_res |>
filter(!(grna_group %in% c("GATA1-enh", "MYC-enh", "ZFPM2-enh"))) |>  # remove enhancer targets
filter(n_treatment >= N_NONZERO_TREATMENT_CUTOFF,
n_control >= N_NONZERO_CONTROL_CUTOFF) |>
group_by(dataset_rename, Method) |>
summarize(n_pc_reject = sum(p_value < reject_thresh),
`PC pairs` = n(),
Method = Method[1],
.groups = "drop") |>
group_by(dataset_rename) |>
left_join(n_false_rejections,
by = c("dataset_rename", "Method")) |>
mutate(n_pc_reject = ifelse(n_false_reject <= max_false_reject,
as.character(n_pc_reject),
"-")) |>
select(dataset_rename, Method, n_pc_reject, `PC pairs`) |>
pivot_wider(names_from = Method, values_from = n_pc_reject) |>
relocate("SCEPTRE", .after = "dataset_rename") |>
relocate(`PC pairs`, .after = `KS test`) |>
rename(Dataset = dataset_rename)
n_true_rejections_tab <- n_true_rejections_tab[,c("Dataset", "SCEPTRE", "Seurat-Wilcox", "Seurat-NB", "t-test", "MAST", "KS test", "MIMOSCA", "PC pairs")]
n_true_rejections_tab
colnames(n_true_rejections_tab)[colnames(n_true_rejections_tab) == "Seurat-Wilcox"] <- "Seurat-\nWilcox"
colnames(n_true_rejections_tab)[colnames(n_true_rejections_tab) == "Seurat-NB"] <- "Seurat-\nNB"
colnames(n_true_rejections_tab)[colnames(n_true_rejections_tab) == "PC pairs"] <- "PC\npairs"
