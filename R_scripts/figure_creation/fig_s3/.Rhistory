tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "Method", values_to = "p_value") |>
mutate(Method = fct_recode(Method, "NB Regression" = "p_theory",
"SCEPTRE" = "p_camp",
"Permutation test" = "p_perm")) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = c(0.75, 0.17),
legend.title = element_blank()) +
guides(color = guide_legend(
keywidth = 0.0,
keyheight = 0.1,
default.unit="inch")) +
ggtitle("Confounding; correct model specification")
p1
p2 <- as.data.frame(uncorrelated_res$out_m) |>
tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "method", values_to = "p_value") |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = "none")
fig <- plot_grid(p1, p2, nrow = 1)
fig <- plot_grid(p1, p2, nrow = 1)
p2 <- as.data.frame(uncorrelated_res$out_m) |>
tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "method", values_to = "p_value") |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = "none")
fig <- plot_grid(p1, p2, nrow = 1)
# load functions and data
shared_fig_script <- paste0(.get_config_path("LOCAL_CODE_DIR"), "sceptre2-manuscript/R_scripts/figure_creation/shared_figure_script.R")
source(shared_fig_script)
result_dir <- paste0(.get_config_path("LOCAL_SCEPTRE2_DATA_DIR"), "results/extra_analyses/")
correlated_res <- readRDS(paste0(result_dir, "correlated_sim_result.rds"))
uncorrelated_res <- readRDS(paste0(result_dir, "uncorrelated_sim_result.rds"))
#############################
# QQ-plot for confounded case
#############################
p1 <- as.data.frame(correlated_res$out_m) |>
tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "Method", values_to = "p_value") |>
mutate(Method = fct_recode(Method, "NB Regression" = "p_theory",
"SCEPTRE" = "p_camp",
"Permutation test" = "p_perm")) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = c(0.75, 0.17),
legend.title = element_blank()) +
guides(color = guide_legend(
keywidth = 0.0,
keyheight = 0.1,
default.unit="inch")) +
ggtitle("Confounding; correct model specification")
p2 <- as.data.frame(uncorrelated_res$out_m) |>
tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "method", values_to = "p_value") |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = "none")
p2
fig <- plot_grid(p1, p2, nrow = 1)
fig
#############################
# QQ-plot for confounded case
#############################
p1 <- as.data.frame(correlated_res$out_m) |>
tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "Method", values_to = "p_value") |>
mutate(Method = fct_recode(Method, "NB Regression" = "p_theory",
"SCEPTRE" = "p_camp",
"Permutation test" = "p_perm")) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = c(0.75, 0.17),
legend.title = element_blank()) +
guides(color = guide_legend(
keywidth = 0.0,
keyheight = 0.1,
default.unit="inch")) +
ggtitle("Treatment confounded,\n GLM specified correctly")
p1
#############################
# QQ-plot for confounded case
#############################
p1 <- as.data.frame(correlated_res$out_m) |>
tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "Method", values_to = "p_value") |>
mutate(Method = fct_recode(Method, "NB Regression" = "p_theory",
"SCEPTRE" = "p_camp",
"Permutation test" = "p_perm")) |>
ggplot(mapping = aes(y = p_value, col = Method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = c(0.75, 0.17),
legend.title = element_blank()) +
guides(color = guide_legend(
keywidth = 0.0,
keyheight = 0.1,
default.unit="inch")) +
ggtitle("Treatment confounded,\nGLM specified correctly")
p2 <- as.data.frame(uncorrelated_res$out_m) |>
tidyr::pivot_longer(cols = c("p_theory", "p_camp", "p_perm"),
names_to = "method", values_to = "p_value") |>
ggplot(mapping = aes(y = p_value, col = method)) +
stat_qq_points(ymin = 1e-8, size = 0.55) +
scale_x_reverse() +
scale_y_reverse() +
labs(x = "Expected null p-value", y = "Observed p-value") +
geom_abline(col = "black") +
my_theme +
theme(legend.position = "none") +
ggtitle("Treatment unconfounded,\nGLM incorrectly specified")
fig <- plot_grid(p1, p2, nrow = 1)
fig
head(correlated_res$resamp_dist$perm_null)
head( correlated_res$resamp_dist$camp_null)
correlated_res$resamp_dist$camp_null
histogram_df <-  data.frame(z_null = correlated_res$resamp_dist$camp_null)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density),
fill = "Permutation distribution"),
data = histogram_df,
boundary = 0, color = "black", bins = 20)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
facet_wrap(ks_fit ~ ., nrow = 1)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
my_theme
histogram_df <-  data.frame(z_null = correlated_res$resamp_dist$camp_null)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01)))
zgrid <- seq(interval[1], interval[2], length.out = 1000)
zgrid <- seq(-4, 4, length.out = 1000)
rm(zgrid)
z_grid <- seq(-4, 4, length.out = 1000)
z_grid <- seq(-4, 4, length.out = 1000)
density_df <- data.frame(density = dnorm(z_grid),
z_grid = z_grid)
z_grid
density_df
z_grid <- seq(-4, 4, length.out = 1000)
density_df <- data.frame(density = dnorm(z_grid),
z_grid = z_grid)
histogram_df <- data.frame(z_null = correlated_res$resamp_dist$camp_null)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
geom_segment(aes(x = z_star, xend = z_star, y = 0, yend = dnorm(0), col = "Original statistic"), data = density_df) +
ggtitle("Permutation distribution of MW statistic") +
xlab("Permuted MW statistic") +
scale_color_manual(values = c("N(0,1) density" = "darkred", "Original statistic" = "purple")) +
scale_fill_manual(values = c("Permutation distribution" = "lightgrey"))
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "purple"),
data = density_df, linewidth = 0.7) +
geom_segment(aes(x = z_star, xend = z_star, y = 0, yend = dnorm(0), col = "Original statistic"), data = density_df) +
ggtitle("Permutation distribution of MW statistic") +
xlab("Permuted MW statistic") +
scale_color_manual(values = c("N(0,1) density" = "darkred", "Original statistic" = "purple")) +
scale_fill_manual(values = c("Permutation distribution" = "lightgrey"))
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "purple"),
data = density_df, linewidth = 0.7)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black", bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7)
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "darkred"))
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple"))
ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null")
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null") +
ylab("")
p3
source("~/research_code/sceptre2-manuscript/R_scripts/figure_creation/fig_s4/fig_s4.R")
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null") +
ylab("") +
ggtitle("SCEPTRE null z-scores")
p3
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null") +
ylab("") +
theme(legend.position = c(0.1, 0.67),
legend.key.size = unit(0.35, 'cm'),
legend.title = element_blank(),
legend.margin=margin(t = -0.5, unit='cm')) +
ggtitle("SCEPTRE null z-scores")
p3
fig <- plot_grid(p1, p2, p3, NULL nrow = 2)
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2)
fig
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.6, 0.4))
fig
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
fig
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null") +
ylab("") +
theme(legend.position = c(0.5, 0.67),
legend.key.size = unit(0.35, 'cm'),
legend.title = element_blank(),
legend.margin=margin(t = -0.5, unit='cm')) +
ggtitle("SCEPTRE null z-scores")
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
fig
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1)\ndensity" = "purple")) +
xlab("z null") +
ylab("") +
theme(legend.position = c(0.7, 0.67),
legend.key.size = unit(0.35, 'cm'),
legend.title = element_blank(),
legend.margin=margin(t = -0.5, unit='cm')) +
ggtitle("SCEPTRE null z-scores")
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1)\ndensity" = "purple")) +
xlab("z null") +
ylab("") +
theme(legend.position = c(0.7, 0.67),
legend.key.size = unit(0.35, 'cm'),
legend.title = element_blank(),
legend.margin=margin(t = -0.5, unit='cm')) +
ggtitle("SCEPTRE null z-scores")
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
fig
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null") +
ylab("") +
theme(legend.position = c(0.7, 0.67),
legend.key.size = unit(0.35, 'cm'),
legend.title = element_blank(),
legend.margin=margin(t = -0.5, unit='cm')) +
ggtitle("SCEPTRE null z-scores")
p3 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null") +
ylab("") +
theme(legend.position = c(0.8, 0.8),
legend.key.size = unit(0.35, 'cm'),
legend.title = element_blank(),
legend.margin=margin(t = -0.5, unit='cm')) +
ggtitle("SCEPTRE null z-scores")
p3
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
fig
histogram_df <- data.frame(z_null = uncorrelated_res$resamp_dist$camp_null)
p4 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
scale_color_manual(values = c("N(0,1) density" = "purple")) +
xlab("z null") +
ylab("") +
theme(legend.position = c(0.8, 0.8),
legend.key.size = unit(0.35, 'cm'),
legend.title = element_blank(),
legend.margin=margin(t = -0.5, unit='cm')) +
ggtitle("SCEPTRE null z-scores")
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
figp4
p4
p4 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density, col = "N(0,1) density"),
data = density_df, linewidth = 0.7) +
xlab("z null") +
ylab("") +
ggtitle("SCEPTRE null z-scores")
p4
p4 <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0,
fill = "grey85",
color = "black",
bins = 25) +
my_theme +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density),
data = density_df, linewidth = 0.7, col = "purple") +
xlab("z null") +
ylab("") +
ggtitle("SCEPTRE null z-scores")
p4
fig <- plot_grid(p1, p2, p3, NULL, nrow = 2, rel_heights = c(0.55, 0.45))
fig
p4
fig <- plot_grid(p1, p2, p3, p4, nrow = 2, rel_heights = c(0.55, 0.45))
fig
my_cols
fig <- plot_grid(p1, p2, p3, p4, nrow = 2, rel_heights = c(0.55, 0.45),
labels = "auto")
fig
fig <- plot_grid(p1, p3, p4, p2, nrow = 2, rel_heights = c(0.55, 0.45),
labels = "auto")
fig
fig <- plot_grid(p1, p3, p2, p4, nrow = 2, rel_heights = c(0.55, 0.45),
labels = "auto")
fig
fig <- plot_grid(p1, p2, p3, p4, nrow = 2, rel_heights = c(0.55, 0.45),
labels = "auto")
fig
fig <- plot_grid(p1, p2, p3, p4, nrow = 2, rel_heights = c(0.55, 0.45),
labels = c("a", "c", "b", "d"))
fig
fig <- plot_grid(p1, p2, p3, p4, nrow = 2, rel_heights = c(0.55, 0.45),
labels = "auto", byrow = FALSE)
fig
fig <- plot_grid(p1, p2, p3, p4, nrow = 2, rel_heights = c(0.55, 0.45),
labels = "auto", byrow = TRUE)
fig
fig <- plot_grid(p1, p2, p3, p4, nrow = 2, rel_heights = c(0.55, 0.45),
labels = c("a", "c", "b", "d"), byrow = TRUE)
fig
