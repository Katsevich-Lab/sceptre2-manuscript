mutate(pair = paste0("pair_", i),
ks_fit = paste0("Goodness of fit = ", round(ks_stat, 3)))
histogram_df <- data.frame(z_null = z_null) |>
mutate(pair = paste0("pair_", i),
ks_fit = paste0("Goodness of fit = ", round(ks_stat, 3)))
return(list(density_df = density_df, histogram_df = histogram_df))
})
density_df <- lapply(pannel_a_list, function(l) l$density_df) |>
bind_rows() |>
mutate(ks_fit = factor(ks_fit))
histogram_df <- lapply(pannel_a_list, function(l) l$histogram_df) |>
bind_rows() |>
mutate(ks_fit = factor(ks_fit))
p_a <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black",
fill = "lightgray", bins = 15) +
facet_wrap(ks_fit ~ ., nrow = 2) +
my_theme +
theme(strip.background = element_blank()) +
ylab("Density") +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density),
data = density_df, col = "darkred", linewidth = 0.7) +
ggtitle("Empirical null distribution of MW statistic") +
xlab("Resampled MW statistic")
p_a
p_a <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black",
fill = "lightgray", bins = 15) +
facet_wrap(ks_fit ~ ., nrow = 1) +
my_theme +
theme(strip.background = element_blank()) +
ylab("Density") +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density),
data = density_df, col = "darkred", linewidth = 0.7) +
ggtitle("Empirical null distribution of MW statistic") +
xlab("Resampled MW statistic")
p_a
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
B <- 2500
pannel_a_list <- lapply(X = seq(1, nrow(pairs)), FUN = function(i) {
response_id <- pairs$response_id[i]
undercover_grna <- pairs$undercover_grna[i]
args_to_pass <- lowmoi::get_sceptre_function_args_for_pair(response_id = response_id,
undercover_grna = undercover_grna,
dataset_name = "frangieh/co_culture/gene",
output_amount = 2, B = B)
response_odm <- args_to_pass$mm_odm |> ondisc::get_modality("response")
grna_odm <- args_to_pass$mm_odm |> ondisc::get_modality("grna")
res <- lowmoi::mann_whitney_perm(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = args_to_pass$response_grna_group_pairs,
B = B,
progress = TRUE,
full_output = TRUE)
z_null <- res |> select(matches("z_[0-9]+")) |> as.numeric()
ks_stat <- resampling_res |>
filter(response_id == !!response_id, undercover_grna == !!undercover_grna) |>
pull(ks_stat)
interval <- c(-3.75, 3.75)
z_grid <- seq(interval[1], interval[2], length.out = 1000)
density_df <- data.frame(z_grid = z_grid,
density = stats::dnorm(z_grid)) |>
mutate(pair = paste0("pair_", i),
ks_fit = paste0("Goodness of fit = ", round(ks_stat, 3)))
histogram_df <- data.frame(z_null = z_null) |>
mutate(pair = paste0("pair_", i),
ks_fit = paste0("Goodness of fit = ", round(ks_stat, 3)))
return(list(density_df = density_df, histogram_df = histogram_df))
})
density_df <- lapply(pannel_a_list, function(l) l$density_df) |>
bind_rows() |>
mutate(ks_fit = factor(ks_fit))
histogram_df <- lapply(pannel_a_list, function(l) l$histogram_df) |>
bind_rows() |>
mutate(ks_fit = factor(ks_fit))
p_a <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black",
fill = "lightgray", bins = 25) +
facet_wrap(ks_fit ~ ., nrow = 1) +
my_theme +
theme(strip.background = element_blank()) +
ylab("Density") +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density),
data = density_df, col = "darkred", linewidth = 0.7) +
ggtitle("Empirical null distribution of MW statistic") +
xlab("Resampled MW statistic")
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
p_a <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black",
fill = "lightgray", bins = 20) +
facet_wrap(ks_fit ~ ., nrow = 1) +
my_theme +
theme(strip.background = element_blank()) +
ylab("Density") +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density),
data = density_df, col = "darkred", linewidth = 0.7) +
ggtitle("Empirical null distribution of MW statistic") +
xlab("Resampled MW statistic")
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
lab <- paste0("Pair ", i, , " (KS stat = ", ks_stat, ")")
i <- 1
lab <- paste0("Pair ", i, , " (KS stat = ", ks_stat, ")")
lab <- paste0("Pair ", i, " (KS stat = ", ks_stat, ")")
lab
lab <- paste0("Pair ", i, " (KS stat = ", round(ks_stat, 3), ")")
lab
lab <- paste0("Pair ", i, " (KS stat = ", round(ks_stat, 3), ")")
pannel_a_list <- lapply(X = seq(1, nrow(pairs)), FUN = function(i) {
response_id <- pairs$response_id[i]
undercover_grna <- pairs$undercover_grna[i]
args_to_pass <- lowmoi::get_sceptre_function_args_for_pair(response_id = response_id,
undercover_grna = undercover_grna,
dataset_name = "frangieh/co_culture/gene",
output_amount = 2, B = B)
response_odm <- args_to_pass$mm_odm |> ondisc::get_modality("response")
grna_odm <- args_to_pass$mm_odm |> ondisc::get_modality("grna")
res <- lowmoi::mann_whitney_perm(response_odm = response_odm,
grna_odm = grna_odm,
response_grna_group_pairs = args_to_pass$response_grna_group_pairs,
B = B,
progress = TRUE,
full_output = TRUE)
z_null <- res |> select(matches("z_[0-9]+")) |> as.numeric()
ks_stat <- resampling_res |>
filter(response_id == !!response_id, undercover_grna == !!undercover_grna) |>
pull(ks_stat)
interval <- c(-3.75, 3.75)
z_grid <- seq(interval[1], interval[2], length.out = 1000)
lab <- paste0("Pair ", i, " (KS stat = ", round(ks_stat, 3), ")")
density_df <- data.frame(z_grid = z_grid,
density = stats::dnorm(z_grid)) |>
mutate(pair = paste0("pair_", i), ks_fit = lab)
histogram_df <- data.frame(z_null = z_null) |>
mutate(pair = paste0("pair_", i), ks_fit = lab)
return(list(density_df = density_df, histogram_df = histogram_df))
})
density_df <- lapply(pannel_a_list, function(l) l$density_df) |>
bind_rows() |>
mutate(ks_fit = factor(ks_fit))
histogram_df <- lapply(pannel_a_list, function(l) l$histogram_df) |>
bind_rows() |>
mutate(ks_fit = factor(ks_fit))
p_a <- ggplot() + geom_histogram(aes(x = z_null, y = after_stat(density)),
data = histogram_df,
boundary = 0, color = "black",
fill = "lightgray", bins = 20) +
facet_wrap(ks_fit ~ ., nrow = 1) +
my_theme +
theme(strip.background = element_blank()) +
ylab("Density") +
scale_y_continuous(expand = expansion(mult = c(0.0, .01))) +
geom_line(aes(x = z_grid, y = density),
data = density_df, col = "darkred", linewidth = 0.7) +
ggtitle("Empirical null distribution of MW statistic") +
xlab("Resampled MW statistic")
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "Goodness of fit") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.62),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10)) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
p_b
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "Goodness of fit") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.4, 0.62),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10)) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "Goodness of fit") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.75),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10)) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "Goodness of fit") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10)) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10),
theme(legend.key = element_rect(fill = "black"))) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10),
legend.key = element_rect(fill = "black")) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
p_b
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10),
legend.key = element_blank()) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
p_b
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_text(size=10),
legend.title = element_blank()) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_blank()) +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
p_b
geom_annotate
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_blank()) +
annotate("text", x = 0.35, y = 0.7, "Log(N treatment cells with expression + 1)") +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.35, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_blank()) +
annotate("text", x = 0.35, y = 0.7, label = "Log(N treatment cells with expression + 1)") +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
p_b
############
# CREATE FIG
############
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "vh", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.1, 0.7),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_blank()) +
annotate("text", x = 0.35, y = 0.7, label = "Log(N treatment cells with expression + 1)") +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "h", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
##########
# PANNEL b
##########
p_b <- ggplot(data = resampling_res |> filter(p_rat < 10, p_rat > 1e-3),
mapping = aes(x = ks_stat, y = p_rat, col = log(n_nonzero_treatment + 1))) +
geom_point(alpha = 0.7, size = 0.8) +
scale_y_log10() +
scale_x_log10() +
theme_bw() +
labs(y = expression(paste("Asymptotic ", italic("p"), " / exact ", italic("p"))),
x = "KS statistic") +
geom_hline(yintercept = 1) +
my_theme +
theme(legend.position = c(0.1, 0.72),
legend.key.size = unit(0.4, 'cm'),
legend.title = element_blank()) +
annotate("text", x = 0.35, y = 0.7, label = "Log(N treatment cells with expression + 1)") +
scale_color_continuous(name = "Log(N treatment cells + 1)") +
ggtitle("Inflation of MW p-values")
fig <- cowplot::plot_grid(p_a, p_b,
p_c, p_d,
NULL, NULL, ncol = 2, labels = "auto", align = "h", axis = "l")
to_save_fp <- paste0(.get_config_path("LOCAL_CODE_DIR"),
"sceptre2-manuscript/R_scripts/figure_creation/fig_2/r_output.png")
ggsave(filename = to_save_fp, plot = fig, device = "png",
scale = 1.1, width = 6.5, height = 7, dpi = 330)
